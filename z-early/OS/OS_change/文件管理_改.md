 
# above 

## 【考纲内容】  

（一）文件  

文件的基本概念：文件元数据和索引节点（inode）文件的操作：建立，删除，打开，关闭，读，写 文件的保护：文件的逻辑结构；文件的物理结构  

（二）目录  

目录的基本概念；树形目录；目录的操作；硬链接和软链接  

（三）文件系统  

文件系统的全局结构（layout）：文件系统在外存中的结构，文件系统在内存中的结构外存空闲空间管理办法：虚拟文件系统：文件系统挂载（mounting）  

## 【复习提示】  

- 本章内容概述：
  - 内容较为具体，需要重视对概念的理解。

- 重点掌握的知识点：
  - 文件系统的结构及其实现。
  - 文件分配和空闲空间管理。
  - 文件控制块。
  - 物理分配方法。
  - 索引结构。
  - 树形目录结构。
  - 文件共享原理。
  - 文件系统的布局。
  - 虚拟文件系统原理。

- 易于考查的内容：
  - 这些都是统考真题中容易考查的内容。


# 文件系统基础  

在学习本节时，请读者思考以下问题  

1）什么是文件？  

2）单个文件的逻辑结构和物理结构之间是否存在某些制约关系？  

本节内容较为抽象，要注意区分文件的逻辑结构和物理结构。在学习过程中，可尝试以上面的两个问题为线索，构建整个文件系统的概念。在前面的学习中，曾经提醒过读者不要忽略对基本概念的理解。从历年的情况来看，大部分同学对进程管理、内存管理有较好的掌握，但对于文件管理及后面的1/O管理，往往理解不太深入。在考试中，即使面对一些基本问题也容易失分，这十分可惜。主要原因还是对概念的理解不够全面和透彻，希望读者能够关注这个问题。  

## 基本概念

### 文件的本质
- 文件是以硬盘为载体的存储在计算机上的信息集合
  - 可以是文本文档、图片、程序等
- 系统资源调度与文件的关系
  - 系统运行时：以进程为基本单位进行资源调度和分配
  - 用户输入输出：以文件为基本单位
- 文件系统的需求
  - 大多数应用程序通过文件实现输入输出
  - 用户需要访问、修改和保存文件等管理功能
  - 系统需提供文件管理系统来实现这些需求

### 文件的定义
#### 文件的组成要素
- 存储空间中的数据
- 分类和索引信息
- 访问权限信息

#### 图书馆管理类比
- 书籍内容 ≈ 文件数据
- 分类编号系统 ≈ 文件分类和查找
- 借阅权限 ≈ 文件访问权限

#### 文件系统的用户视角
- 用户关注点
  - 文件命名、分类和查找
  - 文件数据安全性
  - 可进行的操作
- 用户不关注的细节
  - 文件存储方式
  - 辅存区域管理

#### 文件的层次结构
##### 数据项
- 基本数据项：描述对象某属性的最小逻辑单位
- 组合数据项：多个基本数据项的组合

##### 记录
- 相关数据项的集合
- 用于描述对象某方面属性

##### 文件类型
- 有结构文件：由相似记录组成
- 无结构文件：视为字符流

### 文件的属性
- 基本属性列表
  1. 名称：唯一标识
  2. 类型：支持不同文件系统
  3. 创建者ID
  4. 所有者ID
  5. 位置指针
  6. 大小信息
  7. 访问控制信息
  8. 时间相关信息
     - 创建时间
     - 最后修改时间
     - 最后存取时间

> pro：文件属性信息的存储位置（2009）

### 文件的分类
#### 按性质和用途
- 系统文件
- 用户文件
- 库文件

#### 按数据形式
- 源文件
- 目标文件
- 可执行文件

#### 按存取控制属性
- 可执行文件
- 只读文件
- 读/写文件

#### 按组织形式和处理方式
- 普通文件
- 目录文件
- 特殊文件

## 文件控制块和索引节点  

与进程管理一样，为便于文件管理，引入了文件控制块的数据结构。  

### 文件控制块和索引节点

#### 文件控制块
- FCB是存放控制文件需要的各种信息的数据结构，用于实现按名存取
- FCB与文件一一对应，FCB的有序集合称为文件目录
  - 一个FCB就是一个文件目录项
  - 文件目录也被视为一个目录文件
- 创建新文件时，系统建立FCB记录文件属性

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/42e00482cf2da53c34734fbedeb938ce4d87d374115b0af2a6d8e85421ac59c8.jpg)  

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/4c9849ace7df7caf82295ecbc683a1c21d78d5eae7b5a90795e9071a8342ca52.jpg)  

##### FCB主要信息
- 基本信息
  - 文件名
  - 文件的物理位置
  - 文件的逻辑结构
  - 文件的物理结构
- 存取控制信息
  - 文件主的存取权限
  - 核准用户的存取权限
  - 一般用户的存取权限
- 使用信息
  - 文件建立时间
  - 上次修改时间

#### 索引节点

> pro：目录项结构的相关分析与计算（2020、2022）  

##### 索引节点概述
- 文件目录存放在磁盘上，大量文件会占用多个盘块
- UNIX系统采用文件名和描述信息分离方法
  - 描述信息形成索引节点(inode)数据结构
  - 目录项仅包含文件名和索引节点号

> pro：索引1节点号与文件容量的关系（2018、2020）  

##### 索引节点效率分析
- FCB方案
  - FCB大小：64B
  - 盘块大小：1KB
  - 每盘块存放16个FCB
  - 640个FCB需要平均20次磁盘启动
- UNIX目录项方案
  - 目录项大小：16B(14B文件名+2B索引节点号)
  - 每盘块存放64个目录项
  - 磁盘启动次数减少到原来的1/4

##### 索引节点类型
###### 磁盘索引节点
- 每个文件唯一对应一个磁盘索引节点
- 主要内容：
  - 文件主标识符
  - 文件类型
  - 文件存取权限
  - 文件物理地址(13个地址项)
  - 文件长度
  - 文件链接计数
  - 文件存取时间

###### 内存索引节点
- 文件打开时，磁盘索引节点复制到内存
- 额外内容：
  - 索引节点号
  - 状态(上锁/修改标记)
  - 访问计数
  - 逻辑设备号
  - 链接指针

- FCB或索引节点类比：相当于图书馆中图书的索书号

## 文件的操作  

### 文件的基本操作

#### 基本操作类型
- 文件属于抽象数据类型
- 需要考虑可以对文件执行的操作
- 操作系统提供系统调用实现以下操作：
  - 创建
  - 删除  
  - 读
  - 写
  - 打开
  - 关闭

##### 创建文件
- 两个必要步骤：
  - 为新文件分配外存空间
  - 在目录中创建目录项
    - 记录新文件名
    - 记录文件在外存中的地址等信息

> pro：文件删除的过程（2013、2021)  

##### 删除文件
- 删除步骤：
  - 根据文件名查找目录
  - 删除指定文件对应的目录项和文件控制块
  - 回收该文件所占用的存储空间
    - 包括磁盘空间
    - 包括内存缓冲区

##### 读文件
- 读取步骤：
  - 根据文件名查找目录
  - 找到指定文件的目录项
  - 从中得到文件在外存中的地址
  - 使用目录项中的读指针进行读操作

##### 写文件  
- 写入步骤：
  - 根据文件名查找目录
  - 找到指定文件的目录项
  - 利用目录项中的写指针进行写操作
  - 每次写操作后更新写指针

### 文件的打开与关闭

> pro：文件打开的过程（2014）  

#### 打开文件机制
- 目的：避免多次重复检索目录
- 实现方式：
  - 用户首次操作需要使用open系统调用
  - 系统维护打开文件表
  - "打开"过程：
    - 检索指定文件的目录项
    - 将目录项从外存复制到打开文件表
    - 返回文件描述符给用户
  - 后续操作通过文件描述符查找信息

> pro：多进程同时打开文件的分析（2017、2020）  

> pro：文件关闭的过程（2023）  

#### 多进程文件访问结构
- 采用两级表结构：
  - 整个系统表
    - 包含与进程无关的信息
    - 文件在磁盘上的位置
    - 访问日期
    - 文件大小
  - 每个进程表
    - 保存进程对文件的使用信息
    - 当前读写指针
    - 文件访问权限
    - 指向系统表条目的指针

- 文件打开机制：
  - 首次打开：系统表创建条目
  - 其他进程打开：进程表增加条目并指向系统表
  - 使用打开计数器(OpenCount)记录打开进程数
  - 关闭过程：
    - 删除进程表条目
    - 系统表计数器递减
    - 计数为0时删除系统表条目

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/893b6e7893b73c67d7fe74d1969ba469fd1ddf4c1cb25d0b5103ed645b6a95ab.jpg)  
图4.3内存中文件的系统结构  

> pro：文件名和文件描述符的应用场景（2012、2017、2024）  

#### 文件访问标识
- 文件名特点：
  - 不是打开文件表必需部分
  - FCB定位后不再使用
- 文件描述符：
  - UNIX称为文件描述符
  - Windows称为文件句柄
  - 文件未关闭时通过描述符进行操作

> attention:  

#### 文件关联信息
- 文件指针
  - 跟踪上次读写位置
  - 作为当前文件位置指针
  - 对每个进程唯一
  - 与磁盘文件属性分开保存
- 文件打开计数
  - 跟踪文件打开和关闭数量
  - 多进程可能打开同一文件
  - 最后一个进程关闭后删除条目
- 文件磁盘位置
  - 保存在内存中避免重复读取
  - 用于文件数据修改操作
- 访问权限
  - 每个进程打开文件需要访问模式
    - 创建
    - 只读
    - 读写
    - 添加等
  - 保存在进程打开文件表
  - 用于控制I/O请求
## 文件保护  

为了防止文件共享可能会导致文件被破坏或未经核准的用户修改文件，文件系统必须控制用户对文件的存取，即解决对文件的读、写、执行的许可问题。为此，必须在文件系统中建立相应的文件保护机制，可以通过口令保护、加密保护和访问控制等方式实现。其中，口令和加密是为了防止用户文件被他人存取或窃取，而访问控制则用于控制用户对文件的访问方式。  

### 访问类型  
- 主要访问类型：
  - 读：从文件中读
  - 写：向文件中写
  - 执行：将文件装入内存并执行
  - 添加：将新信息添加到文件结尾部分
  - 删除：删除文件，释放空间
  - 列表清单：列出文件名和文件属性

- 其他控制：
  - 文件重命名、复制、编辑等高层功能
  - 通过系统程序调用低层系统调用实现
  - 保护可以只在低层提供
    - 例如：具有读访问权限即可复制和打印

### 访问控制  
#### 基于身份的访问控制
- 访问控制列表(ACL)方法：
  - 优点：可使用复杂的访问方法
  - 缺点：长度无法预计，可能导致复杂的空间管理
  - 解决方案：使用精简的访问列表

> pro：文件访问控制表的结构（2017）  

#### 精简访问控制列表
- 三种用户类型：
  - 拥有者：创建文件的用户
  - 组：共享文件且具有类似访问的用户群
  - 其他：系统内所有其他用户

- 实现机制：
  - 每项占用一个二进制位
  - 使用3×4位矩阵描述访问权限
  - 文件创建时记录所有者和组信息在FCB中
  - 访问权限判定机制：
    - 文件主按所有者权限访问
    - 同组用户按组权限访问
    - 其他用户按其他权限访问

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/78822bd83083d7593e5f6b94b77320fd372e6563c1b1c256745528bdf97e8d4d.jpg)  

#### 其他访问控制方法
##### 口令控制
- 特点：
  - 建立文件时提供口令
  - 系统在FCB中附加口令
  - 访问时需提供相应口令
- 优缺点：
  - 优点：时间和空间开销小
  - 缺点：口令存储在系统内部，安全性不足

##### 密码控制
- 特点：
  - 文件加密保护
  - 访问需要密钥
- 优缺点：
  - 优点：保密性强，节省存储空间
  - 缺点：编码和译码耗时

##### 目录保护
- 保护范围：
  - 单个文件保护
  - 子目录内文件保护
- 特点：
  - 目录操作与文件操作不同
  - 需要不同的保护机制
## 文件的逻辑结构

- 文件的逻辑结构是指从用户角度出发所看到的文件的组织形式
- 文件的物理结构（又称存储结构）是指将文件存储在外存上的存储组织形式，是用户所看不见的
- 文件的逻辑结构与存储介质特性无关，它实际上是指在文件的内部，数据在逻辑上是如何组织起来的

按逻辑结构，文件可划分为无结构文件和有结构文件两大类。

### 无结构文件
- 最简单的文件组织形式
- 由字符流构成，又称流式文件
- 特点：
  - 长度以字节为单位
  - 通过读/写指针访问
  - 应用于源程序、可执行文件、库函数等
- 局限性：
  - 没有结构，只能通过穷举搜索访问记录
  - 对很多应用不适用

### 有结构文件
- 由一个以上的记录构成，又称记录式文件

#### 按记录长度分类
##### 定长记录
- 所有记录长度相同
- 数据项位置和长度固定
- 优点：
  - 检索速度快
  - 方便处理
  - 广泛用于数据处理

##### 变长记录
- 各记录长度不一定相同
- 原因：
  - 数据项数目不同
  - 数据项长度不定
- 缺点：只能顺序查找，速度慢

#### 按记录组织形式分类
##### 顺序文件
- 记录一个接一个顺序排列
- 可包含定长或变长记录
- 排列结构：
  - 串结构：
    - 记录顺序与关键字无关
    - 按存入时间排列
    - 需从头顺序查找
  - 顺序结构：
    - 按关键字顺序排列
    - 定长记录可用折半查找
- 特点：
  - 批量操作效率最高
  - 适合顺序存储设备
  - 单记录操作性能差

##### 索引文件
- 建立索引表提高检索效率
- 结构：
  - 为每个记录设置索引表项
  - 包含记录指针和长度
  - 索引表按关键字排序

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/eb9d674d05888c7f26d7eac9891539314e3a96e19941c26b4ab65a74299eedbb.jpg)  
图4.4索引文件示意图  

- 优缺点：
  - 优点：加快检索速度
  - 缺点：增加存储开销

##### 索引顺序文件
- 结合顺序文件和索引文件特点
- 组织方式：
  - 记录分组存储
  - 建立组首记录索引表
  - 组内记录可无序
  - 组间关键字有序

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/77c339574ccf62a58e641983cd07b2b604a07238b667f6c76d33f50290e230c7.jpg)  
图4.5索引顺序文件示意图  

- 查找效率：
  - 顺序文件：平均需查找N/2次
  - 索引顺序文件：仅需查找√N次
- 特点：
  - 提高查找效率
  - 可采用多级索引
  - 增加存储空间

##### 直接文件或散列文件（HashFile）
- 通过键值或散列函数直接定位记录
- 特点：
  - 存取速度高
  - 可能产生冲突
## 文件的物理结构

- 文件的物理结构研究文件的实现方式
  - 研究文件数据在物理存储设备上的分布和组织
  - 包含两个方面：
    - 文件的分配方式（对磁盘非空闲块的管理）
    - 文件存储空间管理（对磁盘空闲块的管理，详见4.3节）

> pro：不同物理结构的特点和比较（2009、2011、2013、2020）

- 文件分配方法（对应文件的物理结构）：
  - 连续分配
  - 链接分配 
  - 索引分配
  - 注意与文件的逻辑结构区分
- 磁盘存储单元：
  - 分为磁盘块
  - 大小通常与内存页面相同
  - 内存与磁盘数据交换以块为单位

### 连续分配

> pro：连续分配的应用和分析（2011、2012、2014）

- 特点：
  - 要求文件在磁盘上占有连续的块
  - 磁盘地址呈线性排序
  - 减少寻道数和寻道时间

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/b6a39a462bc9f979d41141910def90539790a0b16d15bdd45bfcfd33eabc0ba3.jpg)  
图4.6连续分配

- 实现方式：
  - 记录存储在相邻物理块中
  - 目录项记录：
    - 第一个磁盘块号
    - 占用块数
  - 访问第i块：直接访问块b+i-1
- 优点：
  - 支持顺序访问和直接访问
  - 顺序访问速度快
  - 磁头移动距离最小
- 缺点：
  - 产生外部碎片
  - 需预知文件长度
  - 不支持动态增长
  - 记录操作需物理移动

### 链接分配

- 采用离散分配方式
- 优点：
  - 消除外部碎片
  - 支持动态分配
  - 便于文件操作

#### 隐式链接

> pro：链接分配的应用和分析（2014）

- 组织方式：
  - 目录项包含首尾块指针
  - 磁盘块可分散存储
  - 每块含下一块指针
  - 指针对用户透明

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/6d9292085dcbca8e228af2a372270ec49d72b5570153260a355bffa0f5e93c11.jpg)  
图4.7隐式链接分配

- 缺点：
  - 仅支持顺序访问
  - 稳定性差
  - 指针占用存储空间

> pro：文件空间分配与簇的关系（2017、2018）

- 改进方案：
  - 多个盘块组成簇
  - 按簇分配
  - 减少查找时间
  - 缺点：增加内部碎片

#### 显式链接

- 特点：
  - 链接指针集中存储
  - 使用文件分配表(FAT)
  - 目录仅记录起始块号

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/8477c36d6d340ca093d8331ea371effd24039a9f54ae4c8fc37291be6563af46.jpg)  
图4.8文件分配表

> pro：FAT的作用（2019）

- FAT特点：
  - 表项与磁盘块一一对应
  - 使用特殊数字标记：
    - -1表示文件最后一块
    - -2表示空闲块
  - 可管理空闲空间
- 优点：
  - 支持顺序和直接访问
  - 检索速度快
  - 减少磁盘访问
- 缺点：
  - 占用内存空间
### 索引分配

#### 单级索引分配方式

> pro：索引分配的应用和分析（2012）  

- 基本思想：
  - 打开文件时只需将对应盘块编号调入内存
  - 将每个文件的盘块号集中放在一起
  - 为每个文件分配一个索引块(表)
  - 记录所有分配的盘块号

- 容量计算示例：
  - 盘块大小：4KB
  - 盘块号占用：4B
  - 一个索引块可存放：1024个盘块号
  - 最大文件支持：$1024\times4\mathrm{KB}=4\mathrm{MB}$

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/e89abaa2fe9a3250aaac1146ba1803296a3c594654e57dcb4cc4432213350843.jpg)  
图4.9索引分配  

- 优缺点：
  - 优点：
    - 支持直接访问
    - 不产生外部碎片
  - 缺点：
    - 索引块增加存储开销
    - 小文件利用率低
    - 大文件需要多个索引块

#### 多级索引分配方式

- 基本原理：
  - 为索引块建立主索引
  - 类似多级页表机制
  - 可扩展到三级、四级索引

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/dd6b002ebe09e54ebdc097237203c876304e6533e28b9d9f7c42459b4904fcfd.jpg)  
图4.10二级索引分配  

- 容量计算示例：
  - 盘块大小：4KB
  - 盘块号占用：4B
  - 索引块容量：1024个盘块号
  - 两级索引支持：$1024\times1024\times4\mathrm{KB}=4\mathrm{GB}$

- 优缺点：
  - 优点：加快大型文件查找速度
  - 缺点：访问次数随级数增加而增多

#### 混合索引分配方式

> pro：混合索引1分配的原理（2013）  

- 设计思路：
  - 针对不同大小文件采用不同策略
  - UNIX系统实现：13个地址项(i.addr[0-12]`)

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/423df56c235d223a9617895a37f5ae1ff7d295f35482d63d0bc986ef53bc6876.jpg)  
图4.11UNIX系统的inode结构示意图  

##### 直接地址
- 特点：
  - 使用i.addr[0-9]`共10个直接地址项
  - 适用于小文件(≤40KB)
  - 可直接读取盘块号

##### 一次间接地址
- 特点：
  - 使用i.addr[10]`
  - 适用于中、大型文件
  - 最大支持4MB+40KB文件

> pro：多级索引|块的访问效率分析（2018、2022）  

##### 多次间接地址
- 二次间接地址：
  - 使用i.addr[11]`
  - 最大支持4GB+4MB+40KB文件

- 三次间接地址：
  - 使用i.addr[12]`
  - 最大支持4TB+4GB+4MB+40KB文件
## 本节小结  

本节开头提出的问题的参考答案如下。  

1）什么是文件？  

文件是以计算机硬盘为载体的存储在计算机上的信息集合，它的形式多样。  

2）单个文件的逻辑结构和物理结构之间是否存在某些制约关系？  

文件的逻辑结构是用户可见的结构，即从用户角度看到的文件的全貌。文件的物理结构是文件在存储器上的组织结构。它和文件的存取方法以及存储设备的特性等都有着密切的联系。单个文件的逻辑结构和物理结构之间虽无明显的制约或关联关系，但是如果物理结构选择不慎，也很难体现出逻辑结构的特点，比如一个逻辑结构是顺序结构，而物理结构是隐式链接结构的文件，即使理论上可以很快找出某条记录的地址，而实际仍需在磁盘上一块一块地找。  

学到这里时，读者应能有这样的体会：现代操作系统的思想中，处处能见到面向对象程序设计的影子。本节我们学习的一个新概念一一文件，实质上就是一个抽象数据类型，也就是一种数据结构，若读者在复习操作系统之前已复习完数据结构，则遇到一种新的数据结构时，一定会有这样的意识：要认识它的逻辑结构、物理结构，以及对这种数据结构的操作。  



# 目录  

在学习本节时，请读者思考以下问题：  

1）目录管理的要求是什么？  

2）在目录中查找某个文件可以使用什么方法？  

上节介绍了文件的逻辑结构和物理结构，本节将介绍目录的实现。文件目录也是一种数据结构，用于标识系统中的文件及其物理地址，供检索时使用。通常，一个文件目录也被视为一个文件。在学习本节的内容时，读者可以围绕目录管理的要求来思考。  
## 基本概念

### 文件目录定义与管理要求
- FCB的有序集合称为文件目录，一个FCB就是一个文件目录项
- 目录管理的基本要求：
  - 实现"按名存取"，提供文件名和文件之间的映射
  - 提高目录检索速度，提升系统性能
  - 支持多用户文件共享
  - 允许不同用户使用相同文件名
  - 通过树形结构实现目录管理

### 目录结构

#### 单级目录结构
- 特点：整个文件系统只有一张目录表
- 操作流程：
  - 新建文件：检查重名、增加目录项
  - 访问文件：查找FCB、检查合法性
  - 删除文件：查找目录项、回收空间
- 缺点：
  - 查找速度慢
  - 不允许文件重名
  - 不便于文件共享
  - 不适用于多用户系统

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/a61a9759c73160f0410aadcb978b5291de233ad43c64000066bf629bba768f52.jpg)  

#### 两级目录结构
- 组成：
  - 主文件目录(MFD)：记录用户名和UFD位置
  - 用户文件目录(UFD)：记录用户文件的FCB
- 优点：
  - 提高检索速度
  - 解决多用户文件重名问题
  - 可实现访问限制
- 缺点：
  - 缺乏灵活性
  - 不能对文件分类

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/63a7177d5969ca0b8ca50c1b869d98e7924eee92b08afbfb7b8996fbdc1905c2.jpg)  

#### 树形目录结构
> pro：设置当前工作目录的作用（2010）  

- 文件路径：
  - 绝对路径：从根目录出发的完整路径
  - 相对路径：从当前目录出发的路径
- 当前目录特性：
  - 每个用户有独立当前目录
  - 登录时自动进入用户当前目录
  - 可通过系统调用改变当前目录
- 优点：
  - 便于文件分类
  - 层次结构清晰
  - 有效进行文件管理和保护
- 缺点：
  - 查找文件需逐级访问，增加磁盘访问次数

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/fdd6fe735585e7b6f814f6c2c23dd8171f96c5fec74b938d4f11b5e63d299679.jpg)  

#### 无环图目录结构
- 基于树形结构的扩展：
  - 增加指向同一节点的有向边
  - 允许目录共享子目录或文件
- 共享节点管理：
  - 设置共享计数器
  - 共享链增加时计数器+1
  - 删除请求时计数器-1
  - 计数器为0时才真正删除节点
- 特点：
  - 优点：方便实现文件共享
  - 缺点：系统管理更复杂

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/32f228bab6112191e728f9eea4662365b7102dc88891bcbfb93ea10f5c560aa8.jpg)  
## 目录的操作  

- 理解文件系统需求的基础：
  - 考虑目录层次上所需执行的操作，有助于整体理解文件系统。

- 目录层次的操作：
  - 搜索：找到文件的对应目录项。
  - 创建文件：在目录中增加一个目录项。
  - 删除文件：在目录中删除相应的目录项。
  - 创建目录：在树形目录结构中创建用户文件目录和子目录。
  - 删除目录：
    - 方式1：不删除非空目录，需先删除目录中所有文件和子目录。
    - 方式2：可删除非空目录，文件和子目录同时被删除。
  - 移动目录：在不同父目录之间移动文件或子目录，路径名随之改变。
  - 显示目录：请求显示目录内容，如所有文件及属性。
  - 修改目录：改变保存在目录中的文件属性，需修改相应的目录项。


## * 目录实现

- 文件访问过程：
  - 操作系统使用路径名找到相应目录项。
  - 目录项提供查找文件磁盘块所需的信息。

- 目录实现方法：
  - 基本方法：线性列表和哈希表。
  - 线性列表实现对应线性查找。
  - 哈希表实现对应散列查找。

- 目录查找的目的：
  - 目录的实现是为了高效查找文件。


### 目录实现方法
#### 线性列表
- 实现方式：
  - 采用文件名和数据块指针的线性列表
- 操作过程：
  - 创建文件：
    - 搜索目录确认无同名文件
    - 增加新目录项
  - 删除文件：
    - 根据文件名搜索目录
    - 释放分配空间
- 目录项重用方法：
  - 标记为不再使用
  - 加入空闲目录项列表
  - 将最后目录项复制到空闲位置并减少长度
- 特点：
  - 优点：实现简单
  - 缺点：查找费时

#### 哈希表
- 实现原理：
  - 根据文件名计算哈希值
  - 返回指向线性列表元素的指针
- 特点：
  - 优点：
    - 查找迅速
    - 插入删除简单
  - 缺点：需要避免冲突
- 优化措施：
  - 将当前文件目录复制到内存
  - 减少磁盘I/O操作
  - 提高系统速度

### 文件共享
- 基本概念：
  - 多用户共享同一文件
  - 系统只保留一个副本
- 实现基础：
  - 基于无环图目录结构
  - 复制被共享文件物理地址

#### 基于索引节点的共享方式（硬链接）
> pro：硬链接和软链接文件中引用计数值的分析（2009）

- 实现机制：
  - 文件信息存储在索引节点
  - 目录项只含文件名和索引节点指针
- 链接计数管理：
  - 使用count记录链接数
  - 表示用户目录项数目

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/23c4e4eff9fd9aa7d4de10b736a43f80cb3862d258647ca26e827afb42afe5c1.jpg)

- 操作过程：
  - 创建文件：
    - 设置文件所有者
    - count置为1
  - 共享文件：
    - 增加目录项
    - count加1
  - 删除文件：
    - 减少count
    - count为0时才真正删除

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f09ad53c3f500d76eed8bf8c04e452185e641e4bc13bb00ea697950994fd35db.jpg)

#### 利用符号链实现文件共享（软链接）
- 实现机制：
  - 创建LINK类型新文件
  - 存储被链接文件路径名

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f35b3df4105ca5fd7da8809fed7378ce45b1c7a00fed4b4066c72c32df50a40d.jpg)

> pro：软链接方式册除共享文件后的情况（2021）

- 特点：
  - 访问机制：
    - 只有文件主有索引节点指针
    - 其他用户只有路径名
  - 删除处理：
    - 不会产生悬空指针
    - 访问失败时自动删除符号链接
  - 性能考虑：
    - 需多次读盘
    - 增加访问开销
    - 索引节点占用磁盘空间
- 网络应用：
  - 提供机器网络地址
  - 提供文件路径名

##### 硬链接与软链接对比
- 硬链接：
  - 多指针指向一个索引节点
  - 索引节点存在时指针有效
- 软链接：
  - 保存文件访问路径
  - 根据路径寻找文件
- 性能比较：
  - 硬链接查找速度更快
## 本节小结  

本节开头提出的问题的参考答案如下。  
1）目录管理的要求是什么？  

$\textcircled{\scriptsize{1}}$ 实现“按名存取”，这是目录管理最基本的功能。 $\circledcirc$ 提高对目录的检索速度，从而提高对文件的存取速度。 $\textcircled{3}$ 为了方使用户共享文件，目录还需要提供用于控制访问文件的信息。 $\textcircled{4}$ 允许不同用户对不同文件采用相同的名字，以便用户按自己的习惯给文件命名。  

2）在目录中查找某个文件可以使用什么方法？  

可以采用线性列表法或哈希表法。线性列表将文件名组织成一个线性表，查找时依次与线性表中的每个表项进行比较。若将文件名按序排列，则使用折半查找法可以降低平均的查找时间，但建立新文件时会增加维护线性表的开销。哈希表用文件名通过哈希函数得到一个指向文件的指针，这种方法非常迅速，但要注意避免冲突。  

  

# 文件系统  

在学习本节时，请读者思考以下问题：  

1）什么是文件系统？  

2）文件系统要完成哪些功能？  

本节除了“外存空闲空间管理”，其他都是2022年统考大纲的新增考点，这些内容都是比较抽象的、看不见也摸不着的原理，在常用的国内教材（如汤小丹的教材）中都鲜有涉及。如果觉得不太好理解这些内容，建议读者结合王道的最新课程进行学习。  

## 结构

### 文件系统的设计问题
- 定义文件系统的用户接口
  - 定义文件及其属性
  - 允许的文件操作
  - 文件目录结构组织
- 创建算法和数据结构
  - 映射逻辑文件系统到物理外存设备

### 文件系统层次结构
![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/4a35b9af73e3643a61bd453d60c98bd3da0e090a6b6d012a326ead907267f8bb.jpg)

#### I/O控制层
- 包含组件
  - 设备驱动程序
  - 中断处理程序
- 功能
  - 在内存和磁盘系统间传输信息
  - 将命令翻译为硬件指令
  - 控制I/O设备与系统交互

#### 基本文件系统
- 主要功能
  - 向驱动程序发送通用命令
  - 读写磁盘物理块
- 缓冲区管理
  - 管理内存缓冲区
  - 缓存文件系统、目录和数据块
  - 分配和管理缓冲区

#### 文件组织模块
- 文件块管理
  - 组织文件的逻辑块和物理块
  - 转换逻辑块地址到物理块地址
- 空闲空间管理
  - 跟踪未分配块
  - 按需提供给文件组织模块

#### 逻辑文件系统
- 元数据管理
  - 管理文件系统结构信息
  - 不包含实际文件内容
- 具体功能
  - 管理目录结构
  - 维护文件控制块
  - 负责文件保护

## 布局

### 文件系统在磁盘中的结构
![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/652088c7250050b7fd4efc5dab71dec6566092e5fd8b9a5b7f2f79b0de6030a8.jpg)

#### 主引导记录(MBR)
- 位置：磁盘0号扇区
- 功能
  - 引导计算机
  - 包含分区表
  - 标记活动分区
  - 启动时由BIOS读取执行

#### 引导块
- 特点
  - 每个分区起始位置
  - 负责启动操作系统
  - Windows称为分区引导扇区

#### 超级块
- 包含信息
  - 文件系统关键信息
  - 分区块数量和大小
  - 空闲块信息
  - FCB相关信息

#### 其他组件
- 空闲块信息
  - 位示图或指针链接形式
- i节点组
  - 每个文件对应一个节点
- 根目录
  - 存放文件系统目录树根部
- 其他目录和文件存储区

### 文件系统在内存中的结构

#### 内存数据结构
- 安装表
  - 包含已安装分区信息
- 目录结构缓存
  - 最近访问目录信息
- 系统打开文件表
  - FCB副本
  - 打开计数等信息
- 进程打开文件表
  - 文件描述符
  - 指向系统文件表的指针

## 外存空闲空间管理
![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/2219149a41148f7dda747f0a8d668da014f9802a01e9dd088a752e14a13e37ff.jpg)

### 卷的概念与组织
- 卷的形式
  - 磁盘的一部分
  - 整个磁盘
  - 多个磁盘组成的RAID集
- 卷的结构
  - 文件区与目录区分离
  - 需要初始化
  - 包含目录区和文件区
  - 建立空闲空间管理表格
  - 存放卷信息的超级块

### 存储管理特点
- 以块为单位交换信息
- 管理重点是空闲块
  - 组织
  - 分配
  - 回收

> pro：磁盘空闲空间管理的方法（2019、2024）

### 外存空闲空间管理方法

#### 空闲表法
- 属于连续分配方式，类似内存动态分区分配
- 系统建立空闲表
  - 包含表项序号
  - 空闲区第一个盘块号
  - 空闲区盘块数
- 按起始盘块号递增排列

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/7a85c6c59a536a2981f83f60d296531437af7ada9889aa970af846ea0202ab60.jpg)  

##### 盘块分配
- 采用首次适应或最佳适应算法
- 顺序检索空闲表找到满足需求的空闲区
- 分配后修改空闲表

##### 盘块回收
- 类似内存回收方法
- 考虑与前后空闲区的合并

##### 优点
- 分配速度高
- 减少磁盘I/O频率
- 适合小文件连续分配

#### 空闲链表法

##### 空闲盘块链
- 以盘块为单位组成链表
- 每个盘块指向下一空闲盘块
###### 优点
- 分配回收单个盘块简单
###### 缺点
- 分配多个盘块效率低
- 链表较长

##### 空闲盘区链
- 以盘区为单位组成链表
- 每个盘区包含:
  - 下一盘区指针
  - 本盘区盘块数
###### 优点
- 分配回收效率高
- 链表较短
###### 缺点
- 分配回收过程复杂

#### 位示图法

> pro：位示图的应用及相关计算（2010、2014、2015、2023）  

- 用二进制位表示盘块使用情况
  - 0表示空闲
  - 1表示已分配

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/59068c9a3968e8f67a2856b22b51f92756d1eb6402e47576acf293be7b6fe767.jpg)  

##### 盘块分配
- 扫描位示图找0值位
- 转换为盘块号
- 修改位示图为1

##### 盘块回收
- 将盘块号转换为位示图位置
- 修改位示图为0

> attention:  

如无特别提示，本书所用位示图的行和列都从1开始编号。特别注意，若题中指明从0开始编号，则上述计算方法要进行相应的调整。  

##### 优缺点
###### 优点
- 易找到连续空闲盘块
- 占用空间少
- 可保存在内存中
###### 缺点
- 随磁盘容量增加而增大
- 适用于小型计算机

#### 成组链接法
- 结合空闲表和链表思想
- 空闲盘块分组管理
  - 每组100个盘块
  - 首块记录下组信息
  - 首组信息存于内存栈中

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/8240049bc876fec1a0a439ae8f42ab9e86807c0071b8a6c88f7e9a822229ad22.jpg)  

##### 盘块分配
- 从栈中分配盘块
- 栈空时读入新组信息
- 更新空闲块计数

##### 盘块回收
- 回收块号存入栈顶
- 栈满时建立新组
- 更新空闲块计数

## 虚拟文件系统

### 概述
- 虚拟文件系统（VFS）屏蔽了不同文件系统的差异和操作细节
- 向上为用户提供了文件操作的统一调用接口
  - 用户程序通过VFS提供的统一调用函数操作不同文件系统的文件
  - 无须考虑具体的文件系统和实际的存储介质

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f11f48d5a97ebc8b67d6d6cd3c00f5d0c1501f459b1d8a566b733057e6a7a4fe.jpg)  
图4.24虚拟文件系统的示意图  

### 对象类型
- 采用面向对象思想
- 抽象出通用文件系统模型
- 定义通用文件系统支持的接口
- 系统抽象了四种对象类型
  - 每个对象包含数据和函数指针
  - 函数指针指向操作这些数据的文件系统实现函数

#### 1. 超级块对象
- 表示已安装的特定文件系统
- 对应磁盘上特定扇区的文件系统超级块
- 存储已安装文件系统的元信息
- 主要操作函数：
  - 分配inode
  - 销毁inode
  - 读inode
  - 写inode

#### 2. 索引节点对象
- 表示特定文件
- 特点：
  - 与文件一对一关系
  - 仅在文件被访问时创建
  - 复制磁盘索引节点数据
- 提供操作函数：
  - 创建新索引节点
  - 创建硬链接
  - 创建新目录

#### 3. 目录项对象
- 表示特定目录项
- 组成：
  - 包含指向关联索引节点的指针
  - 包含指向父目录和子目录的指针
- 特点：
  - 磁盘上无对应数据结构
  - 由VFS在遍历路径过程中解析生成

#### 4. 文件对象
- 表示进程相关的已打开文件
- 操作方式：
  - 通过open()打开
  - 通过close()关闭
- 特点：
  - 类似进程和程序的关系
  - 仅代表进程视角的已打开文件
  - 指向其索引节点
- 包含内容：
  - 相关联的目录项对象
  - 文件系统信息
  - 文件指针
  - 操作函数

### 系统调用处理流程
- 进程发起面向文件的系统调用
- 内核调用VFS函数
- VFS函数调用目标文件系统相应函数
- 转换为面向设备的指令

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/d284c15b75a406a133532a466740a742df343db72bbdb92ae9c3537a93023937.jpg)  
图4.25write（系统调用操作示意图  

### VFS特点
- 用户无需关心文件系统实现细节
- 对文件系统细节进行抽象
- 使不同文件系统对进程表现一致
- 存在特点：
  - 仅存在于内存中
  - 不存在于外存空间
  - 系统启动时建立
  - 系统关闭时消亡
## 文件系统挂载

### Windows文件系统挂载
- 维护扩展的两级目录结构
  - 使用驱动器字母表示设备和卷
  - 卷具有常规树结构目录
    - 与驱动器号相关联
    - 含有指向已安装文件系统的指针
- 文件路径形式
  - 格式为driver-letter:path\to\file
  - 访问流程
    - 操作系统找到相应文件系统指针
    - 遍历设备目录结构查找指定文件
- 新版Windows特点
  - 允许文件系统安装在目录树任意位置(类似UNIX)
  - 启动时自动发现和安装所有设备文件系统

### UNIX文件系统挂载
- 根文件系统
  - 系统启动时直接安装
  - 是内核映像所在文件系统
- 其他文件系统
  - 必须先挂载到根文件系统目录才能访问
  - 挂载方式
    - 系统初始化时自动安装
    - 用户手动挂载到已安装文件系统目录
- 安装点特点
  - 同一设备可有多个安装点
  - 同一安装点同时只能挂载一个设备
  - 通过安装点目录可读取设备数据

#### 挂载示例
- 将ext2文件系统挂载到/flp:
  - 命令: mount -t ext2/dev/fd0/flp
- 卸载文件系统:
  - 使用umount命令

### 本章主线
- 第一条主线：文件抽象数据类型
  - 逻辑结构
  - 物理结构
- 第二条主线：操作系统文件管理
  - 多文件逻辑结构组织(目录)
  - 用户文件服务请求处理(磁盘管理)
- 学习建议
  - 宏观把握知识为微观掌控服务
  - 通过反复做题思考加深理解
## 本节小结  

本节开头提出的问题的参考答案如下。  

1）什么是文件系统？  

操作系统中负责管理和存储文件信息的软件机构称为文件管理系统，简称文件系统。文件系统由三部分组成：与文件管理有关的软件、被管理文件及实施文件管理所需的数据结构。  

2）文件系统要完成哪些功能？  

对于用户而言，文件系统最主要的功能是实现对文件的基本操作，让用户可以按名存储和查找文件，组织成合适的结构，并应当具有基本的文件共享和文件保护功能。对于操作系统本身而言，文件系统还需要管理与磁盘的信息交换，完成文件逻辑结构和物理结构上的变换，组织文件在磁盘上的存放，采取好的文件排放顺序和磁盘调度方法以提升整个系统的性能。  


# 本章疑难点  

### 文件的物理分配方式的比较  

文件的三种物理分配方式的比较如表4.3所示。  

表4.3文件三种分配方式的比较
![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/25a02748a7aa73d186c2f7f8d38f6f9764d00d52316ca87a38244c89706bbcba.jpg)  

### 文件打开的过程描述  

$\textcircled{\scriptsize{1}}$ 检索目录，要求打开的文件应该是已经创建的文件，它应登记在文件目录中，否则会出错。在检索到指定文件后，就将其磁盘iNode复制到活动iNode表中。  

$\circledcirc$ 将参数mode所给出的打开方式与活动iNode中在创建文件时所记录的文件访问权限相比较，如果合法，则此次打开操作成功。  

$\circledast$ 当打开合法时，为文件分配用户打开文件表表项和系统打开文件表表项，并为后者设置初值，通过指针建立表项与活动iNode之间的联系，再将文件描述符fd返回给调用者。