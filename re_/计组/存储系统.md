# above  

## 【考纲内容】  

（一）存储器的分类  

（二）层次化存储器的基本结构  

（三）半导体随机存储器（RAM）SRAM、DRAM、Flash存储器  

（四）主存储器DRAM芯片和内存条、多模块存储器、主存储器和CPU之间的连接  

（五）外部存储器磁盘存储器、固态硬盘（SSD）  

（六）高速缓冲存储器（Cache）Cache的基本原理：Cache和主存之间的映射方式Cache中主存块的替换算法：Cache写策略  

（七）虚拟存储器  

虚拟存储器的基本概念页式虚拟存储器：基本原理、页表、地址转换、TLB（快表）段式虚拟存储器的基本原理：段页式虚拟存储器的基本原理  

## 【复习提示】  

- 本章命题重点：
  - 特别关注Cache和虚拟存储器相关内容，这些考点容易出综合题。
  - 存储器的特点、扩展（芯片选择、连接方式、地址范围等）、交叉存储器也常考。
  - Cache的相关计算与替换算法是重要考点。
  - 虚拟存储器与TLB（Translation Lookaside Buffer）也是考试重点。


- 地址翻译与Cache映射问题：
  - 掌握存在Cache和TLB的计算机中的地址翻译机制。
  - 理解Cache映射问题。

- 学习建议：
  - 掌握基本原理，并多结合习题进行反复训练。
  - 深化理解并巩固知识。


  <details>
  <summary>学习本章时的思考问题：</summary>


  1. 存储器系统分层次的原因：
     - 为什么存储器系统需要分层次？
     - 计算机如何管理这些层次？

  2. 影响Cache性能的因素：
     - 有哪些因素会影响Cache的性能？

  3. 虚拟存储系统页面大小的选择：
     - 虚拟存储系统的页面是设置得大一些好还是小一些好？
</details>


# 存储器概述  

## 存储器的分类  

存储器种类繁多，可从不同角度对存储器进行分类。  

### 按在计算机中的作用（层次）分类  
- 主存储器
  - 简称主存，也称内存储器（内存）
  - 用途：存放计算机运行期间所需的程序和数据
  - 特点：
    - CPU可以直接随机访问
    - 可与Cache及辅助存储器交换数据
    - 容量较小
    - 存取速度较快
    - 每位价格较高

- 辅助存储器
  - 简称辅存，也称外存储器或外存
  - 用途：存放当前暂时不用的程序和数据，以及需要永久性保存的信息
  - 特点：
    - 需要调入主存后才能被CPU访问
    - 容量大
    - 存取速度较慢
    - 单位成本低

- 高速缓冲存储器
  - 简称Cache
  - 位置：位于主存和CPU之间
  - 用途：存放当前CPU经常使用的指令和数据
  - 特点：
    - 存取速度可与CPU速度匹配
    - 存储容量小
    - 价格高
    - 现代计算机通常将其制作在CPU中

### 按存储介质分类  
- 磁表面存储器
  - 磁盘
  - 磁带
- 磁芯存储器
- 半导体存储器
  - MOS型存储器
  - 双极型存储器
- 光存储器
  - 光盘

### 按存取方式分类  

> pro：采用随机存取的存储器（2011）  

- 随机存储器（RAM)
  - 特点：
    - 任何存储单元都可以随机存取
    - 存取时间与存储单元物理位置无关
  - 优点：读/写方便、使用灵活
  - 用途：主要用作主存或高速缓冲存储器
  - 分类：
    - 静态RAM
    - 动态RAM

- 只读存储器（ROM）
  - 特点：
    - 内容只能随机读出不能写入
    - 断电内容不会丢失
    - 写入速度比读取速度慢得多
  - 用途：存放固定不变的程序、常数和汉字字库等
  - 功能：可与随机存储器共同作为主存的一部分

- 串行访问存储器
  - 特点：需按物理位置先后顺序寻址
  - 类型：
    - 顺序存取存储器（如磁带）
      - 特点：存取速度慢，按顺序存取
    - 直接存取存储器（如磁盘、光盘）
      - 特点：介于RAM和顺序存取之间
      - 存取方式：先寻找小区域，再在区域内顺序查找

### 按信息的可保存性分类  
- 易失性存储器
  - 特点：断电后信息消失
  - 示例：RAM

- 非易失性存储器
  - 特点：断电后信息保持
  - 类型：
    - ROM
    - 磁表面存储器
    - 光存储器

#### 按读出方式分类
- 破坏性读出
  - 特点：读出时原存储信息被破坏
  - 要求：每次读出后需要进行再生操作

- 非破坏性读出
  - 特点：读出时原存储信息不被破坏
## 存储器的性能指标  

### 三个主要性能指标
- 存储容量
- 单位成本  
- 存储速度

#### 具体说明
- 存储容量
  - 计算公式：存储容量 = 存储字数 × 字长（如1M×8位）
  - 单位换算：1B（Byte，字节）= 8b (bit，位)
  - 说明：
    - 存储字数表示存储器的地址空间大小
    - 字长表示一次存取操作的数据量

- 单位成本
  - 计算公式：每位价格 = 总成本/总容量

- 存储速度
  - 计算公式：数据传输速率 = 数据的宽度/存取周期
  - 重要参数：
    - 存取时间（Ta）
      - 定义：从启动一次存储器操作到完成该操作所经历的时间
      - 分类：读出时间和写入时间
    - 存取周期（Tm）
      - 定义：存储器进行一次完整的读/写操作所需的全部时间
      - 特点：连续两次独立访问存储器操作之间所需的最小时间间隔
    - 主存带宽（Bm）
      - 别称：数据传输速率
      - 含义：每秒从主存进出信息的最大数量
      - 单位：字/秒、字节/秒（B/s）或位/秒（b/s)

#### 存取时间与存取周期的关系
- 基本关系：存取周期大于存取时间
- 原因：
  - 读/写操作后需要恢复内部状态
  - 对于破坏性读出的存储器，可达Tm = 2Ta
- 示意图：

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/21f64fafd194c1ba1c6165c7728968a6e8ae536402c6539569c4d4e7c1719c0f.jpg)  
图3.1存取时间与存取周期的关系  

## 多级层次的存储系统  

### 系统特点
- 层次结构特征：
  - 由上至下：
    - 位价越来越低
    - 速度越来越慢
    - 容量越来越大
    - CPU访问频度越来越低
- 主要层次：
  - Cache-主存层
  - 主存-辅存层

### 系统结构
- 信息交换方式：
  - Cache、主存能与CPU直接交换信息
  - 辅存需通过主存与CPU交换信息
  - 主存与CPU、Cache、辅存都能交换信息
- 结构示意图：

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/ecbfb7431920fae95ef8cac047bea026b1dcf473fe23120161d91a5948c10f1a.jpg)  
图3.2多级存储器结构  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/3695ac60caa0ef8aa0adc0813638b48ef2f1586374984cdd5278a8b6809a560d.jpg)  
图3.3三级存储系统的层次结构及其构成  

### 工作原理
- CPU数据存取过程：
  - 先访问Cache
  - 若不在Cache中，则访问主存
  - 若不在主存中，则访问磁盘
  - 数据读取路径：磁盘→主存→Cache

### 系统优势
- Cache-主存层：
  - 速度接近Cache
  - 容量和位价接近主存
- 主存-辅存层：
  - 速度接近主存
  - 容量和位价接近辅存

### 层次功能
- Cache-主存层：
  - 主要功能：解决CPU和主存速度不匹配问题
  - 数据调动：由硬件自动完成
  - 特点：对所有程序员透明
- 主存-辅存层：
  - 主要功能：解决存储系统容量问题
  - 数据调动：由硬件和操作系统共同完成
  - 特点：对应用程序员透明

### 发展趋势
- 虚拟存储系统的形成：
  - 特点：程序员编程地址范围与虚拟存储器地址空间对应
  - 优势：可用地址空间远大于主存空间

> attention：  

- 在Cache一主存层和主存一辅存层中，上一层中的内容都只是下一层中的内容的副本
  - 也即Cache（或主存）中的内容只是主存（或辅存）中的内容的一部分。



# 主存储器  

## SRAM DRAM  

半导体存储器分为随机存储器（RAM）和只读存储器（ROM）。RAM又分为静态随机存储器（SRAM）和动态随机存储器（DRAM），主存储器主要由DRAM实现，靠近处理器的那一层（Cache）则由SRAM实现，它们都是易失性存储器。ROM是非易失性存储器。  

### SRAM的工作原理  
- 基本概念
  - 存储元：存放一个二进制位的物理器件，是存储器的最基本构件
  - 存储单元：地址码相同的多个存储元构成
  - 存储体：若干存储单元的集合

- 工作特点
  - 使用双稳态触发器（六晶体管MOS）记忆信息
  - 静态特性：信息读出后保持原状态，无需再生（非破坏性读出）
  - 性能特征：
    - 存取速度快
    - 集成度低
    - 功耗较大
    - 价格昂贵
  - 主要用途：高速缓冲存储器

### DRAM的工作原理  
#### 基本特性
- 存储原理：利用存储元电路中栅极电容上的电荷存储信息
- 基本结构：通常只使用一个晶体管
- 与SRAM对比优势：
  - 密度更高
  - 集成度高
  - 位价低
  - 功耗低
- 主要缺点：
  - 存取速度较慢
  - 需要定时刷新和读后再生
- 主要用途：大容量主存系统

> pro：需要刷新的存储芯片：SDRAM（2015）  

#### 工作特点
- 电荷维持时间：$1\sim2\mathrm{ms}$
- 读操作特性：破坏性读出，需读后再生
- 刷新周期：相邻两次刷新的时间间隔，通常为$2\mathrm{ms}$

#### 刷新方式
##### 集中刷新
- 特点：
  - 在固定时间内逐一对所有行再生
  - 刷新期间停止读/写操作（死时间/访存死区）
- 优点：读/写操作不受刷新影响
- 缺点：刷新期间不能访问存储器

##### 分散刷新
- 工作方式：后半部分用于刷新
- 影响：增加系统存取周期（如$0.5\mu\mathrm{s}$到$1\mu\mathrm{s}$）
- 优点：没有死区
- 缺点：加长系统存取周期

##### 异步刷新
- 原理：结合集中和分散刷新方法
- 实现方式：
  - 将刷新周期除以行数
  - 按间隔时间产生刷新请求
- 优势：死时间分布更分散，减少CPU等待时间

#### 刷新注意事项
- 刷新对CPU透明，不依赖外部访问
- 以行为单位，由芯片内部生成行地址
- 刷新操作类似读操作但有区别
- 刷新时无需选片，所有芯片同时刷新

> attention：  

- 虽然DRAM的刷新和再生都是恢复数据，但刷新与再生的过程并不完全相同。
  - 刷新是以行为单位，逐行恢复数据的，而再生仅需恢复被读出的那些单元的数据。  

> pro：DRAM芯片行缓冲器容量的计算（2022）  

#### SDRAM特性
- 工作方式：与CPU同步交换数据
- 与传统DRAM区别：
  - 传统DRAM：
    - 采用异步方式
    - CPU需等待读/写完成
  - SDRAM：
    - 采用同步方式
    - 锁存地址和控制信号
    - CPU可同时进行其他操作
- 操作特点：
  - 在系统时钟控制下进行
  - 支持突发传输
  - 首次给出首地址
  - 整行数据送入行缓冲器
  - 每个时钟连续输出数据
- 行缓冲器：
  - 功能：缓存指定行中整行数据
  - 大小：列数×位平面数
  - 实现方式：通常用SRAM
### DRAM芯片的读/写周期  
#### 读/写周期时序图
- 为了使芯片能正确接收行、列地址并实现读写操作，各信号的时间关系应符合一定要求
- 读（写）周期时间 $t_{\mathrm{{RC}}}$  $t_{\mathrm{{wc}}}$ ）表示DRAM芯片进行两次连续读（写）操作时所必须间隔的时间
- 读周期特点：
  - 在RAS有效前将行地址送到芯片的地址引I脚
  - CAS滞后RAS一段时间
  - 在CAS有效前再将列地址送到芯片的地址引脚
  - RAS、CAS应分别至少保持 $t_{\mathrm{RAS}}$ 和 $t_{\mathrm{CAS}}$ 的时间
  - 在读周期中WE为高电平，并在CAS有效前建立

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/ac49c5139324c976bef95c5760eecc986130d9c6997bdc4b888ceda236371d26.jpg)  
图3.4DRAM芯片读/写周期时序图  

- 写周期特点：
  - 行列选通信号的时序关系和读周期相同
  - WE为低电平，同样在CAS有效前建立
  - 为了保证数据可靠地写入，写数据必须在CAS有效前在数据总线上保持稳定

### SRAM DRAM  
- 表3.1详细列出了SRAM和DRAM各自的特点

表3.1SRAM DRAM
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/247e4075afae5a6921141e41eb4721eb9e64db737333bbae6ebd4d1ecd2c7aab.jpg)  

### 存储器芯片的内部结构  
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/2516f94b368ccd12877ec553c7401ec98c5b18224a062f7a42b548d1c7b596b4.jpg)  
图3.5存储器芯片结构图  

#### 存储体（存储矩阵）
- 存储体是存储单元的集合
- 由行选择线（X）和列选择线（Y）来选择所访问单元
- 存储体的相同行、列上的多位（位平面数）同时被读出或写入

#### 地址译码器
- 用途：将地址转换为译码输出线上的高电乎，以便驱动相应的读/写电路
- 译码方式：
  ##### 单译码法（一维译码）
  - 只有一个行译码器
  - 同一行中所有存储单元的字线连在一起
  - 同一行中的各单元构成一个字，被同时读出或写入
  - 缺点：地址译码器的输出线数过多
  
  ##### 双译码法（二维译码）
  - 地址译码器分为X和Y方向两个译码器
  - 在选中的行和列交叉点上能确定一个存储单元
  - 是DRAM芯片目前普遍采用的译码结构

#### I/O控制电路
- 用以控制被选中的单元的读出或写入
- 具有放大信息的作用

#### 片选控制信号
- 单个芯片容量太小，往往满足不了计算机对存储器容量的要求
- 需用一定数量的芯片进行存储器的扩展
- 在访问某个字时，必须"选中"该存储字所在的芯片，而其他芯片不被"选中"
- 因此需要有片选控制信号

#### 读/写控制信号
- 根据CPU给出的读命令或写命令，控制被选中单元进行读或写
## 只读存储器  

### 只读存储器（ROM）的特点  

> pro：RAM和ROM的区别（2010）  

ROM和RAM都是支持随机访问的存储器，其中SRAM和DRAM均为易失性半导体存储器。而ROM中一旦有了信息，就不能轻易改变，即使掉电也不会丢失。ROM具有两个显著的优点：
- 结构简单，所以位密度比可读/写存储器的高
- 具有非易失性，所以可靠性高

### ROM的类型  

#### 掩模式只读存储器  
- MROM的内容由半导体制造厂按用户提出的要求在芯片的生产过程中直接写入，写入以后任何人都无法改变其内容
- 优点：
  - 可靠性高
  - 集成度高
  - 价格便宜
- 缺点：
  - 灵活性差

#### 一次可编程只读存储器  
- PROM是可以实现一次性编程的只读存储器
- 允许用户利用专门的设备（编程器）写入自己的程序，一旦写入，内容就无法改变

#### 可擦除可编程只读存储器  
- EPROM不仅可以由用户利用编程器写入信息，而且可以对其内容进行多次改写
- 局限性：
  - 编程次数有限
  - 写入时间过长
  - 不能取代RAM

#### Flash存储器  

> pro：Flash存储器的特点（2012）  

- 在EPROM基础上发展
- 特点：
  - 兼有ROM和RAM的优点
  - 可在不加电情况下长期保存信息
  - 能在线进行快速擦除与重写
  - 价格便宜
  - 集成度高
  - 擦除重写速度快

#### 固态硬盘（Solid State Drive，SSD）
- 基本组成：
  - 控制单元
  - 存储单元（Flash芯片）
- 特点：
  - 保留Flash存储器优点
  - 读/写速度快
  - 低功耗
- 缺点：
  - 价格较高

### 主存储器的基本组成  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/32d7adac4f2bd43918e63a15cb75067abfdb78b3072fd13466d39b41b1a285a2.jpg)  
图3.6主存储器的基本组成框图  

#### 存储矩阵结构
- 由存储元件（记忆单元）构成
  - 存储元件是具有两种稳态的能表示二进制0和1的物理器件
- 编址方式：
  - 可按字节编址
  - 可按字编址
  - 现代计算机通常采用字节编址

#### 存储器访问过程
- CPU操作步骤：
  - 将被访问单元地址送到MAR
  - 通过地址线将主存地址送到主存地址寄存器
  - 发送读/写信号到控制电路
- 写操作流程：
  - CPU将数据送到MIDR
  - 通过数据线写入选中单元
- 读操作流程：
  - 主存读出选中单元内容
  - 通过数据线送到MDR

#### 硬件特性
- MDR位数与数据线位数相同
- MAR位数与地址线位数相同
- 地址空间范围：0~2^地址线位数-1

> attention：  

- 数据线的位数通常等于存储字长
  - 因此MIDR的位数通常等于存储字长
- 若数据线的位数不等于存储字长
  - 则MIDR的位数由数据线的位数决定  

##### DRAM芯片特性
###### 地址引脚复用技术
- 背景：
  - DRAM芯片容量较大，地址位数较多
- 目的：
  - 减少芯片的地址引脚数
- 实现方式：
  - 行地址和列地址通过相同的引脚分先后两次输入
- 效果：
  - 地址引脚数可减少一半

> pro：DRAM芯片行、列数的优化原则（2018）  

###### 行列数优化原则
- 基本参数：
  - 存储容量：$2^{n}{\times}b$ 位
  - 行数：r
  - 列数：c
  - 关系：$2^{n}=r\times\!c$
- 地址位数：
  - 总地址位数：n
  - 行地址位数：$\log_{2}r$
  - 列地址位数：$\log_{2}c$
  - 关系：$n=\log_{2}r+\log_{2}c$
- 优化要求：
  - 减少地址引脚数：$|r–c|$ 最小
  - 减少刷新开销：$r\leqslant c$

#### 多模块存储器
- 定义：一种空间并行技术
- 目的：提高存储器的吞吐率
- 实现方式：利用多个结构完全相同的存储模块并行工作
- 常见类型：
  - 单体多字存储器
  - 多体低位交叉存储器
> attention：  

- CPU的速度比存储器快得多
- 若同时从存储器中取出 $n$ 条指令
  - 就可以充分利用CPU资源，提高运行速度

多体交叉存储器就是基于这种思想提出的。  


### 单体多字存储器
- 基本特点：
  - 每个存储单元存储m个字
  - 总线宽度为m个字
  - 一次并行读出m个字
- 工作过程：
  - 一个存取周期内从同一地址取出m条指令
  - 将指令逐条送至CPU执行
  - 每隔1/m存取周期，CPU向主存取一条指令
- 缺点：
  - 仅在指令和数据连续存放时有效
  - 遇到转移指令或操作数不连续时效果不明显

### 多体并行存储器
- 基本组成：
  - 由多个相同容量和存取速度的模块组成
  - 每个模块具有独立的：
    - 读/写控制电路
    - 地址寄存器
    - 数据寄存器
  - 可并行工作也可交叉工作

#### 编址方式分类
##### 高位交叉编址（顺序方式）
- 地址划分：
  - 高位表示模块号（体号）
  - 低位表示模块内地址（体内地址）

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/75d2ac2a627c5bcdace95fe592ef3010583976cec7fbd37807fc2eed52d25b78.jpg)  
图3.7高位交叉编址的多体存储器  

- 工作特点：
  - 低位体内地址送到高位体号确定的模块内译码
  - 连续访问时在一个模块内完成
  - 各模块不能并行访问
  - 不能提高存储器吞吐率

> attention：  

模块内的地址是连续的，存取方式仍是串行存取，因此这种存储器仍是顺序存储器。  

##### 低位交叉编址（交叉方式）

> pro：交叉存储器中数据的存放方式（2017）  

- 地址划分：
  - 低位为模块号
  - 高位为模块内地址
- 编址规则：
  - 每个模块按"模m"交叉编址
  - 模块号 = 单元地址 % m

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/b4f48c1df4011710c3242e64f98016fdf9a431c95108f08cf1745946d0aec796.jpg)  
图3.8低位交叉编址的多体存储器  

- 工作特点：
  - 高位体内地址送到低位体号确定的模块内译码
  - 程序连续存放在相邻模块中

##### 启动方式
###### 轮流启动方式
- 条件要求：
  - 每个模块读/写位数等于数据总线位数
  - 模块数m ≥ T/r（T为存取周期，r为总线周期）

> pro：交叉存储器存取时间和带宽的计算（2012、2013）  

- 工作特点：
  - 每隔1/m个存取周期轮流启动各模块
  - 存取速度提高m倍
  - 连续存取m个字时间：t₁ = T + (m-1)r
  - 顺序方式时间：t₂ = mT

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/357a8d6b3c8858f8e0445d4f33ec790e4dc9c97914e01f04c3acc061319ce47a.jpg)  
图3.9低位交叉轮流启动的存取时间示意图  

> pro：交叉存储器中访存冲突的分析（2015）  

- 访存冲突：
  - 发生条件：相邻m次访问的地址在同一模块
  - 处理方法：延迟发生冲突的访问请求

###### 同时启动方式
- 条件要求：
  - 所有模块并行读/写的总位数等于数据总线位数
- 工作示例：
  - 每模块读/写16位
  - 模块数m=4
  - 数据总线64位
  - 4个模块同时启动并行读/写
 

# 主存储器与CPU的连接  

## 连接原理  

- 主存储器与CPU的连接方式：
  - 通过三种总线连接：
    - 数据总线
    - 地址总线 
    - 控制总线
  - 总线特点：
    - 数据总线：位数与工作频率的乘积决定数据传输速率
    - 地址总线：位数决定最大可寻址内存空间
    - 控制总线：指示总线周期类型和I/O操作完成时刻

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/1e1d92cf5473f7cdbefec0c268399f79d298a75bd67083e238876b319130a603.jpg)  
图3.10主存储器与CPU的连接  

- 存储器扩展需求：
  - 单个芯片容量有限
  - 通过扩展技术集成多个芯片
  - 多个内存条和ROM芯片组成主存空间
  - 通过总线与CPU相连

## 主存容量的扩展  

- 扩展需求：
  - 单个存储芯片容量有限
  - 需要在字和位两方面进行扩充
  - 目的是满足实际存储器容量要求

### 位扩展法  

- 概念：对字长进行扩展
- 应用场景：CPU数据线数多于存储芯片数据位数
- 连接方式：
  - 各芯片的地址线、片选线和读/写控制线与系统总线并联
  - 各芯片数据线单独引出连接系统数据线
  - 各芯片同时工作
- 实例：用8片8K×1位RAM组成8K×8位存储器

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f2b1e66bdcaafe6c0055bf34f9b6020f9ac3160dbd2ded9961f636deabd2b444.jpg)  
图3.11位扩展连接示意图  

### 字~

- 概念：对存储字数量进行扩展
- 特点：存储字位数满足系统要求
- 连接方式：
  - 芯片地址线与系统地址低位相连
  - 数据线和读/写控制线与系统总线并联
  - 系统地址高位译码得到片选信号
  - 各芯片分时工作

> pro：字扩展（或字位扩展）后存储芯片的地址范围（2010、2016）  

- 实例：用4片16K×8位RAM组成64K×8位存储器
- 地址分配：
  - 第一片：0000000000000000-0011111111111111
  - 第二片：0100000000000000-0111111111111111
  - 第三片：1000000000000000-1011111111111111
  - 第四片：1100000000000000-1111111111111111

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/44f1fe99a9391d96d9aeb0fb8712474bf298dbedaaa36321308e7bb49a6874d2.jpg)  
图3.12字扩展连接示意图  

### 字位同时~

- 概念：位扩展和字扩展的组合
- 功能：
  - 增加存储字数量
  - 增加存储字长
- 连接方式：
  - 位扩展芯片作为一组
  - 各组连接方式同位扩展
  - 系统地址高位译码产生片选信号
- 实例：用8片16K×4位RAM组成64K×8位存储器
  - 组织方式：
    - 每两片构成16K×8位存储器（位扩展）
    - 4组构成64K×8位存储器（字扩展）

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/1bd0ffee871eff245d8c4e998e914cbf1ee53c30a0465b58592027c9ed8d0501.jpg)  
图3.13字位同时扩展及CPU的连接图  
## 存储芯片的地址分配和片选  

### 基本概念
- CPU访问存储单元需要两个步骤：
  - 片选：选择存储芯片
  - 字选：在选定芯片中选择具体存储单元
- 字选过程：
  - 由CPU送出N条低位地址线完成
  - N由片内存储容量2^N决定
- 片选信号产生方法：
  - 线选法
  - 译码片选法

### 线选法  

#### 工作原理
- 高位地址线直接连接至存储芯片片选端
- 地址线为"0"时选中对应存储芯片
- 每次只能有一位有效

#### 实例说明
- 4片2K×8位存储芯片构成8K×8位存储器
- 低位地址线A10~A0作为字选线
- 片选信号分配如下：

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/d3e8ef9e2d826e33c5a04dddaf3613401040af874224f56e1f181b5f42aec2d2.jpg)  

#### 优缺点
- 优点：
  - 不需要地址译码器
  - 线路简单
- 缺点：
  - 地址空间不连续
  - 选片地址线必须分时为低电平
  - 存储器空间利用率低

### 译码片选法  

#### 工作原理
- 高位地址线通过地址译码器产生片选信号

#### 实例说明
- 8片8K×8位存储芯片组成64K×8位存储器
  - 地址线16位，数据线8位
  - 需要8个片选信号
  - 使用74LS138作为地址译码器
  - 高3位用于片选：
    - A15A14A13=000选中第一片
    - A15A14A13=001选中第二片
    - 以此类推

## 存储器与CPU的连接  

### 合理选择存储芯片  

> pro：根据要求合理选择存储芯片（2009、2021）  

#### 选择原则
- 存储芯片类型选择：
  - ROM：存放系统程序、标准子程序和常数
  - RAM：用于用户编程
- 芯片数量考虑：
  - 追求连线简单
  - 方便实用

### 地址线的连接  

> pro：地址范围与存储容量的对应关系（2016、2023）  

#### 连接规则
- CPU地址线数通常多于存储芯片
- 连接方式：
  - 低位：CPU地址线与存储芯片地址线相连
    - 用于字选
    - 由片内逻辑完成译码
  - 高位：用于扩充存储芯片
    - 用于片选
    - 由外接译码器完成译码

#### 实例说明
- CPU：16位地址线(A15~A0)
- 存储芯片：1K×4位，10根地址线
- 连接方式：CPU的A9~A0与存储芯片的A9~A0相连

### 数据线的连接  

#### 连接方式
- CPU与存储芯片数据线数相等：
  - 直接相连
- CPU与存储芯片数据线数不等：
  - 需对存储芯片扩位
  - 使数据位数与CPU数据线数相等

### 读/写命令线的连接  

#### 连接方式
- 单一读/写命令线：
  - 直接与存储芯片控制端相连
  - 高电平为读，低电平为写
- 分开的读/写命令线：
  - 读命令线(RD)连接芯片读控制端
  - 写命令线(WE)连接芯片写控制端
  - 均为低电平有效

### 片选线的连接  

#### 基本原理
- 片选决定存储芯片是否被选中
- 取决于片选控制端CS接收到的信号

#### 工作过程
- 与CPU访存控制信号MREQ相关
  - CPU要求访存：MREQ为低电平
  - CPU访问I/O：MREQ为高电平，存储器不工作


# 外部存储器  

## 磁盘存储器

磁盘存储器是以磁盘为存储介质的存储器，其主要优点：
- 存储容量大，位价格低
- 记录介质可重复使用
- 记录信息可长期保存而不丢失，甚至可脱机存档
- 非破坏性读出，读出时不需要再生

缺点：
- 存取速度慢
- 机械结构复杂
- 对工作环境要求较高

### 磁盘存储器基本概念

> pro：磁盘存储器的相关概念（2019）

#### 磁盘设备组成
##### 基本组件
- 磁盘存储器由以下组成：
  - 磁盘驱动器
  - 磁盘控制器 
  - 盘片

##### 磁盘驱动器
- 驱动磁盘转动并在盘面上通过磁头进行读/写操作的装置，如图3.14所示

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/949e3320f633db83d48f7dfbb5d87ac3e37d71935bede8ce35981b7926da2bb7.jpg)  
图3.14磁盘驱动器示意图

##### 磁盘控制器
- 磁盘驱动器与主机的接口
- 主要功能：
  - 接收并解释CPU发来的命令
  - 向磁盘驱动器发出各种控制信号
  - 负责检测磁盘驱动器的状态

##### 存储区域
- 组成结构：
  - 多个记录面
  - 每个记录面划分为若干圆形磁道
  - 每条磁道划分为若干扇区
- 存取特点：
  - 扇区（也称块）是磁盘读/写的最小单位
  - 磁盘按块存取

##### 主要参数
- 磁头数（Heads）：
  - 即记录面数
  - 表示磁盘共有多少个磁头
  - 用于读取/写入盘片上记录面的信息
  - 一个记录面对应一个磁头
- 柱面数（Cylinders）：
  - 表示磁盘每面盘片上有多少条磁道
  - 不同记录面的相同编号（位置）的诸磁道构成一个圆柱面
- 扇区数（Sectors）：
  - 表示每条磁道上有多少个扇区

##### 物理特性
- 磁道间隔：
  - 相邻磁道及相邻扇区间通过间隙分隔
  - 目的是避免精度错误
- 位密度特点：
  - 从最外道向里道增加
  - 磁盘存储能力受限于最内道的最大记录密度

##### 磁盘高速缓存
- 实现方式：
  - 在内存中开辟一部分区域
  - 用于缓冲将被送到磁盘上的数据
- 优点：
  - 写磁盘时按"簇"进行，避免频繁小块数据写盘
  - 中间结果数据在写回磁盘前可快速再次使用

#### 磁记录原理
##### 编码方法
- 按特定方案将二进制信息转换为磁化翻转状态序列
- 要求读/写控制电路容易、可靠地实现转换

##### 磁记录方式
- 通常采用：
  - 调频制（FM）
  - 改进型调频制（MFM）

#### 磁盘性能指标
##### 记录密度
- 定义：盘片单位面积上记录的二进制信息量
- 表示方式：
  - 道密度：沿磁盘半径方向单位长度上的磁道数
  - 位密度：磁道单位长度上能记录的二进制代码位数
  - 面密度：位密度和道密度的乘积

##### 磁盘容量
- 非格式化容量：
  - 定义：磁记录表面可利用的磁化单元总数
  - 计算：记录面数 × 柱面数 × 每条磁道的磁化单元数
- 格式化容量：
  - 定义：按特定记录格式所能存储信息的总量
  - 计算：记录面数 × 柱面数 × 每道扇区数 × 每个扇区的容量
  - 特点：比非格式化容量小

> pro：磁盘存取时间的计算（2013、2015、2022）

##### 存取时间
- 组成部分：
  - 寻道时间：磁头移动到目的磁道的时间
  - 旋转延迟时间：磁头定位到要读/写扇区的时间
  - 传输时间：传输数据所花费的时间
- 时间计算：
  - 平均寻道时间：从最外道移动到最内道时间的一半
  - 平均旋转延迟时间：旋转半周的时间

##### 数据传输速率
- 定义：单位时间内向主机传送数据的字节数
- 计算公式：Dr = rN
  - r：磁盘转数（转/秒）
  - N：每条磁道容量（字节）

#### 磁盘地址

> pro：磁盘地址结构的计算（2022）

##### 地址结构
- 主机向磁盘控制器发送寻址信息
- 基本地址结构如图所示

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/63c7621ebd786e99322bc2b3b8f2b7a6108c715c1896f3fefe6388625f9c5d47.jpg)

##### 地址示例
- 条件：
  - 16个盘面
  - 每个盘面256个磁道
  - 每个磁道16个扇区
- 结果：
  - 每个扇区地址需16位二进制代码
  - 格式如图所示

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/a05c8eee3f46040951717583967f67c0aa6f299dd9fed653a49b666bc3e3b2b4.jpg)

#### 磁盘工作过程
##### 基本操作
- 主要操作类型：
  - 寻址
  - 读盘
  - 写盘
- 操作特点：
  - 每个操作对应一个控制字
  - 工作步骤：
    1. 取控制字
    2. 执行控制字

##### 操作限制
- 属于机械式部件
- 读/写操作是串行的：
  - 不能同时读写
  - 不能同时读两组数据
  - 不能同时写两组数据

### 磁盘阵列  

#### RAID概述
- RAID（独立冗余磁盘阵列）的特点：
  - 将多个独立的物理磁盘组成一个独立的逻辑盘
  - 数据在多个物理盘上分割交义存储、并行访问
  - 具有更好的存储性能、可靠性和安全性

> pro：提高RAID可靠性的措施（2013）  

#### RAID分级
- RAID1～RAID5的共同特点：
  - 磁盘损坏时可随时更换
  - 数据不会损坏
  - 提升系统可靠性

##### RAID类型
- RAID0：无冗余和无校验的磁盘阵列
- RAID1：镜像磁盘阵列
- RAID2：采用纠错的海明码的磁盘阵列
- RAID3：位交叉奇偶校验的磁盘阵列
- RAID4：块交叉奇偶校验的磁盘阵列
- RAID5：无独立校验的奇偶校验磁盘阵列

##### RAID0详解
- 特点：
  - 使用条带化技术
  - 连续数据块交替存放在不同物理磁盘扇区
  - 多个磁盘交叉并行读/写
- 优点：
  - 扩大存储容量
  - 提高磁盘存取速度
- 缺点：
  - 无容错能力

##### RAID1详解
- 工作方式：
  - 两个磁盘同时进行读/写
  - 互为备份
- 优点：
  - 若一个磁盘故障，可从另一磁盘读取数据
- 缺点：
  - 实际容量减少一半

#### RAID总结
- 主要优势：
  - 通过多磁盘同时使用提高传输速率
  - 通过并行存取提高数据吞吐量
  - 通过镜像功能提高安全可靠性
  - 通过数据校验提供容错能力
## 固态硬盘  

### 固态硬盘的特性

#### 基本组成与工作原理
- 固态硬盘（SSD）是基于闪存技术的存储器
  - 与U盘无本质差别，但容量更大，存取性能更好
- 组成部分
  - 一个或多个闪存芯片
  - 闪存翻译层
    - 替代传统磁盘控制器角色
    - 将CPU的逻辑块读/写请求翻译成底层物理设备的控制信号

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f4c9b82aff9e75d81635a4e6f89fa583ec0838d5124b1cd07047a821d4691ebd.jpg)  
图3.15固态硬盘（SSD）  

#### 存储结构与特点
- 闪存结构
  - 由B块组成，每块由P页组成
  - 页大小：512B~4KB
  - 每块包含32~128页
  - 块大小：16KB~512KB
- 读写特性
  - 以页为单位读/写
  - 写入限制：需先擦除整个块
  - 块擦除后的页可直接写入一次
  - 重复写会导致块磨损

##### 性能特点
- 随机写入慢的原因
  - 块擦除速度慢，比页访问慢一个数量级
  - 修改已有数据需要整块复制
- 相对传统磁盘的优势
  - 随机访问更快
  - 无机械噪声和振动
  - 能耗低
  - 抗震性好
  - 安全性高

### 磨损均衡（Wear Leveling）

#### 固态硬盘的寿命问题
- 主要缺点
  - 闪存擦写寿命有限（几百到几千次）
  - 读写集中可能导致部分闪存过度损耗
  - 局部损坏可能影响整个SSD

#### 磨损均衡技术
##### 动态磨损均衡
- 写入数据时自动选择较新的闪存块
- 让老的闪存块暂时休息

##### 静态磨损均衡
- 更高级的技术方案
  - 无数据写入时也进行监测
  - 自动进行数据分配
  - 老闪存块用于存储静态数据
  - 新闪存块负责日常读写操作

#### 寿命提升效果
- 实际使用寿命显著提升
  - 以256GB SSD为例
    - 擦写寿命500次时需写入125TB才会损坏
    - 每天写入10GB数据需30多年才会磨损
 

# 缓冲存储器  

由于程序的转移概率不会很低，数据分布的离散性较大，因此单纯依靠并行主存系统提高主存系统的效率是有限的。高速缓存Cache拥有比主存更快的速度，因此在CPU和主存之间设置Cache可以显著提高存储系统的效率。Cache由SRAM组成，通常直接集成在CPU中。  

## 程序访问的局部性原理

### 局部性原理概述
- 包括时间局部性和空间局部性
> pro：分析给定代码的时空局部性（2017、2023）  

#### 时间局部性
- 最近的未来要用到的信息，很可能是现在正在使用的信息
  - 原因：
    - 程序中存在盾环
    - 需要多次重复执行的子程序段
    - 对数组的存储和访问操作

#### 空间局部性
- 最近的末来要用到的信息，很可能与现在正在使用的信息在存储空间上是邻近的
  - 原因：
    - 指令通常是顺序存放、顺序执行的
    - 数据一般以向量、数组等形式簇聚地存储

#### 高速缓冲技术应用
- 利用局部性原理
  - 将正在使用的部分数据存放在高速、容量较小的Cache中
  - 使CPU的访存操作主要针对Cache进行
  - 提高程序的执行速度

### 局部性原理实例分析
【例3.2】假设数组元素按行优先方式存储，对于下面的两个程序：

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/b41550f0178bf3620106cb205eed357ec765a9ec70eeda1a5cf5cda98d67dbf0.jpg)

#### 问题分析
1）对于数组a的访问，哪个空间局部性更好？哪个时间局部性更好？
2）对于指令访问来说，for循环体的空间局部性和时间局部性如何？

#### 解答过程
- 基本条件：
  - M、N为2048
  - 按字节编址
  - 每个数组元素占4字节

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/3beffe3fd561e33f22d27b23b7735f6b3805a9b89288a00b6514d0ad34b06ace.jpg)
图3.16指令和数据在主存的存放

> pro：数组按行或列访问命中率的分析（2010）；数组循环访问的命中率分析（2016、2020）

##### 数组访问分析
- 程序A的空间局部性：
  - 访问顺序：a[0][0],a[0][1],,a[0][2047];a[1][0],a[1][1],,a[1][2047]
  - 访问顺序与存放顺序一致，空间局部性好

- 程序B的空间局部性：
  - 访问顺序：a[0][0],a[1][0].,a[2047][0];a[0][1],a[1][1],,a[2047][1]
  - 每次访问跳过2048个数组元素（8192字节）
  - 若主存与Cache交换单位<8KB，每访问都需装入新块
  - 无空间局部性

- 时间局部性：
  - 两个程序都差
  - 原因：每个数组元素只访问一次

> pro：程序中指令Cache的命中率分析（2014）

##### 循环体访问分析
- 两个程序的循环体局部性相同：
  - 空间局部性好：指令按序连续存放
  - 时间局部性好：内循环体被连续重复执行2048×2048次

##### 结论
- 虽然功能相同，但执行时间差异大
- 原因：内外循环顺序不同导致数组访问空间局部性差异

## Cache的基本工作原理

### Cache基本结构
- Cache和主存划分特点：
  - 都划分为大小相等的块
  - Cache块也称Cache行
  - 每块由若干字节组成
  - 块长也称行长
- Cache容量特点：
  - 远小于主存容量
  - 块数远少于主存块数
  - 仅保存主存最活跃块的副本

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/e95e7ed2b82fea1f024168bab35ac7aaf81ff99ed3bddc2a543be0029e74d2bd.jpg)
图3.17高速缓冲存储器的工作原理

> pro：Cache命中对CPU执行时间影响的分析（2013、2015）

### Cache工作流程
#### 读操作流程
- Cache命中时：
  - 将访存地址转换为Cache地址
  - 直接读取Cache，不访问主存
- Cache不命中时：
  - 访问主存
  - 将整块数据调入Cache
  - 若Cache已满，使用替换算法

#### 写操作流程
- Cache命中时：
  - 可能出现数据不一致问题
  - 需按写策略处理
  - 常见方法：全写法和回写法

> attention：某些计算机中也采用同时访问Cache和主存的方式，若Cache命中，则终止访存。

### Cache性能分析
> pro：Cache命中率的计算（2009）

#### 命中率计算
- 命中率计算公式：
  - H = Nc/(Nc+Nm)
  - Nc：Cache命中次数
  - Nm：访问主存次数
- 平均访问时间：
  - Ta = H×tc + (1-H)×tm
  - tc：Cache访问时间
  - tm：主存访问时间

> pro：Cache缺失率对主存带宽的影响（2012）

#### 性能提升实例
【例3.3】性能计算：
- 条件：
  - Cache速度是主存5倍
  - Cache命中率95%
- 计算过程：
  - Cache存取周期为t
  - 主存存取周期为5t
  - 平均访问时间T = 0.95×t + 0.05×(t+5t) = 1.25t
  - 或T = t + 0.05×5t = 1.25t
- 结论：性能提升约4倍

### Cache实现关键问题
1. 数据查找
   - 如何快速判断数据是否在Cache中

2. 地址映射
   - 主存块如何存放在Cache中
   - 如何将主存地址转换为Cache地址

3. 替换策略
   - Cache满后的块替换策略
   - 块淘汰策略选择

4. 写入策略
   - 如何保证数据一致性
   - 如何提升效率

## Cache和主存的映射方式  

- Cache行需要标记位和有效位:
  - 标记位指明是主存中哪一块的副本
  - 有效位说明Cache行中信息是否有效

- 地址映射概念:
  - 把主存地址空间映射到Cache地址空间
  - 按规则将主存信息装入Cache
  - 有3种映射方法

### 直接映射  

#### 基本原理
- 主存块只能装入Cache唯一位置
- 若位置已有内容则产生块冲突
- 特点:
  - 实现简单但不够灵活 
  - 块冲突概率最高
  - 空间利用率最低

> pro：直接映射的地址结构及映射关系的分析（2010、2011、2015）  

#### 映射关系
- 映射公式:
  - Cache行号 $=$ mod Cache
- 映射规则:
  - 假设Cache有$2^c$行,主存有$2^m$块
  - 主存块映射规律:
    - 第0块、第$2^c$块、第$2^{c+1}$块映射到Cache第0行
    - 第1块、第$2^c+1$块、第$2^{c+1}+1$块映射到Cache第1行
  - 主存块号低$c$位即为Cache行号
  - Cache行需设置$t=m-c$位标记

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/0d4d9150e1b74972905e0f2411e001d19ac079c052b685d6319df172fd1f46af.jpg)  
图3.18Cache和主存之间的直接映射方式  

#### 地址结构
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/1a310ec397e1e430790891edc7b4fe7034517d79896535099a72318e362d5cfc.jpg)  

#### 访存过程
- 根据访存地址中间c位找到Cache行
- 比较Cache行标记和主存地址高t位标记:
  - 相等且有效位为1:命中
    - 根据块内地址在Cache行中存取
  - 不相等或有效位为0:不命中
    - 从主存读块到Cache行
    - 设置有效位和标记
    - 将内容送CPU

### 全相联映射  

#### 基本原理
- 主存块可装入Cache任何位置
- 每行标记指示来自主存的哪一块
- 优点:
  - Cache块冲突概率低
  - 空间利用率高
  - 命中率高
- 缺点:
  - 标记比较速度慢
  - 实现成本高

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/a8989ceb071e5ad8c8d6dca134a27f62a4c6286c510cc52ef891f745bf53aba0.jpg)  
图3.19Cache和主存之间的全相联映射方式  

#### 地址结构
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/d778483358bb5cfaa81acdb4053dea9aacce5ec9ea238257e705ba9e2fca92cd.jpg)  

#### 访存过程
- 比较主存地址高位标记与Cache各行标记
- 若有相等且有效位为1:
  - 命中,根据块内地址取信息
- 若都不相等:
  - 不命中,从主存读块到空闲行
  - 设置有效位和标记
  - 将内容送CPU

> pro：根据地址结构和比较器数量判断映射方式（2018）  

#### 硬件实现特点
- 每个Cache行设置一个比较器
- 比较器位数等于标记字段位数
- 采用"按内容访问"的存取方式
- 不适合大容量Cache:
  - 时间开销大
  - 硬件开销大
### 组相联映射  

> pro：组相联映射方式的原理（2009、2016、2018～2020、2023）  

#### 基本原理
- 将Cache分成Q个大小相等的组
- 每个主存块可以装入固定组中的任意一行
  - 组间采用直接映射
  - 组内采用全相联映射
- 是对直接映射和全相联映射的折中
  - 当Q=1时变为全相联映射
  - 当Q=Cache行数时变为直接映射
- 路数特点
  - 路数越大，每组Cache行数量越大
  - 块冲突概率越低，但相联比较电路越复杂
  - 适当路数可使性能接近全相联，成本接近直接映射

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/705d35296eca71ed8eded974c3d677da76008d584c3b528fa5e8971962c6d880.jpg)  
图3.20Cache和主存之间的二路组相联映射方式  

#### 映射关系
- Cache组号 = mod Cache 组数（Q）
- 地址结构：
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/16468247b7f68d80ea35bf713452faaeaab1af0cc4620f1f67e90b71bd4d66a4.jpg)  

> pro：组相联映射的访存过程及Cache缺失处理过程（2020）  

#### 访存过程
- 根据访存地址中间组号找到对应Cache组
- 比较组内每行标记与主存地址高位标记
- 命中情况
  - 有相等且有效位为1：命中
    - 根据块内地址在Cache行中存取
  - 都不相等或有效位为0：不命中
    - 从主存读块到对应组空闲行
    - 设置有效位和标记
    - 将内容送CPU

> pro：组相联映射中比较器的个数和位数（2022）  

#### 硬件实现
- 比较器需求
  - 直接映射：1个比较器
  - r路组相联：r个比较器

> pro：直接映射、组相联映射相关标记位及总容量的分析（2010）  

#### 实例分析
##### 例3.4
主存条件：
- 地址空间：256MB
- 按字节编址
- 数据Cache：8个Cache行
- 行长：64B

###### 问题分析与解答
1. Cache总容量计算
   - 总容量 = 存储容量 + 标记阵列容量
   - 不考虑脏位和替换算法位

> pro：直接映射相关标记位的分析（2015、2021）  

> attention：  

##### 标记阵列结构
- 每Cache行对应一个标记项
  - 包括：有效位、脏位、替换算法位、标记位
- 组相联特点
  - 每组各行标记项排成一行
  - 各组从上到下排列成二维标记阵列

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/57f1a99d258e755109902e23acf15b394fc66b1b280f1f9dca674653a358810b.jpg)  
图3.21二路组相联的标记阵列示意图  

##### 存储容量计算
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/683ed3f03365e410bb54f631a3aa7975ef5c257a5d5fb4a06bc06596f36764f8.jpg)  
图3.22Cache行的存储容量示意图  

- 标记字段长度计算
  - 主存地址：28位(256MB=2^28B)
  - 块内地址：6位(2^6B=64B)
  - 行号：3位(2^3=8)
  - 标记字段：19位(28-6-3)
- 总容量：8×(1+19+512)=4256位

2. 主存地址3200映射分析
   - 直接映射：Cache行号为2
   - 二路组相联：组号2(行号4或5)

3. 访存过程(地址0123456H)
   - 地址划分
     - 主存标记位：19位
     - 块号：3位
     - 块内地址：6位
   - 访问步骤
     - 根据块号查Cache对应行
     - 比较主存标记位
     - 检查有效位
     - 根据结果进行相应操作

#### 映射方式比较
- 映射范围
  - 直接映射：固定行
  - 全相联映射：所有行
  - N路组相联：N行
- 性能对比
  - 命中率：全相联>组相联>直接映射
  - 判断开销：直接映射<组相联<全相联
  - 空间开销：直接映射<组相联<全相联

## Cache中主存块的替换算法

### 替换算法概述
- 替换算法使用场景：
  - 全相联映射或组相联映射需要使用
  - 直接映射不需要考虑替换算法
    - 原因：主存块只能放到唯一固定Cache行

### 常用替换算法类型

#### 随机(RAND)算法
- 随机确定替换的Cache行
- 特点：
  - 实现简单
  - 未依据局部性原理
  - 命中率可能较低

#### 先进先出(FIFO)算法  
- 选择最早调入的Cache行进行替换
- 特点：
  - 容易实现
  - 未依据局部性原理
  - 最早进入的块可能仍常用

> pro：组相联映射中LRU算法的命中分析（2012、2021）  

#### 近期最少使用(LRU)算法
- 基本原理：
  - 依据程序访问的局部性原理
  - 选择近期未访问的Cache行替换
  - 属于堆栈类算法
  - 平均命中率高于FIFO

> pro：LRU替换位及其位数的计算（2018、2020）  

##### LRU算法实现细节
- 计数器设置：
  - 每个Cache行设置计数器(LRU替换位)
  - 计数值记录主存块使用情况
  - 位数与Cache组大小相关：
    - 二路：1位LRU位
    - 四路：2位LRU位

- 替换过程示例：
  - 条件：
    - 四路组相联
    - 5个主存块{1,2,3,4,5}映射到同一组
    - 访问序列{1,2,3,4,1,2,5,1,2,3,4,5}

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/172e58f1cfb7469387af458dc7e49c1ea931605bc2c9081f5e57a4932c9604de.jpg)  
图3.23LRU算法的替换过程示意图  

- 计数器变化规则：
  - 命中时：
    - 命中行计数器清零
    - 比其低的计数器加1
    - 其余不变
  - 未命中且有空闲行：
    - 新装入行计数器置0
    - 其余全加1
  - 未命中且无空闲行：
    - 计数值为3的行被替换
    - 新装入行计数器置0
    - 其余全加1

##### 抖动现象
- 发生条件：集中访问存储区超过Cache组大小
- 示例：
  - 访问序列：1,2,3,4,5,1,2,3,4,5,...
  - Cache每组4行
  - 结果：命中率为0

#### 最不经常使用(LFU)算法
- 基本原理：
  - 换出一段时间内访问次数最少的Cache行
- 实现方式：
  - 每行设置计数器
  - 新行装入从0开始计数
  - 每次访问计数器加1
  - 替换时选择计数值最小的行

## Cache的一致性问题

### 写操作策略概述
- 目的：保持Cache和主存内容一致
- 分类：
  - 写命中策略
  - 写不命中策略

### 写命中策略

> pro：直写法的特点（2015）、直写法是否需设修改位（2020）  

#### 全写法(直写法、Write-through)
- 基本原理：
  - CPU同时写入Cache和主存
  - 替换时直接覆盖，无需写回
- 特点：
  - 实现简单
  - 保持主存数据正确性
  - 缺点：增加访存次数
- 写缓冲优化：
  - 位置：Cache和主存之间
  - 工作方式：
    - CPU同时写入Cache和写缓冲
    - 写缓冲再写入主存
  - 局限性：频繁写时可能溢出

> pro：回写法的修改位（2018、2020）  

#### 回写法(write-back)
- 基本原理：
  - 仅写入Cache
  - 替换时才写回主存
- 特点：
  - 减少访存次数
  - 存在数据不一致风险
- 修改位(脏位)机制：
  - 1：块被修改，需写回
  - 0：块未修改，无需写回

### 写不命中策略

#### 写分配法(write-allocate)
- 处理步骤：
  - 更新主存单元
  - 调入主存块到Cache
- 特点：
  - 利用空间局部性
  - 缺点：每次需从主存读块

#### 非写分配法(not-write-allocate)
- 处理方式：
  - 仅更新主存单元
  - 不调入主存块
- 使用搭配：
  - 通常与全写法合用
  - 写分配法通常和回写法合用

### Cache结构设计

> pro：采用分离的指令Cache和数据Cache的主要目的（2014）  

#### 分离Cache结构
- 背景：指令流水技术发展需求
- 优势：
  - 避免指令预取与数据存取冲突
  - 优化不同局部性特征
- 统一Cache特点：
  - 设计实现简单
  - 存在访问冲突

#### 多级Cache设计
- 二级Cache示例：
  - L1Cache（靠近CPU）：
    - 速度快，容量小
    - 指令数据通常分离
    - 采用写分配法和回写法
  - L2Cache：
    - 速度和容量居中
    - L1对L2使用全写法
    - L2对主存使用回写法
  - 优势：避免写缓冲饱和溢出

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/a36a40284b9aa454bc42de878bcab6fe9160cad5f6b92ce9054bac667f2a2cf5.jpg)  
  

# 虚拟存储器  

- 虚拟存储器的构成：
  - 由主存和辅存共同构成。
  - 在硬件和系统软件的共同管理下工作。

- 虚拟存储器的透明性：
  - 对于应用程序员而言是透明的。

- 虚拟存储器的特点：
  - 具有主存的速度。
  - 具有辅存的容量。
 

## 基本概念  

### 地址空间
#### 虚拟地址空间
- 将主存或辅存的地址空间统一编址，形成一个庞大的地址空间
- 用户可以自由编程，而不必在乎：
  - 实际的主存容量
  - 程序在主存中实际的存放位置

#### 地址类型
##### 虚地址(逻辑地址)
- 用户编程允许涉及的地址
- 对应的存储空间称为：
  - 虚拟空间
  - 程序空间

##### 实地址(物理地址) 
- 实际的主存单元地址
- 对应的是主存地址空间(实地址空间)
- 虚地址比实地址要大很多

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/3f30148f78a751f6de56c12ee740b690d95cef0f05379cb11a3386b06baf0ec8.jpg)  
图3.24虚拟存储器的三个地址空间  

### CPU访问机制
#### 地址判断与转换
- CPU使用虚地址时的处理流程：
  - 判断虚地址对应内容是否已装入主存
  - 若在主存中：
    - 通过地址变换直接访问主存指示的实际单元
  - 若不在主存中：
    - 把包含这个字的一页或一段调入主存后再访问
    - 若主存已满，采用替换算法置换主存中的交换块

> pro：虚拟存储器只能采用回写法的原因（2016）  

### 技术特点
- 采用类似Cache的技术：
  - 将辅存中经常访问的数据副本存放到主存
- 特殊机制：
  - 采用全相联映射：每个虚页面可存放到对应主存区域的任何空闲页位置
  - 采用回写法处理一致性：因缺页访问辅存代价大，不能每次写操作都同时写回磁盘
## 页式虚拟存储器  

页式虚拟存储器以页为基本单位。
- 主存空间和虚拟地址空间都被划分成相同大小的页
  - 主存空间中的页称为物理页、实页、页框
  - 虚拟地址空间中的页称为虚拟页、虚页
- 页表记录了程序的虚页调入主存时被安排在主存中的位置
- 页表一般长久地保存在内存中

### 页表  

#### 页表组成
- 有效位(装入位)
  - 用来表示对应页面是否在主存
  - 若为1，则表示该虚拟页已从外存调入主存，此时页表项存放该页的物理页号
  - 若为0，则表示没有调入主存，此时页表项可以存放该页的磁盘地址
- 脏位(修改位)
  - 用来表示页面是否被修改过
  - 虚存机制中采用回写策略，利用脏位可判断替换时是否需要写回磁盘
- 引用位(使用位)
  - 用来配合替换策略进行设置
  - 例如是否实现最先调入（FIFO位）或最近最少用（LRU位）策略等

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/b8ab5292e69b51c36468563f144fde40a570b1a370f205fa85c05cc588cbae16.jpg)  
图3.25主存中的页表示例  

> pro：数组的分页存放、缺页异常分析及缺页处理过程（2014、2019、2023）  

#### 缺页处理过程
- CPU访问数据在已存在页面时
  - 如第1页，有效位为1，说明该页已存放在主存中
  - 通过地址转换部件将虚拟地址转换为物理地址
  - 到相应的主存实页中存取数据
- CPU访问数据在缺失页面时
  - 如第5页，有效位为0，则发生"缺页"异常
  - 需调用操作系统的缺页异常处理程序
  - 处理步骤：
    - 根据对应表项中的存放位置字段，将所缺页面从磁盘调入一个空闲的物理页框
    - 若主存中没有空闲页框，还需要选择一个页面替换
    - 由于采用回写策略，换出页面时根据脏位确定是否要写回磁盘
    - 缺页处理过程中需要对页表进行相应的更新

#### 优缺点分析
- 优点：
  - 页面的长度固定
  - 页表简单
  - 调入方便
- 缺点：
  - 最后一页的零头将无法利用而造成浪费
  - 页不是逻辑上独立的实体，处理、保护和共享都不及段式虚拟存储器方便

### 地址转换  

> pro：虚拟地址结构的分析（2011、2019、2021）  

#### 地址结构
- 虚拟地址分为两个字段：
  - 高位为虚页号
  - 低位为页内偏移地址
- 物理地址分为两个字段：
  - 高位为物理页号
  - 低位为页内偏移地址
- 特点：
  - 两者的页面大小相同，页内偏移地址相等
  - 虚拟地址到物理地址的转换由页表实现
  - 页表是存放在主存中的虚页号和实页号的对照表

> pro：虚拟地址主存物理地址（2011、2013、2018、2022）  

#### 地址转换过程
- 基本步骤：
  - 通过页表基址寄存器找到进程的页表首地址（对应 $^\mathrm{\textregistered}$ )
  - 根据虚拟地址高位的虚拟页号找到对应的页表项（对应 $\mathcal{Q}$ ）
  - 若装入位为1：
    - 取出物理页号（对应③ ）
    - 和虚拟地址低位的页内地址拼接，形成实际物理地址（对应 $^{(4)}$ ）
  - 若装入位为0：
    - 说明缺页，需要操作系统进行缺页处理

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/8abbc24dc44951166da271761d02b9beff867be6de5e5dc08cc6e6325bcebf8e.jpg)  
图3.26页式虚拟存储器的地址变换过程  

### 快表（TLB）  

#### 引入原因
- 访存过程中的问题：
  - 需要先访问一次主存去查页表
  - 再访问主存才能取得数据
  - 若缺页，则还要进行页面替换、页面修改等
  - 采用虚拟存储机制后，访问主存的次数更多了

> pro：TLB的硬件实现（2018），TLB和Cache的比较（2020）  

#### 工作原理
- 基于程序访问的局部性原理：
  - 在一段时间内总是经常访问某些页
  - 把这些页对应的页表项存放在高速缓冲器组成的快表（TLB）中
  - 把放在主存中的页表称为慢表（Page）
- 地址转换时：
  - 首先查找快表
  - 若命中，则无须访问主存中的页表

> pro：TLB映射方式、地址划分与标记字段：与Cache相同（2016、2021）  

#### 实现特点
- 硬件实现：
  - 用SRAM实现
  - 工作原理类似于Cache
  - 通常采用全相联或组相联映射方式
- TLB表项组成：
  - 页表表项内容
  - TLB标记
- 映射方式：
  - 全相联映射：TLB标记就是对应页表项的虚拟页号
  - 组相联方式：
    - TLB标记是对应虚拟页号的高位部分
    - 虚拟页号的低位部分作为TLB组的组号

### 具有TLB和Cache的多级存储系统  

#### 系统组成与工作原理
- CPU给出32位虚拟地址
- TLB采用全相联方式:
  - 每项都有比较器
  - 查找时将虚页号与TLB标记字段同时比较
  - 若某项相等且有效位为1:
    - TLB命中，直接通过TLB进行地址转换
  - 若未命中:
    - TLB缺失，需访问主存查页表
    - 使用两级页表方式:
      - 虚页号分为页目录索引和页表索引
      - 通过这两部分得到页表项进行地址转换
      - 将表项调入TLB(若已满需替换)

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/631bb0e61b3bdacef3897c62f9b2563c6e1aa46c348e5f719e87b9db2f47ed57.jpg)  
图3.27TLB和Cache的访问过程  

#### 快表和慢表的查找机制
- 可以同步进行查找
- 若快表中有虚页号:
  - 快速找到实页号
  - 慢表查找作废
  - 访问主存速度几乎不下降

> pro：TLB、Cache和Page缺失组合的分析（2010）  

#### 多级存储系统的访问过程
##### 缺失类型
- TLB缺失：页表项不在TLB中
- Cache缺失：主存块不在Cache中
- Page缺失：页面不在主存中
  - Page缺失时TLB必然缺失
  - Page缺失时Cache必然缺失

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/410f211a8065de602231efcdde6fb31482045afcb7cd24653c854c6b447608e7.jpg)  
图3.28带TLB虚拟存储器的CPU访存过程  

##### 缺失组合情况
表3.3TLB、Page、Cache三种缺失的可能组合情况
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/5449e48e05a1210c3ad8e1dda8ec750f02c257f2e7997847b56ece5d409deea7.jpg)  

##### 不同组合的处理
- 第1种组合：最佳情况，无需访问主存
- 第2、3种组合：需访问一次主存
- 第4种组合：需访问两次主存
- 第5种组合：
  - 发生"缺页异常"
  - 需访问磁盘
  - 至少访问两次主存
- 处理方式：
  - Cache缺失：硬件处理
  - 缺页处理：软件处理(操作系统缺页异常处理程序)
  - TLB缺失：可硬件或软件处理

> attention：  

在《操作系统考研复习指导》的第3章中，介绍了在同时具有TLB和Cache的存储系统中虚实地址转换的实例，读者可以结合这些内容进行学习。
## 段式虚拟存储器  

### 基本概念和结构
- 段是按程序的逻辑结构划分的
  - 各个段的长度因程序而异
- 虚拟地址分为两部分
  - 段号
  - 段内地址

### 地址变换机制
- 通过段表实现虚拟地址到实地址的变换
  - 段表是程序的逻辑段和主存位置的对照表
  - 段表每行记录包含:
    - 段号
    - 装入位 
    - 段起点
    - 段长等信息
- CPU访存过程:
  - 根据段表基地址与段号拼接成段表项
  - 根据装入位判断段是否在主存
    - 装入位为"1":段已在主存
    - 装入位为"0":段不在主存
  - 若在主存:
    - 读出段起始地址
    - 与段内地址相加得到实地址

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/1b0fa6804dac3b58468ab24b6f02dbc573bbcb4d48f2326802894513dae0c641.jpg)  
图3.29段式虚拟存储器的地址变换过程  

### 特点分析
#### 对程序员的透明性
- 分段对程序员不透明
  - 因为段是程序逻辑结构决定的独立部分
- 分页对程序员透明
  - 编程时无需知道分页方式

#### 优缺点
- 优点:
  - 段的分界与程序自然分界对应
  - 具有逻辑独立性
  - 易于编译、管理、修改和保护
  - 便于多道程序共享
- 缺点:
  - 段长度可变导致空间分配不便
  - 易在段间留下碎片
  - 空间利用效率低

## 段页式虚拟存储器  

### 基本结构
- 程序分段后再分页
  - 每段划分为固定大小的页
  - 主存空间划分为等大的页
  - 以页为基本交换单位
- 程序结构:
  - 每程序对应一个段表
  - 每段对应一个页表
  - 段长必须是页长的整数倍
  - 段起点必须是页的起点

### 地址变换过程
- 虚地址分为三部分:
  - 段号
  - 段内页号
  - 页内地址
- CPU访存步骤:
  - 根据段号得到段表地址
  - 从段表取出页表起始地址与段内页号合成页表地址
  - 从页表取出实页号与页内地址拼接成实地址

### 优缺点分析
- 优点:
  - 兼具页式和段式的优点
  - 可按段实现共享和保护
- 缺点:
  - 需两次查表
  - 系统开销大

## 虚拟存储器Virtual memory与Cache的比较  

### 相同之处  
- 目标都是提高系统性能
  - 都有容量、速度、价格梯度
- 数据组织方式相似
  - 都划分为信息块作为交换单位
  - 虚存系统信息块更大
- 管理机制相似
  - 都有地址映射
  - 都有替换算法
  - 都有更新策略
- 原理相似
  - 都依据局部性原理
  - 采用"快速缓存"思想
  - 将活跃数据放在高速部件

### 不同之处  
- 解决目标不同
  - Cache解决系统速度
  - 虚拟存储器解决主存容量

- 实现方式不同
  - Cache全由硬件实现
    - 对所有程序员透明
  - 虚拟存储器由OS和硬件共同实现
    - 对系统程序员不透明
    - 对应用程序员透明

> pro：Cache缺失和缺页的处理开销对比（2016）  

- 不命中影响不同
  - CPU速度约为Cache的10倍
  - 主存速度为硬盘的100倍以上
  - 虚拟存储器不命中对系统影响更大

- 访问通路不同
  - CPU与Cache和主存有直接通路
    - Cache不命中时可直接与CPU通信
  - CPU与辅存无直接通路
    - 虚存不命中需先调入主存 



# 本章小结  
 

1）存储器系统为何要分这些层次？计算机如何管理这些层次？  

Cache-主存层在存储系统中主要对CPU访存起加速作用，即从整体运行的效果看，CPU访存速度加快，接近于Cache的速度，而寻址空间和位价却接近于主存。主存-辅存层在存储系统中主要起扩容作用，即从程序员的角度看，他所使用的存储器的容量和位价接近于辅存，而速度接近于主存。因此从整个存储系统来看，就达到了速度快、容量大、位价低的效果。  

主存与Cache之间的信息调度全部由硬件自动完成。而主存与辅存的信息调度则采用虚拟存储技术实现，即将主存与辅存的一部分通过软/硬结合的技术组成虚拟存储器，程序员可用这个比主存实际空间（物理地址空间）大得多的虚拟地址空间（逻辑地址空间）编程，当程序运行时，再由软/硬件自动配合完成虚拟地址空间与主存实际物理空间的转换。  

2.影响Cache性能的因素有哪些？  

决定Cache系统访存效率重要因素是命中率，它与很多因素有关。1）命中率与映射方式有关，全相联映射方式的命中率最高，直接映射方式的命中率最低。2）命中率与Cache容量有关，显然Cache容量越大，命中率就越高。3）命中率还与主存块（或Cache行）的大小有关，主存块的大小要适中。  
除上述因素外，系统是采用单级还是采用多级Cache，数据Cache和指令Cache是分离还是合在一起，主存-总线-Cache-CPU之间采用什么架构等，都会影响Cache的总体性能。  

3）虚拟存储系统的页面是设置得大一些好还是设置得小一些好？  

页面大小要适中。页面太小时，平均页内剩余空间较小，可节省存储空间，但会使得页表增大，页面太小时也不能充分利用空间局部性来提高命中率：页面太大时，可减少页表空间，但平均页内剩余空间较大，会浪费较多存储空间，页面太大还会使页面调入/调出的时间较长。  

# 常见问题和易混淆知识点  

- 1.Cache行的大小和命中率之间有什么关系？  

Cache行的长度较大时，能充分利用程序访问的空间局部性，使一个较大的局部空间被一起调到Cache中，因而可以增加命中机会。但是，行长也不能太大，主要原因有两个：  

1）行长大使失效损失变大。也就是说，若未命中，则需花更多时间从主存读块。  

2）行长太大，Cache项数变少，因而命中的可能性变小。  

Cache行的长度较小时，命中率会很低，但好处是存取块的代价较小。  

- 2.发生取指令Cache缺失的处理过程是什么？  

1）程序计数器恢复当前指令的值。  

2）对主存进行读的操作。  

3）将读入的指令写入Cache中，更改有效位和标记位。  

4）重新执行当前指令。  

- 3.Cache总容量与映射方式有何种关系？  

Cache总容量 $=$ [每个Cache行标记项的容量（有效位、脏位、LRU替换位、标记位）+Cache行长xCache总行数。其中，有效位和标记位是所有Cache所必需的；脏位只在Cache采用回写法时才需要设置；LRU替换位只在Cache采用LRU替换算法时才需要设置。  

有效位：占1位，用于说明Cache行中的数据是否有效。脏位（修改位）：占1位，回写法才需要设置，用以说明Cache行中的数据是否被修改过。LRU替换位：位数为 $\log_{2}($ 组内块数），用于LRU替换算法中的访问计数。  

标记位Tag：主存地址结构中的标记字段，其位数取决于所用的映射方式，用于匹配Cache行对应主存中的哪个块。  

Cache容量与映射方式的具体关系如图3.30所示。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/77d74c7bc0a8fc408aa68057edb2cbdd1c424abbf65fd57e9f4d982659723d0b.jpg)  