# above

## 【考纲内容】  

（一）CPU的功能和基本结构  

（二）指令执行过程  

（三）数据通路的功能和基本结构  

（四）控制器的功能和工作原理  

五）异常和中断机制异常和中断的基本概念：异常和中断的分类；异常和中断的检测与响应  

（六）指令流水线指令流水线的基本概念：指令流水线的基本实现：结构冒险、数据冒险和控制冒险的处理；超标量和动态流水线的基本概念  

（七）多处理器基本概念  

SISD、SIMD、MIMD、向量处理器的基本概念：硬件多线程的基本概念：多核（multi-core）处理器的基本概念：共享内存多处理器（SMP）的基本概念  

## 【复习提示】  

- 中央处理器（CPU）概述：
  - 位于计算机的中心。
    - 本书的难点

- CPU内部结构分析：
  - 数据通路的分析。
  - 指令执行阶段的节拍与控制信号的安排。
  - 流水线技术与性能分析。

- 易出综合题的内容：
  - 数据通路的分析。
  - 指令执行阶段的节拍与控制信号的安排。
  - 流水线技术与性能分析。

- 易出选择题的内容：
  - 各种寄存器的特点。
  - 各种指令执行的周期与特点。
  - 控制器的相关概念。
  - 流水线的相关概念。


<details>
<summary>学习本章时思考的问题：</summary>

  1. 指令和数据均存放在内存中，计算机如何区分它们？
     - 从时间和空间上区分指令和数据。

  2. 指令周期、机器周期和时钟周期的概念及其关系：
     - 指令周期：执行一条指令所需的全部时间。
     - 机器周期：完成一个基本操作所需的时间。
     - 时钟周期：计算机主频的倒数，是计算机的基本时间单位。
     - 关系：指令周期由多个机器周期组成，机器周期由多个时钟周期组成。

  3. 微指令的概念及其与普通指令的关系：
     - 微指令：构成机器指令的基本元素，用于控制CPU的操作。
     - 关系：微指令是更底层的控制指令，多条微指令组成一条机器指令。

  4. 指令流水线的概念及其优势：
     - 指令流水线：将指令执行过程分解为多个阶段，实现指令重叠执行。
     - 优势：提高CPU的利用率和指令执行效率，提升系统性能。

</details>

# CPU的功能和基本结构  

## CPU的功能  

- 中央处理器（CPU）由运算器和控制器组成
  - 控制器的功能是负责协调并控制计算机各部件执行程序的指令序列
  - 运算器的功能是对数据进行加工
- CPU的具体功能包括：
  - 指令控制：完成取指令（也称取指）、分析指令和执行指令的操作，即程序的顺序控制
  - 操作控制：产生完成一条指令所需的操作信号，把各种操作信号送到相应的部件，从而控制这些部件按指令的要求正确执行
  - 时间控制：严格控制各种操作信号的出现时间、持续时间及出现的时间顺序
  - 数据加工：对数据进行算术和逻辑运算
  - 中断处理：对运行过程中出现的异常情况和中断请求进行处理

## CPU的基本结构  

- 在计算机系统中，CPU主要由运算器和控制器两大部分组成［也可将CPU分为数据通路（见5.3节）和控制部件两大组成部分]，如图5.1所示

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/4b9660fe8f486ff3097ffb4d9a7cf8d43ce70d8af78ba631a7eee723b6a34fa0.jpg)  
图5.1中央处理器的组成  

### 运算器  

- 运算器主要组成：
  - 算术逻辑单元（ALU）
  - 暂存寄存器
  - 累加寄存器（ACC）
  - 通用寄存器组（GPRs）
  - 程序状态字寄存器（PSW）
  - 移位寄存器
  - 计数器（CT）
- 主要功能：
  - 根据控制器送来的命令，对数据执行：
    - 算术运算（加、减、乘、除）
    - 逻辑运算（与、或、非、异或、移位、求补等）
    - 条件测试（用于设置ZF、SF、OF和CF等标志位，作为条件转移的判断条件）

### 控制器  

- 控制器主要组成：
  - 程序计数器（PC）
  - 指令寄存器（IR）
  - 指令译码器（ID）
  - 存储器地址寄存器（MAR）
  - 存储器数据寄存器（MDR）
  - 时序电路
  - 微操作信号发生器
- 主要功能：
  - 执行指令，每条指令的执行是由控制器发出的一组微操作实现的
- 工作原理：
  - 根据以下要素形成当前计算机各部件要用到的控制信号：
    - 指令操作码
    - 指令的执行步骤（微命令序列）
    - 条件信号
  - 计算机整机各硬件系统在这些控制信号的控制下协同运行，产生预期的执行结果
  - 控制器是整个系统的指挥中枢，在控制器的控制下：
    - 运算器、存储器和输入/输出设备等功能部件构成一个有机的整体
    - 根据指令的要求指挥全机协调工作
## CPU的寄存器  

>pro：汇编程序员可见的寄存器（2010、2015、2021）  

- CPU中的寄存器按汇编语言（或机器语言）程序是否可访问，可分为两类：
  - 一类是用户可见寄存器
    - 可对这类寄存器编程，以通过使用这类寄存器减少对主存储器的访问次数
    - 如通用寄存器组（含基址/变址寄存器）、程序状态字寄存器、程序计数器、累加寄存器、移位寄存器
  - 另一类是用户不可见寄存器
    - 对用户是透明的，不可对这类寄存器编程
    - 它们被控制部件使用，以控制CPU的操作
    - 如存储器地址寄存器、存储器数据寄存器、指令寄存器、暂存寄存器

>pro：CPU中各种寄存器的作用（2013）  

### 运算器中的寄存器  

#### 通用寄存器组（GPRs）
- 用于存放操作数（包括源操作数、目的操作数及中间结果）和各种地址信息等，如AX、BX、CX、DX、SP等
- 在指令中要指定寄存器的编号，才能明确是对哪个寄存器进行访问
- SP是堆栈指针，用于指示栈顶的地址

#### 累加寄存器（ACC）
- 它是一个通用寄存器
- 用于暂时存放ALU运算的结果

#### 移位寄存器（SR）
- 不但可用来存放操作数
- 而且在控制信号的作用下，寄存器中的数据可根据需要向左或向右移位

#### 暂存寄存器
- 用于暂存从数据总线或通用寄存器送来的操作数，以便在取出下一个操作数时将其同时送入ALU
- 暂存寄存器对应用程序员是透明的（不可见）

#### 程序状态字寄存器（PSW）
- 保留由算术/逻辑运算指令或测试指令的运行结果而建立的各种状态信息
  - 如溢出标志（OF）
  - 符号标志（SF）
  - 零标志（ZF）
  - 进位标志（CF）等
- 每个标志位通常由一位触发器来保存，这些标志位组合在一起称为程序状态字

### 控制器中的寄存器  

>pro：PC和IR的位数与主存储器空间和指令字长的关系（2016、2021）  

#### 程序计数器（PC）
- 用于指出欲执行指令在主存储器中的存放地址
- 若PC和主存储器均按字节编址，则PC的位数等于主存储器地址位数
- CPU根据PC的内容从主存储器中取指令，然后送入指令寄存器
- 指令通常是顺序执行的，因此PC具有自动加1的功能（这里的"1"是指一条指令的字节数）
- 当遇到转移类指令时，PC的新值由指令计算得到

#### 指令寄存器（IR）
- 用于保存当前正在执行的指令
- IR的位数等于指令字长

#### 存储器地址寄存器（MAR）
- 用于存放要访问的主存储器单元的地址
- MAR的位数等于主存储器地址线数，它反映了最多可寻址的存储单元的个数

#### 存储器数据寄存器（MDR）
- 用于存放向主存储器写入的信息或从主存储器读出的信息
- MDR的位数等于存储字长
- 当CPU和主存储器交换信息时，都要用到MAR和MDR  

# 指令执行过程  

## 指令周期  

### 指令周期的基本概念
- CPU每取出并执行一条指令所需的全部时间称为指令周期，不同指令的指令周期可能不同
- 指令周期通常可用若干机器周期来表示，每个指令周期内的机器周期数可以不等
- 图5.2反映了上述关系
  - 图5.2（a）所示为定长的机器周期
  - 图5.2（b）所示为不定长的机器周期

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/4cdf5401a046fb5fe39af366d76c0d8889d1154a1965f8d7673571ffd1641a97.jpg)  
图5.2指令周期和机器周期的关系  

### 不同指令的周期特点
- 对于无条件转移指令JIMIPX
  - 在执行时不需要访问主存
  - 只包含取指阶段（包括取指和分析）和执行阶段
  - 所以其指令周期仅包含取指周期和执行周期

- 对于间接寻址的指令
  - 为了取操作数，需要先访问一次主存，取出有效地址
  - 然后访问主存，取出操作数
  - 所以还需包括间址周期
  - 间址周期介于取指周期和执行周期之间

- 当CPU采用中断方式实现主机和I/O设备的信息交换时
  - CPU在每条指令执行结束前，都要发中断查询信号
  - 若有中断请求，则CPU进入中断响应阶段，也称中断周期
  - 一个完整的指令周期可包括取指、间址、执行和中断4个周期

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f7ac4456b5579efe301d3c745f4bafd3791739991e765a528a6dd737b49f8fa6.jpg)  
图5.3带有间址周期、中断周期的指令周期  

>pro：指令执行的过程（2011）  

### 指令执行的具体过程
- 当CPU执行指令时
  - 首先进入取指周期
    - 从PC指出的主存单元中取出指令，送至指令寄存器
    - 同时PC加"1"以作为下一条指令的地址
  - 当遇到转移指令等改变执行顺序的指令时
    - 在PC加"1"后会重新计算并更新PC值
  - 然后判断是否有间接寻址
    - 如果有，进入间址周期以获取操作数的有效地址
  - 之后进人执行周期
    - 完成取操作数、执行运算和存操作数的任务
  - 执行周期结束后
    - 如果CPU检测到中断请求，则进入中断周期
      - 需要关中断
      - 保存断点
      - 修改PC值为中断服务程序的入口地址
      - 转向中断服务程序

>attention:  

中断周期中的进栈操作是将SP减"1"，这和传统意义上的进栈操作相反，原因是计算机中的堆栈都是向低地址方向增长，所以进栈操作是减"1"而不是加""。  

## 指令周期的数据流  

### 数据流的基本概念
- 数据流是根据指令要求依次访问的数据序列
- 在指令执行的不同阶段，要求依次访问的数据序列是不同的
- 对于不同的指令，它们的数据流往往也是不同的

### 取指周期  
#### 取指周期的任务
- 根据PC中的内容从主存中取出指令代码并存放在IR中

#### 取指周期的数据流
- PC中存放的是指令的地址
- 根据此地址从内存单元中取出的是指令，并放在指令寄存器IR中
- 取指令的同时，PC加1

#### 取指周期的数据流向
1. PC  $\circledast$  MAR②地址总线存储器
2. CU发出读命令控制总线 $\circeq$ 存储器
3. 主存 $\circeq$ 数据总线 $\nsupseteq$ MDR $\circledast$ IR（存放指令）
4. CU发出控制信号PC内容加1

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f75084f25f382c3b663c9acfe77f401b2ea0ef4abcdf6fe2e458bbf2de1010ae.jpg)  
图5.4取指周期的数据流  

### 间址周期  
#### 间址周期的任务
- 取操作数有效地址
- 以一次间址为例
  - 将指令中的地址码送到MAR并送至地址总线
  - CU向存储器发出读命令，以获取有效地址并存至MDR

#### 间址周期的数据流向
1. Ad（IR）（或MDR） $\circledast$ MAR $\circeq$ 地址总线存储器
2. CU发出读命令控制总线存储器
3. 主存数据总线 $\nsupseteq$ MDR（存放有效地址）

其中，Ad（IR）表示取出IR中存放的指令字的地址字段。

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/a85b790d202f2b82ad10656f53199f418770f4c117771fe30b596a329d044671.jpg)  
图5.5一次间址周期的数据流  

### 执行周期  
- 执行周期的任务是取操作数，并根据IR中的指令字的操作码通过ALU操作产生执行结果
- 不同指令的执行周期操作不同，因此没有统一的数据流向

### 中断周期  
#### 中断周期的任务
- 处理中断请求
- 假设程序断点存入堆栈中
- 用SP指示栈顶地址
- 进栈操作是先修改栈顶指针，后存入数据

#### 中断周期的数据流向
1. CU控制将SP减1，SP $\circeq$ MAR②地址总线存储器
2. CU发出写命令 $\underline{{\boldsymbol{\mathfrak{A}}}}$ 控制总线 $\circeq$ 存储器
3. PCMDR $\nsupseteq$ 数据总线 $\circeq$ 主存（程序断点存入存储器）
4. CU（中断服务程序的入口地址）PC

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/c5e774da7c287935949863c45b6d8ed1c27c81c7ecb099690202cb499289d6e4.jpg)  
图5.6中断周期的数据流

## 指令执行方案  

一个指令周期通常要包括几个执行步骤，每个步骤完成指令的一部分功能，几个依次执行的步骤完成这条指令的全部功能。不同的处理器采用不同的方案来安排指令的执行步骤。  

>pro：单周期和多周期CPU的CPI（2020）  

### 单周期处理器  

>pro：单周期CPU的特点（2016）  

#### 特点
- 对所有指令都选用相同的执行时间来完成
- 每条指令都在一个时钟周期内完成（即 ${\mathrm{CPI}}=1$ ）
- 指令之间串行执行
  - 下一条指令只能在前一条指令执行结束后才能启动
- 指令周期取决于执行时间最长的指令的执行时间
  - 对于那些本来可以在更短时间内完成的指令，仍要使用这个较长的周期来完成
  - 会降低整个系统的运行速度

### 多周期处理器  

#### 执行特征
- 对不同类型的指令选用不同的执行步骤
- 指令需要几个周期就为其分配几个周期
  - 可选用不同个数的时钟周期来完成不同指令的执行过程（即 $\mathrm{CPI}>1)$ 
  - 不再要求所有指令占用相同的执行时间
- 多指令周期方案中指令之间仍是串行执行

### 流水线处理器  

#### 执行方式
- 采用指令之间并行执行的方案
- 追求的目标是力争在每个时钟周期完成一条指令的执行过程
  - 只在理想情况下才能达到该效果，此时 ${\mathrm{CPI}}=1$ 
- 通过在每个时钟周期启动一条指令
  - 尽量让多条指令同时运行
  - 但各自处在不同的执行步骤中  

# 数据通路的功能和基本结构  

## 数据通路的功能  
- CPU的组成：
  - 随着技术发展，更多功能逻辑集成到CPU芯片中。
  - 不论CPU内部结构多复杂，它主要由数据通路和控制部件组成。

>pro：数据通路的组成部件（2017、2021）

- 数据通路的定义与作用：
  - 数据在指令执行过程中的路径及其经过的部件。
  - 包括ALU、通用寄存器、状态寄存器、异常和中断处理逻辑等。
  - 数据通路描述信息流动的起点、中间经过的部件和终点。
  - 数据通路由控制部件控制，根据指令功能生成控制信号。


## 数据通路的组成  

- 组成数据通路的元件主要分为组合逻辑元件和时序逻辑元件两类。

>pro：数据通路中的组合逻辑元件和时序逻辑元件（2021、2023）  

### 组合逻辑元件（操作元件）  

- 任何时刻产生的输出仅取决于当前的输入。
  - 组合电路不含存储信号的记忆单元，也不受时钟信号的控制，输出与输入之间无反馈通路，信号是单向传输的。
- 数据通路中常用的组合逻辑元件有加法器、算术逻辑单元（ALU）、译码器、多路选择器、三态门等，如图。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/96308c858ff5f7964125d669141286fa1586d651484b7c7042c3ce73a05e35c4.jpg)  
图5.7数据通路中的几种常用组合逻辑元件  

- 图中虚线表示控制信号，译码器可用于操作码或地址码译码， $n$ 位输入对应 $2^{n}$ 种不同组合，因此有 $2^{n}$ 个不同输出。
- 多路选择器（MUX）需要控制信号Select来确定选择哪个输入被输出。
- 三态门可视为一种控制开关，由控制信号EN决定信号线的通断
  - 当 $\mathrm{EN}=1$ 时，三态门被打开，输出信号等于输入信号
  - 当 $\mathrm{EN}\,=\,0$ 时，输出端呈高阻态（隔断态），所连寄存器与总线断开

### 时序逻辑元件（状态元件）  

- 时序电路的特点：
  - 输出与当前输入和以前输入都有关。
  - 包含存储信号的记忆单元。

- 时序电路的工作条件：
  - 必须在时钟节拍下工作。

- 时序逻辑元件的例子：
  - 各类寄存器和存储器。
  - 包括通用寄存器组、程序计数器、状态/移位/暂存/锁存寄存器等。
 

## 数据通路的基本结构  

### CPU内部单总线方式  

>pro：数据通路中的部件及连接方式（2013、2015、2022）  

- 将ALU及所有寄存器都连接到一条内部公共总线上，称为单总线结构的数据通路。
  - 这种结构比较简单，但数据传输存在较多的冲突现象，性能较低。
  - 此总线在CPU内部，注意不要把它与连接CPU、存储器和外设的系统总线相混淆。
- 图5.8所示为单总线的数据通路和控制信号。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/0161e7b16de00d520d62405d382e730a37430111a550273cdc1cb28934a907c8.jpg)  
图5.8单总线的数据通路和控制信号  

>pro：数据通路中的三态门及其作用（2015）  

- 在图5.8中：
  - GPRs为通用寄存器组，rs、rd分别为所读、写的通用寄存器的编号
  - Y和Z为暂存器
  - FR为标志寄存器，用于存放ALU产生的标志信息
  - 带箭头的虚线表示控制信号
    - 字母加"in"表示该部件充许写入
    - 字母加"out"表示该部件充许输出
  - MDRin表示内部总线上信息写入MDR，MDRout表示MDR的内容送入内部总线
  - 能输出到总线的部件均通过一个三态门与内部总线相连，用于控制该部件与内部总线之间数据通路的连接与断开

>attention:  
单周期处理器（ $\mathrm{CPI}=1$ ）不能采用单总线方式，因为单总线将所有寄存器都连接到一条公共总线上，一个时钟内只允许一次操作，无法完成一条指令的所有操作。  

### CPU内部多总线方式  

- CPU内部有两条或更多的总线时，构成双总线结构或多总线结构。
  - 将所有寄存器的输入端和输出端都连接到多条公共通路上
  - 相比之下单总线中一个时钟内只充许传送一个数据，因而指令执行效率很低
  - 因此采用多总线方式，同时在多个总线上传送不同的数据，提高效率

>pro：单周期CPU的特点（2016）  

### 专用数据通路方式  

- 根据指令执行过程中的数据和地址的流动方向安排连接电路
  - 避免使用共享的总线
  - 性能较高，但硬件量大

>attention:  内部总线是指同一部件，如CPU内部连接各寄存器及运算部件之间的总线；系统总线是指同一台计算机系统的各部件，如CPU、内存和各类I/O接口间互相连接的总线。  

## 数据通路的操作举例  

- 总线是一组共享的传输信号线
  - 它不能存储信息
  - 任一时刻也只能有一个部件把信息送到总线上
- 下面以图5.8所示的单总线数据通路为例，介绍一些常见操作的流程及控制信号

>pro：指令执行的节拍及有效控制信号（2009、2015）：指令在取数和执行阶段所用到的部件（2019）  

### 通用寄存器之间传送数据  

- 在寄存器和总线之间有两个控制信号：Rin和Rout
  - 当Rin有效时，控制将总线上的信息存到寄存器R中
  - 当Rout有效时，控制将寄存器R的内容送至总线
- 下面以程序计数器PC为例，将PC的内容送至MAR。实现该操作的流程及控制信号为
  - (PC)→MARPC out MARin，PC内容→MAR  

### 从主存读取数据  

>pro：取指令阶段所需时钟周期分析（2022）  

- 从主存中读取的信息可能是数据或指令，现以CPU从主存中取指令为例，说明数据在单总线数据通路中的传送过程。实现该操作的流程及控制信号为：
  - （PC）→MARPC out MARin，现行指令地址→MAR
  - MEM（MAR)→MDR，（PC)+1→PCMDRin有效，CU发出读命令，取出指令后PC+1
  - (MDR）→IR MDR out IR in，现行指令→IR  
- 第一步，将PC的内容通过内部总线送至MAR，需要1个时钟周期
- 第二步，CU向主存发出读命令，从MAR所指主存单元读取一个字，并送至MDR；同时PC加1为取下一条指令做准备，需要1个主存周期
- 第三步，将MDR的内容通过内部总线送至IR，需要1个时钟周期

### 将数据写入主存  

- 将寄存器R1的内容写入寄存器R2所指的主存单元，完成该操作的流程及控制信号为：
  - (R1)→MDR Rl out MDR in
  - (R2)→MAR R 2 out MARin
  - MDR→MEM(MAR)MDRout有效，CU发出写命令  

### 执行算术或逻辑运算  

> pro: ALU中设置暂存器的原因（2015、2022）  

- 在单总线数据通路中：
  - 每一时刻总线上只有一个数据有效
  - 由于ALU是一个没有存储功能的组合逻辑元件，在其执行运算时必须保持两个输入端同时有效
    - 因此先将一个操作数经内部总线送人暂存器Y保存，Y的内容在ALU的左输入端始终有效
    - 再将另一个操作数经内部总线直接送到ALU的右输入端
  - ALU的输出端也不能直接与总线相连，否则其输出会通过总线反馈到输入端，影响运算结果
    - 因此将运算结果暂存在暂存器乙中
- 假设加法指令ADDACC，R1，实现将ACC的内容和R1的内容相加并写回ACC，完成该操作的流程及控制信号为：
  - (R1)→Y Rl out Yin，操作数→Y
  - (ACC)  $^+$  (Y）→Z ACC out ALU in，CU ALU，结果→Z
  - (Z)→ACC Z out ACC in，结果→ACC  

>pro：分析减法和自增指令执行所需的时钟周期数（2015）  

- 以上3步不能同时执行，否则会引起总线冲突，因此该操作需要3个时钟周期  

### 修改程序计数器的值  

- 转移指令的作用：
  - 通过修改程序计数器PC的值实现程序的跳转。

- 转移指令JIMPaddr的操作：
  - 假设转移指令为JIMPaddr，其中addr是目标转移地址。
  - 操作流程：将指令寄存器IR中的地址字段写入PC。
  - 控制信号：Ad(IR)→PC, IR out, PC in。

- 数据通路结构的影响：
  - 直接影响CPU内各种信息的传送路径。
  - 数据通路不同，指令执行过程的微操作序列安排也不同。
  - 影响微操作信号形成部件的设计。


# 控制器的功能和工作原理  

## 控制器的结构和功能  

### 控制器的连接关系
- 从图5.9可以看到计算机硬件系统的五大功能部件及其连接关系
  - 它们通过数据总线、地址总线和控制总线连接在一起
  - 其中点画线框内的是控制器部件

#### 主要连接关系说明
- 运算器部件通过数据总线与内存储器、输入设备和输出设备传送数据
- 输入设备和输出设备通过接口电路与总线相连接  
- 内存储器、输入设备和输出设备
  - 从地址总线接收地址信息
  - 从控制总线得到控制信号
  - 通过数据总线与其他部件传送数据
- 控制器部件
  - 从数据总线接收指令信息
  - 从运算器部件接收指令转移地址
  - 送出指令地址到地址总线
  - 向系统中的部件提供运行所需的控制信号

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/d13488b4b74cc2530f08d0235bb3404b2df25c7b14a7a83dd5306035c33dd080.jpg)  
图5.9计算机硬件系统和控制器部件的组成  

### 控制器的功能
- 作为计算机系统的指挥中心，主要功能包括：
  - 从主存中取出指令，并指出下一条指令在主存中的位置
  - 对指令进行译码或测试，产生相应的操作控制信号
  - 指挥并控制CPU、主存、输入设备和输出设备之间的数据流动方向

### 控制器的分类
- 根据产生微操作控制信号的方式，分为：
  - 硬布线控制器
  - 微程序控制器
- 两类控制器的异同：
  - 相同点：PC和IR相同
  - 不同点：确定和表示指令执行步骤的办法及控制信号的给出方案不同

## 硬布线控制器  

### 基本概念
- 由复杂的组合逻辑门电路和触发器构成
- 也称组合逻辑控制器
- 工作原理：根据指令要求、当前时序及内外部状态，按时间顺序发送微操作控制信号

### 控制单元结构
- 指令操作码的作用
  - 决定CU发出不同控制信号的关键
  - 通过译码电路将n位操作码产生2^n个输出
  - 每种操作码对应一个输出送至CU

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/d2f55e758d9c494275dac108e2cae6bca95b683e62055bdffc92ff9c328afb53.jpg)  
图5.10带指令译码器和节拍输入的控制单元框图  

### 控制单元输入信号
- 指令信息
  - 经指令译码器译码产生
  - 操作码决定执行周期的不同操作
  - 与时钟配合产生不同控制信号
- 时序系统信号
  - 包括机器周期信号和节拍信号
  - 控制单元需要时钟控制以有序发出控制信号
- 执行单元反馈信息
  - 包括各种标志
  - 用于根据CPU当前状态产生控制信号

### 硬布线控制器特点
- 优点：
  - 速度快，主要取决于电路延迟
  - 适用于高速计算机CPU和RISC架构
- 缺点：
  - 控制信号实现复杂
  - 修改或增加指令需重新设计电路
  - 指令系统越全，电路越庞杂
  - 调试困难

## 微程序控制器  

微程序控制器采用存储逻辑实现，也就是将微操作信号代码化，使每条机器指令转化成为一段微程序并存入一个专门的存储器（控制存储器）中，微操作控制信号由微指令产生。  

### 微程序控制的基本概念  

#### 基本思想与术语
- 微程序的设计思想：
  - 将每条机器指令编写成一个微程序
  - 每个微程序包含若干微指令
  - 每条微指令对应一个或几个微操作命令
  - 执行指令即执行微程序的过程
  - 这些微程序存储在控制存储器中
  - 目前大多数计算机采用此技术

##### 微命令与微操作
- 微命令：
  - 控制部件向执行部件发出的各种控制命令
  - 是构成控制序列的最小单位
  - 例如：打开/关闭控制门、寄存器打入脉冲
- 微操作：
  - 执行部件收到微命令后进行的操作
  - 与微命令一一对应
- 微命令分类：
  - 相容性微命令：可同时出现完成某些微操作
  - 互斥性微命令：不允许同时出现

>attention:  
硬布线控制器中也有微命令与微操作的概念，并非微程序控制器的专有概念。  

##### 微指令与微周期
- 微指令组成：
  - 操作控制字段（微操作码字段）：产生操作控制信号
  - 顺序控制字段（微地址码字段）：控制下一条微指令地址
- 微周期：
  - 取出并执行一条微指令所需的全部时间
  - 通常为一个时钟周期

##### 主存储器与控制存储器
>pro：主存储器和控制存储器的区别（2017）  
- 主存储器：
  - 用途：存放程序和数据
  - 位置：CPU外部
  - 实现：用RAM
- 控制存储器：
  - 用途：存放微程序
  - 位置：CPU内部
  - 实现：用ROM
  - 单元地址称为微地址

##### 程序与微程序
- 程序：
  - 指令的有序集合
  - 完成特定功能
  - 由软件设计人员编制
  - 存放在主存或辅存中
- 微程序：
  - 微指令的有序集合
  - 描述机器指令
  - 是指令的实时解释器
  - 由计算机设计者编制
  - 存放在控制存储器中
  - 对程序员透明

##### 相关寄存器区分
- 地址寄存器（MAR）：存放主存读/写地址
- 微指令地址寄存器（μPC或CMAR）：存放待执行微指令的微地址
- 指令寄存器（IR）：存放从主存读出的指令
- 微指令寄存器（μIR或CMIDR）：存放从控制存储器读出的微指令

### 微程序控制器的组成和工作过程  

#### 基本组成
- 主要部件：
  - 起始和转移地址形成部件：
    - 产生初始和后继微地址
    - 保证微指令连续执行
  - 微指令地址寄存器：
    - 接收微地址
    - 为读取微指令做准备
  - 控制存储器：
    - 核心部件
    - 存放各指令对应的微程序
  - 微指令寄存器：
    - 位数等于微指令字长

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/99c89003cac2ee2ef59dde11e4b8aa32720bdbcf83de761ecb39fd778d602223.jpg)  
图5.11微程序控制器的基本结构  

#### 工作过程
- 执行机器指令的过程：
  1. 执行取指令公共操作：
     - 将取指微程序入口地址送入μPC
     - 从CM读出微指令送入μIR
     - 完成后机器指令存入指令寄存器
  2. 产生微程序入口地址：
     - 由机器指令操作码通过微地址形成部件产生
     - 送入μPC
  3. 执行微指令：
     - 从CM逐条取出
     - 依次执行
  4. 循环执行：
     - 完成一条机器指令后返回取指入口
     - 重复以上步骤直到程序结束

#### 微程序和机器指令关系
- 对应关系：
  - 一条机器指令对应一个微程序
  - 公共操作可统一编程：
    - 取指令操作微程序
    - 间址周期微程序
    - 中断周期微程序
- 控制存储器内容：
  - 机器指令对应的微程序
  - 公共操作的微程序

### 微指令的编码方式  

#### 编码概述
- 目的：
  - 保证速度的情况下缩短微指令字长
- 作用：
  - 对微指令控制字段编码
  - 形成控制信号

##### 直接编码方式
- 特点：
  - 无须译码
  - 每位代表一个微命令
  - 1/0表示选用/不选用
- 优点：
  - 简单直观
  - 执行速度快
  - 操作并行性好
- 缺点：
  - 微指令字长过长
  - 控制存储器容量大

##### 字段直接编码方式
>pro：字段直接控制的编码方法（2012）  
- 基本方法：
  - 操作控制字段分成若干小字段
  - 互斥性微命令在同一字段
  - 相容性微命令在不同字段
  - 每个字段独立编码
  - 各字段编码含义单独定义

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/c6e197e941e2f1058a37b511cbaa37823f47acc90dd408d7e4f2e9e15c655007.jpg)  
图5.12直接编码方式  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/a8f2b917f211c35fb07f59a18310c4809c207a77d2f9e952f169ab68cecd9625.jpg)  
图5.13字段直接编码方式  

- 分段原则：
  - 互斥性微命令分在同一段
  - 相容性微命令分在不同段
  - 每段信息位不能太多
  - 每段留出不操作状态（通常000）

##### 字段间接编码方式
- 特点：
  - 一个字段的微命令由另一字段解释
  - 非直接译码发出微命令
  - 也称隐式编码
- 优缺点：
  - 优点：进一步缩短微指令字长
  - 缺点：削弱并行控制能力
  - 用途：作为字段直接编码的辅助手段

### 微指令的地址形成方式  

后继微地址的形成主要有以下几个基本类型：  

#### 后继地址字段指出
- 在微指令格式中设置一个后继地址字段
- 由微指令的后继地址字段直接指出后继微指令的地址
- 这种方式也称断定方式

#### 机器指令操作码形成
- 当机器指令取自指令寄存器后
- 微指令的地址由操作码经微地址形成部件形成
- 该部件输出的是对应机器指令微程序的首地址

#### 增量计数器法
- 即 $(\mu\mathrm{PC})+1{\rightarrow}\mu\mathrm{PC}$
- 适用于后继微指令地址是连续的情况

#### 标志决定分支转移
- 根据各种标志决定下一条微指令分支转移的地址

#### 硬件直接产生
- 电源加电后，第一条微指令的地址可由专门的硬件电路产生
- 并送至 $\mu\mathrm{PC}$
- 这个地址即为取指周期微程序的入口地址

### 微指令的格式  

微指令格式与微指令的编码方式有关，通常分为水平型微指令和垂直型微指令两种。  

>pro： 微指令后继地址字段位数与微指令条数的关系（2014）  

#### 水平型微指令
- 编码方式特点：
  - 直接编码、字段直接编码和字段间接编码都属于水平型微指令
- 基本指令格式：
  - 如图5.14所示
  - 指令字中的一位对应一个控制信号
  - 有输出时为1，否则为0
  - 一条水平型微指令定义并执行多个并行操作的微命令

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/b2aedaa58c557759dbd6b0fe7d9c754a7d34a84fc4317965518d9de55c2fb6a1.jpg)  

- 优缺点：
  - 优点：微程序短，并行能力强，执行速度快
  - 缺点：微指令长，编写微程序较麻烦

#### 垂直型微指令
- 基本特点：
  - 采用类似机器指令操作码的方式
  - 在微指令字中设置微操作码字段
  - 基本格式如图5.15所示
  - 一条垂直型微指令通常只能定义并执行一种微命令

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/7065d0c6793931c03ff4fb46419e81a29e8a05e3dc173555b1f656c5aa397918.jpg)  

- 优缺点：
  - 优点：微指令短、简单、规整，便于编写微程序
  - 缺点：微程序长，执行速度慢，效率低

#### 水平型与垂直型对比
- 并行操作能力：
  - 水平型：强、效率高、灵活性强
  - 垂直型：较差
- 执行时间：
  - 水平型：短
  - 垂直型：长
- 微程序特点：
  - 水平型：微指令字较长但微程序短
  - 垂直型：相反
- 掌握难度：
  - 水平型：难以掌握
  - 垂直型：与机器指令比较相似，相对容易掌握

### 硬布线和微程序控制器的特点  

>pro：硬布线控制器和微程序控制器的特点（2009）  

#### 硬布线控制器特点
- 优点：
  - 由于控制器的速度取决于电路延迟，所以速度快
- 缺点：
  - 由于将控制部件视为专门产生固定时序控制信号的逻辑电路
  - 把用最少元件和取得最高速度作为设计目标
  - 一旦设计完成，就不可能通过其他额外修改添加新功能

#### 微程序控制器特点
- 优点：
  - 具有规整性、灵活性和可维护性
- 缺点：
  - 由于采用了存储程序原理
  - 每条指令都要从控制存储器中取一次，影响速度

#### 对比总结
为便于比较，下面以表格的形式对比二者的不同，见表5.1。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/5758d88c281f323689f1a57cbe9859540b34d296985c6fd404c91be129bd19f0.jpg)


# 异常和中断机制  

现代计算机中都配有完善的异常和中断处理系统，CPU的数据通路中有和应的异常检测和响应逻辑，外设接口中有相应的中断请求和控制逻辑，操作系统中有相应的中断服务程序。这些中断硬件电路和中断服务程序有机结合，共同完成异常和中断的处理过程。  

## 基本概念  

>pro： 异常事件的性质（2015）  

### 异常和中断的定义
- 异常（内中断）
  - 由CPU内部产生的意外事件
- 中断（外中断）
  - 来自CPU外部的设备向CPU发出的中断请求
  - 通常用于信息的输入和输出
- 区别特点
  - 异常：CPU执行指令时内部检测到的同步事件
  - 中断：外部设备触发的异步事件

>pro：异常响应的时机（2023）  

### 异常和中断处理过程
- 触发条件
  - 执行第i条指令时检测到异常
  - 执行第i条指令后发现中断请求
- 处理流程
  - CPU打断当前程序
  - 转执行异常/中断处理程序
- 处理结果
  - 成功解决
    - 通过异常/中断返回指令
    - 回到第i条或i+1条指令继续执行
  - 致命错误
    - 终止用户程序
- 处理方式：通常由操作系统和驱动程序完成

## 分类  

### 异常的分类  
- 硬故障中断
  - 硬连线异常引起
    - 存储器校验错
    - 总线错误
- 程序性异常（软件中断）
  - 执行指令引起的异常
    - 整除0
    - 溢出
    - 断点
    - 单步跟踪
    - 非法指令
    - 栈溢出
    - 地址越界
    - 缺页

#### 按发生原因和返回方式分类

##### （1）故障（Fault）  

>pro：异常或中断处理后指令重新执行的断点（2021）  

- 检测时机：指令启动后、执行结束前
- 常见故障
  - 非法操作码
  - 缺段/缺页
  - 除数为0
- 处理方式
  - 可恢复故障
    - 如缺段/缺页：调入所需段/页面后返回故障指令
  - 不可恢复故障
    - 如非法操作码/除数为0：终止进程执行

##### (2）自陷（Trap）  

>pro：自陷的原理和性质（2020）  

- 定义：预先安排的"异常"事件
- 实现方式
  - 特殊指令
  - 特殊控制标志
- 处理流程
  - 执行完自陷指令
  - 根据类型进行处理
  - 返回下一条指令（非转移指令）
  - 返回转移目标指令（转移指令）
- 应用实例
  - x86程序调试
  - 系统调用指令
  - 条件自陷指令

##### （3）终止（Abort）  
- 触发条件：无法继续执行的硬件故障
  - 控制器出错
  - 存储器校验错
  - 总线错误
- 特点
  - 非特定指令产生
  - 随机发生
- 处理方式：调出异常服务程序重启系统

### 中断的分类  

>pro：对中断和异常事件的判断（2009、2016、2020）  

#### 基本概念
- 定义：CPU外部、与指令无关的事件
- 来源
  - I/O设备中断
  - 特殊事件
- 处理机制
  - 通过中断请求信号线
  - 指令执行完后检查

#### 按可屏蔽性分类

##### （1）可屏蔽中断  
- 通过INTR请求线发出
- 可通过屏蔽字控制

##### （2）不可屏蔽中断  
- 通过NMI请求线发出
- 用于紧急硬件故障
- 不可被屏蔽

#### 中断和异常的区别
1. 关联性
   - 异常：与特定指令相关
   - 中断：与指令无关
2. 检测方式
   - 异常：CPU自身完成
   - 中断：需通过中断请求线

#### 其他分类方式
- 按识别服务程序地址方式
  - 向量中断
  - 非向量中断
- 按处理过程是否允许打断
  - 单重中断
  - 多重中断

## 异常和中断响应过程  

### 响应过程概述
- CPU执行指令时，如果发生了异常或中断请求，必须进行相应的处理
- 从CPU检测到异常或中断事件，到调出相应的处理程序，整个过程称为异常和中断响应
- CPU对异常和中断响应的过程可分为以下三个阶段

### 响应过程详解

#### 1. 关中断  
- 在保存断点和程序状态期间，不能被新的中断打断
- 实现方式：
  - 通过设置"中断允许"（IF）触发器
  - IF=1：开中断，允许响应中断
  - IF=0：关中断，不允许响应中断

#### 2. 保存断点和程序状态  
- 断点（返回地址）保存
  - 送到栈或特定寄存器中
  - 通常保存在栈中以支持异常或中断的嵌套
- 程序状态保存
  - 被中断时的程序状态字寄存器PSW内容需保存
  - 保存位置：栈或特定寄存器
  - 目的：异常和中断返回时恢复到PSW中

#### 3. 识别异常和中断并转到相应的处理程序  
- 识别方式分类
  - 软件识别方式
    - CPU设置异常状态寄存器记录异常原因
    - 使用统一的异常或中断查询程序
    - 按优先级顺序查询异常状态寄存器
    - 检测异常和中断类型
  - 硬件识别方式（向量中断）
    - 中断向量：异常或中断处理程序的首地址
    - 中断向量表存放所有中断向量
    - 每个异常或中断指定一个中断类型号
    - 类型号和中断向量一一对应

### 响应过程特点
- 整个响应过程是不可被打断的
- 处理流程：
  - 响应过程结束后，CPU从PC中取出对应中断服务程序的第一条指令开始执行
  - 执行直至中断返回
  - 由CPU通过执行中断服务程序完成
  - 整个中断处理过程是由软/硬件协同实现的
 

# 指令流水线  

前面介绍的指令都是在单周期处理机中采用串行方法执行的，同一时刻CPU中只有一条指令在执行，因此各功能部件的使用率不高。现代计算机普遍采用指令流水线技术，同一时刻有多条指令在CPU的不同功能部件中并发执行，大大提高了功能部件的并行性和程序的执行效率。  

## 基本概念

### 并行性提升方法
- 时间上的并行技术
  - 将任务分解为不同子阶段
  - 每个子阶段在不同功能部件上并行执行
  - 同一时刻可执行多个任务
  - 这种方法称为流水线技术
- 空间上的并行技术
  - 在处理机内设置多个执行相同任务的功能部件
  - 让这些功能部件并行工作
  - 这样的处理机称为超标量处理机

### 指令执行阶段
- 一条指令的执行过程可分解为若干阶段
- 每个阶段由相应的功能部件完成
- 将各阶段视为相应的流水段，构成指令流水线
- 5个基本阶段：
  - 取指（IF）：从指令存储器或Cache中取指令
  - 译码/读寄存器（ID）：操作控制器译码，从寄存器堆取操作数
  - 执行/计算地址（EX）：执行运算或计算地址
  - 访存（MEM）：对存储器进行读/写操作
  - 写回（WB）：将执行结果写回寄存器堆

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/4e4d3b2fd28bf010d15ebe5c04890299db4e9d522cfa5616dd58c870df156a3c.jpg)  

>pro：流水线对指令集的要求（2011）  

### 指令集要求
- 指令长度一致性
  - 应尽量保持一致
  - 有利于简化取指令和译码操作
  - 避免取指时间不一致导致部件复杂
- 指令格式规整性
  - 源寄存器位置应保持相同
  - 便于在指令未知时取寄存器操作数
- LOAD/STORE型指令设计
  - 其他指令不访问存储器
  - 有利于规整地址计算和运算步骤
- 存储对齐要求
  - 数据和指令需"按边界对齐"存放
  - 有利于减少访存次数

## 基本实现  

### 设计原则  
- 单周期实现特点
  - 不是所有指令都需要5个阶段
  - 时钟周期取决于最慢指令
  - 时钟频率受限于最长数据通路

>pro：流水线时钟周期的设计（2009）  

#### 流水线设计基本原则
- 流水段个数原则
  - 以最复杂指令所需功能段个数为准
- 流水段长度原则
  - 以最复杂操作所需时间为准
- 时间分析示例
  - 各阶段时间：
    - 取指：200ps
    - 译码：100ps
    - 执行：150ps
    - 访存：200ps
    - 写回：100ps
  - 执行效率比较：
    - 串行执行：N×750ps
    - 流水线执行：(N+4)×200ps

### 逻辑结构  
- 流水段寄存器设计
  - 每个流水段后增加流水段寄存器
  - 用于锁存本段处理完的数据
  - 确保结果可用于下一周期
- 时钟同步机制
  - 采用统一时钟CLK
  - 每个时钟周期：
    - 处理完的数据锁存到段寄存器
    - 接收前段传递的数据

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/15dad3e9b41ca386ed07524528163648ddba3b917ff3c224e8e9b044083935c5.jpg)  

>attention:  

在考试中，若没有明确说明，则可以不用考虑流水寄存器的时延。  

### 时空图表示  
- 时空图基本概念
  - 用于直观描述流水线执行情况
  - 横坐标：表示时间，分割为等长时间段T
  - 纵坐标：表示指令所处功能部件

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/8f92b2589c2fe4694603f3c9894919d540ed16f5065d6218d79024a19ab46846.jpg)  

>pro：流水线执行4条指令所需的时钟周期数（2012）  

#### 流水线性能分析
- 执行效率比较
  - 流水线方式：时刻10T有6条指令完成
  - 串行方式：时刻10T仅2条指令完成
- 适用场景
  - 适合连续任务执行
  - 特别适合指令执行
  - 浮点运算流水线仅适合运算密集型应用

## 冒险与处理  

>pro：导致流水线阻塞的各种原因（2010）  

在指令流水线中，可能会遇到一些情况使得后续指令无法正确执行而引起流水线阻塞，这利现象称为流水线冒险。根据导致冒险的原因不同分为结构冒险、数据冒险和控制冒险3种。  

不同类型指令在各流水段的操作是不同的，表5.2中列出了几类指令在各流水段中的操作。  
表5.2不同类型指令在各流水段中的操作
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/0e6ae322ef1d230d3622eda619a0b7d751d40c5ad99cf6bbc3f88c1bdf5ad624.jpg)  

这几类指令将会在下面介绍流水线冲突时涉及。  

### 结构冒险  

>pro：解决结构冒险的办法（2016）  

- 定义：由不同指令在同一时刻争用同一功能部件而形成的冲突
  - 也称资源冲突
  - 由硬件资源竞争造成

- 示例：指令和数据存放在同一存储器引发的冲突
  - 第i条LOAD指令MEM段访存与第i+3条指令F段取指令同时发生
  - 解决方法：暂停后一条指令操作一个时钟周期

- 解决方案：
  1. 暂停策略
     - 前一指令访存时，暂停后续相关指令一个时钟周期
  2. 硬件冗余
     - 设置多个独立部件
     - 如：寄存器读写口独立
     - 如：数据存储器和指令存储器分离
     - 现代Cache采用数据Cache和指令Cache分离

### 数据冒险  

>pro：分析指令之间的数据冒险（2012、2014、2016、2019、2023）  

#### 基本概念
- 定义：后面指令用到前面指令的结果时，前面指令的结果还没有产生
- 主要类型：写后读（RAW）冲突
  - 发生在前面指令写结果之前，后面指令需要读取时

>attention:  

在按序执行的流水线中（统考中通常采用这种方式），只可能出现RAW冲突。

#### RAW冲突示例
- 指令序列：
  
  I1: add R1,R2,R3  #（R2）+（R3）→R1
  I2: sub R4,R1,R5  #（R1)-（R5）→R4
  
- 冲突原因：
  - I2的源操作数是I1的目的操作数
  - 流水线重叠导致读写顺序改变

表5.4add和sub指令发生先写后读（RAW）冲突
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/416a1a3afa37aaf5df2546bab8ffd540b1a22415785989ec06871e8242ff2a92.jpg)  

#### 解决方案

##### 1. 延迟执行相关指令
- 实现方式：
  - 软件插入空操作"nop"指令
  - 硬件阻塞(stall)
- 优化方法：
  - 寄存器读写时间控制
    - 前半周期写入
    - 后半周期读出

表5.5用延迟相关指令的办法来解决RAW冲突
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/83b58f5125520e327f2952f138d8b8e3e1c011a0b53539439425dabca2d3aec6.jpg)  

##### 2. 转发(旁路)技术
- 工作原理：
  - 设置相关转发通路
  - 直接使用中间数据
  - 避免等待写回寄存器

表5.6用转发技术来解决RAW冲突
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/6e66822789ad2aac996fbfbdb4f43c39d585688d099743e0d47d9ac80812a914.jpg)  

##### 3. load-use数据冒险处理
- 问题特点：
  - load指令与紧邻运算指令存在数据相关
  - 无法通过转发技术解决
- 解决方法：
  - 编译器插入nop指令
  - 程序编译时优化指令顺序

表5.7用延迟加转发技术来解决load-use冲突
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/d8f74604a1f7296c5efc84ccc1b539219931dc8dd2633e2e187d4d2cf904438d.jpg)  

### 控制冒险  

>pro：分析指令之间的控制冒险（2014、2023）  

#### 基本概念
- 定义：改变指令执行顺序导致的冲突
- 触发条件：
  - 执行转移指令
  - 执行返回指令
  - 发生中断或异常

#### 处理示例
- 延迟处理方法：
  - 推迟后续指令执行
  - 插入nop指令

表5.8用插入空操作的办法解决控制冲突
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/5d0c7063bc5e9cb5cf392f3925551cca3ebbfb37ad2e468043801a4c994d2fcf.jpg)  

#### 解决方案
1. 基本方法
   - 软件插入"nop"指令
   - 硬件阻塞(stall)

2. 分支预测
   - 简单(静态)预测
     - 预设条件不满足时继续顺序执行
   - 动态预测
     - 基于历史情况动态调整
     - 具有较高预测准确率

>attention:  

Cache缺失的处理过程也会引起流水线阻塞。
## 性能指标  

### 流水线的吞吐率
#### 定义
- 流水线的吞吐率是指在单位时间内流水线所完成的任务数量，或输出结果的数量

>pro：  流水线吞吐率的计算（2013）  

#### 基本公式
- 流水线吞吐率（TP）的最基本公式为：
  $
  \mathrm{TP}\,{=}\,\frac{n}{T_{k}}
  $  
  - 式中：
    - $n$ 是任务数
    - $T_{k}$ 是处理完 $n$ 个任务所用的总时间

#### 理想情况计算
- 设定条件：
  - $k$ 为流水段的段数
  - $\Delta t$ 为时钟周期
- 计算过程：
  - 在输入流水线中的任务连续的理想情况下
  - 一条 $k$ 段流水线能在 $k+n-1$ 个时钟周期内完成 $n$ 个任务
  - 得出流水线的吞吐率为：
    $
    \mathrm{TP}=\frac{n}{(k+n-1)\Delta t}
    $  
- 最大吞吐率：
  - 当连续输入的任务数 $n{\rightarrow}\infty$ 时
  - $\mathrm{TP}_{\mathrm{max}}\,{=}1/\Delta t$  

### 流水线的加速比  
#### 定义
- 完成同样一批任务，不使用流水线与使用流水线所用的时间之比

#### 基本公式
- 流水线加速比（S）的基本公式为：
  $
  S=\frac{T_{0}}{T_{k}}
  $  
  - 式中：
    - $T_{0}$ 表示不使用流水线的总时间
    - $T_{k}$ 表示使用流水线的总时间

#### 计算过程
- 时间计算：
  - 一条 $k$ 段流水线完成 $n$ 个任务所需的时间：$T_{k}=\left(k+n-1\right)\Delta t$
  - 顺序执行 $n$ 个任务时，所需的总时间：$T_{0}={kn}\Delta t$
- 加速比计算：
  - 将 $T_{0}$ 和 $T_{k}$ 值代入得：
    $
    S=\frac{k n\Delta t}{(k+n-1)\Delta t}\!=\!\frac{k n}{k+n-1}
    $  
- 最大加速比：
  - 当连续输入的任务数 $n{\rightarrow}\infty$ 时
  - $S_{\mathrm{max}}\,{=}\,k,$  

## 高级流水线技术  

- 有两种增加指令级并行的策略：
  - 多发射技术：采用多个内部功能部件，使流水线功能段能同时处理多条指令
  - 超流水线技术：通过增加流水线级数来使更多的指令同时在流水线中重叠执行

### 多发射技术
#### 超标量流水线技术  

>pro：超标量流水线的特性(2017)  

- 也称动态多发射技术
- 特点：
  - 每个时钟周期内可并发多条独立指令
  - 以并行操作方式将两条或多条指令编译并执行
  - 需配置多个功能部件
- 执行方式：
  - 简单超标量CPU：指令按顺序发射执行
  - 多数超标量CPU：
    - 结合动态流水线调度技术
    - 通过动态分支预测等手段
    - 指令不按顺序执行（乱序执行）

#### 超长指令字技术  

- 也称静态多发射技术
- 特点：
  - 由编译程序挖掘出指令间潜在的并行性
  - 将多条能并行操作的指令组合成超长指令字
  - 指令字可达几百位
  - 需要采用多个处理部件

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/3fb915064ad6368ced430ed580e5bb36216c80da07ef16f0bb6a2923dd9be00f.jpg)  
图5.19超标量流水线技术  

### 超流水线技术  

- 原理：
  - 通过提高流水线主频来提升性能
  - 流水线功能段划分越多，时钟周期越短
  - 指令吞吐率越高
- 限制：
  - 流水线级数越多，用于流水寄存器的开销越大
  - 流水线级数有限制，不是越多越好

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/742aac8f955fdb4c6ca794363252545db1e5f37ff8e48bc846bf71986d0fa0d6.jpg)  
图5.20超流水线技术  

>pro：基本流水线CPU和超标量流水线CPU的CPI（2020）  

- 超流水线CPU：
  - 流水线充满后，每个时钟周期执行一条指令
  - CPI=1
  - 主频更高
- 多发射流水线CPU：
  - 每个时钟周期可以处理多条指令
  - CPI<1
  - 成本更高、控制更复杂
 
# 多处理器的基本概念  

>pro： 多处理器的基本概念（2022）  

## SISD、SIMD、MIMID的基本概念  

基于指令流的数量和数据流的数量，将计算机体系结构分为SISD、SIMD、MISD和MIMD四类。常规的单处理器属于SISD，而常规的多处理器属于MIMD。  

### 单指令流单数据流（SISD）结构  
- SISD是传统的事行计算机结构
  - 特点：
    - 仅包含一个处理器和一个存储器
    - 一段时间内仅执行一条指令
    - 按指令流规定的顺序串行执行指令流中的若干指令
  - 优化方式：
    - 采用流水线方式提高速度
    - 设置多个功能部件
    - 采用多模块交叉方式组织存储器

### 单指令流多数据流（SIMID）结构  
- SIMID定义：一个指令流同时对多个数据流进行处理
  - 也称为数据级并行技术
- 结构组成：
  - 一个指令控制部件
  - 多个处理单元
    - 每个单元执行相同指令
    - 拥有独立的地址寄存器
    - 处理不同的数据
- 应用效率：
  - 最高效：for循环处理数组
  - 最低效：case或switch语句

### 多指令流单数据流（MISD）结构  
- 定义：同时执行多条指令，处理同一个数据
- 实际上不存在这样的计算机

### 多指令流多数据流（MIIMID）结构  
- 定义：同时执行多条指令分别处理多个不同的数据
- 分类：
  #### 多计算机系统
  - 特点：
    - 每个节点具有私有存储器
    - 具有独立主存地址空间
    - 通过消息传递进行数据传送
    - 也称消息传递MIIMID
  
  #### 多处理器系统
  - 特点：
    - 共享存储多处理器(SMP)系统
    - 具有共享的单一地址空间
    - 通过存取指令访问所有存储器
    - 也称共享存储MIIMID

#### 向量处理器
- 定义：SIMID的变体，实现直接操作一维数组指令集的CPU
- 工作原理：
  - 将数据组按顺序放入向量寄存器
  - 以流水化方式依次操作
  - 结果写回寄存器
- 应用优势：
  - 特定工作环境中性能提升显著
  - 尤其在数值模拟等领域

#### 并行计算模式对比
- SIMD：数据级并行模式
- MIMD：线程级或更高级别的并行计算模式
## 硬件多线程的基本概念  

- 在传统CPU中，线程的切换包含一系列开销，频繁地切换会极大影响系统的性能
- 为了减少线程切换过程中的开销，便诞生了硬件多线程
  - 在支持硬件多线程的CPU中：
    - 必须为每个线程提供单独的通用寄存器组、单独的程序计数器等
    - 线程的切换只需激活选中的寄存器
    - 省略了与存储器数据交换的环节
    - 大大减少了线程切换的开销

### 硬件多线程的实现方式
#### 细粒度多线程  
- 多个线程之间轮流交叉执行指令
  - 多个线程之间的指令是不相关的，可以乱序并行执行
  - 处理器能在每个时钟周期切换线程
    - 例如：
      - 在时钟周期i，将线程A中的多条指令发射执行
      - 在时钟周期 $\mathrm{i}+1$ ，将线程B中的多条指令发射执行

#### 粗粒度多线程  
- 连续几个时钟周期都执行同一线程的指令序列
- 仅在当前线程出现了较大开销的阻塞时才切换线程，如Cache缺失
- 特点：
  - 当发生流水线阻塞时，必须清除被阻塞的流水线
  - 新线程的指令开始执行前需要重载流水线
  - 线程切换的开销比细粒度多线程更大

- 上述两种多线程技术：
  - 都实现了指令级并行
  - 但线程级不并行

#### 同时多线程  
- 同时多线程（SMT）是上述两种多线程技术的变体
  - 在实现指令级并行的同时，实现线程级并行
  - 在同一个时钟周期中，发射多个不同线程中的多条指令执行

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/fe12e3816bacd5ce1624427dc34539902f856a1a779a1dfcb27e86ac5ec6d5bd.jpg)  

- Intel处理器中的超线程（Hyper-threading）：
  - 就是同时多线程SMT
  - 在一个单处理器或单个核中设置了两套线程状态部件
  - 共享高速缓存和功能部件

## 多核处理器的基本概念  
- 定义：将多个处理单元集成到单个CPU中
  - 每个处理单元称为一个核（core）
  - 通常也称片上多处理器
- 特点：
  - 每个核既可以有自己的Cache，又可以共享同一个Cache
  - 所有核通常共享主存储器

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/4e190cda79c5d3789bba4003dd4e0cf2eedc2899411a4baf8ced7fc668357302.jpg)  
图5.22不共享Cache的双核CPU结构  

### 多核系统的性能发挥
- 必须采用多线程（或多进程）执行
  - 使得每个核在同一时刻都有线程在执行
- 与单核的区别：
  - 多核上的多个线程是在物理上并行执行的
    - 是真正意义上的并行执行
    - 在同一时刻有多个线程在并行执行
  - 单核上的多线程是一种多线程交错执行
    - 在同一时刻只有一个线程在执行

### 实例说明
- 假设要将四颗圆石头滚到马路对面：
  - 滚动每颗石头平均需花费1分钟
  - 不同处理方式：
    - 串行处理器：逐一滚动每颗石头，花费4分钟
    - 双核处理器：两个人各滚两颗，花费2分钟
    - 向量处理器：用木板同时推动四块石头，理论上1分钟
  - 对比：
    - 多核处理器相当于拥有多名工人
    - 向量处理器拥有同时对多件事进行相同操作的方法

## 共享内存多处理器的基本概念  
### 定义与特点
- 具有共享的单一物理地址空间的多处理器
- 通信方式：
  - 处理器通过存储器中的共享变量互相通信
  - 所有处理器都能通过存取指令访问存储器的任何位置
- 注意：即使共享同一个物理地址空间，仍然可在自己的虚拟地址空间中单独运行程序

### 类型划分
#### 统一存储访问（UMA）多处理器
- 特点：
  - 每个处理器对所有存储单元的访问时间大致相同
  - 访问时间与处理器和访问位置无关
- 架构特征：
  - 内存控制器未整合进CPU
  - 访存操作需经过北桥芯片
  - CPU通过前端总线和北桥芯片相连

#### 非统一存储访问（NUMA）多处理器
- 特点：
  - 存储器访存速度不同
  - 访问速度取决于处理器和访问位置
  - 主存被分割分配给不同处理器
- 架构优势：
  - 消除UMA架构的瓶颈
  - 内存控制器集成到CPU内部
  - 每个CPU有独立内存控制器和本地内存
  - CPU间通过QPI总线相连

### 共享变量访问控制
- 问题：多个处理器可能同时访问同一共享变量
- 解决方案：
  - 需要进行同步操作
  - 通过对共享变量加锁控制互斥访问
  - 一次只允许一个处理器获得锁
  - 其他处理器需等待解锁

### Cache一致性
- UMA构架多处理器中的一致性要求：
  - Cache与主存之间的数据一致性
  - 各CPU的Cache之间的一致性
  - 不同CPU的Cache对同一内存位置的数据应保持一致

#  本章小结  

本章开头提出的问题的参考答案如下。  

1）指令和数据均存放在内存中，计算机如何从时间和空间上区分它们是指令还是数据？  

从时间上讲，取指令事件发生在“取指周期”，取数据事件发生在“执行周期”。从空间上讲，从内存读出的指令流流向控制器（指令寄存器），从内存读出的数据流流向运算器（通用寄存器）  

2）什么是指令周期、机器周期和时钟周期？它们之间有何关系？  

CPU每取出并执行一条指令所需的全部时间称为指令周期；机器周期是在同步控制的机器中，执行指令周期中一步相对完整的操作（指令步）所需的时间，通常安排机器周期长度 $=$ 主存周期；时钟周期是指计算机主时钟的周期时间，它是计算机运行时最基本的时序单位，对应完成一个微操作所需的时间，通常时钟周期 $=$ 计算机主频的倒数。  
3）什么是微指令？它和第4章谈到的指令有什么关系？  

控制部件通过控制线向执行部件发出各种控制命令，通常把这种控制命令称为微命令，而一组实现一定操作功能的微命令的组合，构成一条微指令。许多条微指令组成的序列构成微程序， 微程序完成对指令的解释执行。指令，即指机器指令。每条指令可以完成一个独立的算术运算或逻辑运算操作。在采用微程序控制器的CPU中，一条指令对应一个微程序，一个微程序由许多微指令构成，一条微指令会发出很多不同的微命令。  

4）什么是指令流水线？指令流水线相对于传统体系结构的优势是什么？  

指令流水线是把指令分解为若干子过程，通过将每个子过程与其他子过程并行执行，来提高计算机的吞吐率的技术。采用流水线技术只需增加少量硬件就能把计算机的运算速度提高几倍，因此成为计算机中普遍使用的一种并行处理技术，通过在同一个时间段使用各功能部件，使得利用率明显提高。  

# 常见问题和易混淆知识点  

1.流水线越多，并行度就越高。是否流水段越多，指令执行越快？  

错误，原因如下：  

1）流水段缓冲之间的额外开销增大。每个流水段有一些额外开销用于缓冲间传送数据、进行各种准备和发送等功能，这些开销加长了一条指令的整个执行时间，当指令间逻辑上相互依赖时，开销更大。  

2）流水段间控制逻辑变多、变复杂。用于流水线优化和存储器（或寄存器）冲突处理的控制逻辑将随流水段的增加而大增，这可能导致用于流水段之间控制的逻辑比段本身的控制逻辑更复杂。  

2.读后写（WAR）相关和写后写（WAW）相关的概念  

1）读后写（WriteAfterRead，WAR）冲突。表示当前指令读出数据后，下一条指令才能写该寄存器。否则，先写后读，读到的就是错误（新）数据。在下列指令中，寄存器R1可能存在这样的冲突，当指令12试图在指令Ⅱ1读R1之前就写入该寄存器时，指令I1就错误地读出该寄存器新的内容。  

I1 add R3,R1,R2  $\begin{array}{r l}{\#\left(\mathbb{R}{1}\right)+\left(\mathbb{R}{2}\right)\rightarrow\mathbb{R}{3}}&{{}}\\ {\#\left(\mathbb{R}{4}\right)-\left(\mathbb{R}{5}\right)\rightarrow\mathbb{R}{1}}&{{}}\end{array}$  I2 sub R1,R4,R5  

在读后写（WAR）冲突中，指令I2的目的操作数是指令I1的源操作数。  

3）写后写（WriteAfterWrite，WAW）相关。表示当前指令写入寄存器后，下一条指令才能写该寄存器。否则，下一条指令在当前指令之前写，将使寄存器的值不是最新值。在下列指令中，寄存器RI可能存在这样的冲突，当指令I2试图在指令I1之前就写入R1时，就会错误地使由指令11写入的值成为该寄存器的内容。  

I1 add R1,R2,R3  $\begin{array}{r}{\#\left(\mathbb{R}2\right)+\left(\mathbb{R}3\right)\rightarrow\mathbb{R}1}\\ {\#\left(\mathbb{R}4\right)-\left(\mathbb{R}5\right)\rightarrow\mathbb{R}1}\end{array}$  I2 sub R1,R4,R5  

在写后写（WAW）冲突中，指令I2和指令I1的目的操作数是相同的。  

>attention:  

在非按序执行的流水线中，因为允许后进入流水线的指令超过先进入流水线的指令而先流出流水线，所以既可能发生RAW相关，又可能发生WAR和WAW相关。 