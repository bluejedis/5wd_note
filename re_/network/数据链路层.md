  
# 第3章数据链路层  

## 【考纲内容】  

（一）数据链路层的功能  

（二）组帧  

（三）差错控制  

检错编码：纠错编码  

（四）流量控制与可靠传输机制流量控制、可靠传输与滑动窗口机制：停止-等待协议：后退 $N$ 帧协议（GBN）：选择重传协议（SR）  

（五）介质访问控制  

1.信道划分：频分复用、时分复用、波分复用、码分复用2.随机访问：ALOHA协议：CSMA协议：CSMA/CD协议：CSMA/CA协议3.轮询访问：令牌传递协议  

（六）局域网局域网的基本概念与体系结构：以太网与IEEE802.3；IEEE802.11无线局域网：VLAN的基本概念与基本原理  

（七）广域网广域网的基本概念：PPP协议  

以太网交换机及其工作原理  

## 【复习提示】  

历年考试中考查的重点
  - 要求在了解数据链路层基本概念和功能的基础上，重点掌握
    - 滑动窗口机制
    - 三种可靠传输协议
    - 各种MAC协议
      - 特别是CSMA/CD协议
      - CSMA/CA协议
      - 以太网帧格式
    - 以及局域网的争用期和最小帧长的概念
    - 二进制指数退避算法
  - 此外，中继器、网卡、集线器、网桥和局域网交换机的原理及区别也要重点掌握

# 数据链路层的功能
## Function
### 功能  

#### 基本任务
- 实现帧在一段链路上或一个网络中进行传输
- 三个基本问题
  - 封装成帧
  - 透明传输
  - 差错检测

#### 信道类型
- 点对点信道
  - 使用一对一的通信方式
  - PPP协议是目前使用最广泛的点对点协议
- 广播信道
  - 连接的主机很多，使用一对多的广播通信方式
  - 有线局域网普遍使用CSMA/CD协议
  - 无线局域网使用CSMA/CA协议

### 数据链路层所处的地位  

#### 通信示例
- 两台主机通过互联网通信
  - 局域网1中的主机H1经过路由器R1、广域网及路由器R2连接到局域网2中的主机H2
  - 主机H1和H2都有完整的五层协议栈
  - 路由器在转发分组时仅使用协议栈的下三层

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/e7e297fbb0520613c7252ae1f3530980f5248c701458e45dd8079c49662f2683.jpg)  
图3.1主机H1向H2发送数据  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/25920ca739682fceb5264e70ee939f8d7abe7feee0fa034448b85f86ab86b5f8.jpg)  
图3.2从层次上看数据的流动  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/ffb78b2e18190098f64fcc494beb631836f32110a4006eb8b1a6412e30626310.jpg)  
图3.3只考虑数据在数据链路层的流动  

#### 基本概念
- 链路
  - 从一个结点到相邻结点的一段物理线路
  - 是通信路径的组成部分
- 数据链路
  - 在链路上加上必要的通信协议的硬件和软件
  - 物理链路vs逻辑链路
- 帧
  - 数据链路层对等实体之间进行逻辑通信的协议数据单元
  - 功能：
    - 把网络层下交的数据构成帧发送到链路上
    - 把接收到的帧中的数据取出并上交给网络层

### 为网络层提供服务  

#### 服务类型
- 无确认的无连接服务
  - 特点：
    - 不需要先建立链路连接
    - 不需要发回确认
  - 适用于误码率较低的信道，如以太网
- 有确认的无连接服务
  - 特点：
    - 不需先建立链路连接
    - 必须发回确认
    - 超时重传机制
  - 适用于误码率较高的信道，如无线通信
- 有确认的面向连接服务
  - 特点：
    - 三个阶段：建立链路、传输帧、释放链路
    - 每帧都要返回确认
  - 适用于可靠性要求较高的场合

> attention:  
有连接就一定要有确认，即不存在无确认的面向连接的服务。  

### 链路管理  

#### 定义与过程
- 链路管理是数据链路层连接的建立、维持和释放过程
- 主要用于面向连接的服务
- 通信步骤：
  - 确认对方就绪状态
  - 交换必要信息初始化
  - 建立连接
  - 维持连接
  - 传输完毕后释放连接

### 封装成帧与透明传输  

#### 封装成帧
- 定义：在数据前后添加首部和尾部构成帧
- 帧长计算：数据部分长度 + 首部长度 + 尾部长度
- 首部和尾部作用：
  - 确定帧界限（帧定界）
  - 实现帧同步
- HDLC协议示例：
  - 使用标识位F（01111110）标识帧的开始和结束
  - 标准帧格式如图3.4所示

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/cf66d2f1d0b40f4535ac0e51bb07fdcdfe8a22a900b11a84e927a41c2f9190f7.jpg)  
图3.4HDLC标准帧格式  

#### 透明传输
- 定义：能够按原样无差错地传输任何比特组合
- 解决问题：防止数据中出现与帧定界符相同的比特组合导致的误判

### <span style="color: green;">流量</span> <span style="color: Gold;">控制</span>  

#### 基本概念
- 目的：限制发送方的发送速率，避免超过接收方的接收能力
- 实现机制：
  - 通过反馈机制控制发送
  - 根据反馈信息决定继续发送或暂停

#### 不同体系结构中的实现
- OSI体系：在数据链路层实现
  - 控制相邻结点间数据链路上的流量
- TCP/IP体系：在传输层实现
  - 控制源端到目的端之间的流量

### <span style="color:darkred;">差错</span><span style="color: green;">检测</span>  

#### 错误类型
- 位错
  - 帧中某些位出现差错
  - 使用循环冗余检验(CRC)检测
- 帧错
  - 包括帧丢失、帧重复或帧失序
  - 属于传输差错

#### 差错处理机制
- 无线传输（通信质量较差）
  - 使用确认和重传机制
  - 数据链路层提供可靠传输服务
- 有线链路（通信质量良好）
  - 仅进行CRC检错
  - 丢弃错误帧
  - 重传任务由高层协议完成
 

#  <span style="color: green;">组</span><span style="color: LightSkyBlue;">帧</span>  

## 概述
### 概念
- 发送方依据一定的规则将 网络层递交的分组 封装成 <span style="color: LightSkyBlue;">帧</span>（也称组帧）

### 目的
- 数据链路层 将比特组合成以帧为单位传输 'reason: 
  - 在出错时只重发出错的帧
  - 不必重发全部数据
  - 提高传输效率

### 主要问题
- 帧定界
- 帧同步  
- 透明传输

> attention:

### <span style="color: green;">结构</span>特点
- 组帧时既要加首部，又要加尾部
  #### 原因分析
  - 网络中信息以帧为最小单位进行传输
  - 接收方需要在比特流中正确识别帧的起止位置
    - 接收方收到的是一串比特流
    - 没有首部和尾部无法正确区分帧
  #### 与分组的区别
  - 分组（IP数据报）is <span style="color: LightSkyBlue;">帧</span>中的 <span style="color: blue;">数据</span>部分
  - 分组不需要加尾部来定界

## 字符计<span style="color: green;">数</span>法  

### 基本原理
- 在顺首部使用一个计数字段来记录该帧所含的字节数（包括计数字段自身所占用的1个字节）
- 接收方读出顿首部的字节计数值时，就知道后面跟随的字节数，从而确定帧结束位置
- 帧与帧之间连续传输，能确定下一顺的开始位置

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/18cc49d5bb85480e0fc592ac0552950e0a6fde483285e113ce24cf11aa21335f.jpg)  
图3.5字符计数法  

### 主要问题
- 计数字段出错会导致:
  - 失去帧边界划分依据
  - 接收方无法判断帧的结束位和下一帧的开始位
  - 收发双方失去同步
  - 造成灾难性后果

## <span style="color: RoyalBlue;">字节</span><span style="color: Gold;">填充</span>法  

### 定界方式
- 使用特定字节定界帧的开始与结束
  - 控制字符SOH表示帧的开始
  - 控制字符EOT表示顺的结束

### 透明传输实现
- 在特殊字符前填充转义字符ESC
- 接收方收到转义字符后，知道后面是数据信息而非控制信息
- 对于数据中的ESC字符，也在其前插入一个ESC字符

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/8bc622f7582e5fe4c3b6569bf04fcef4d549661a5ba94591071cdb9feec74e46.jpg)  
图3.6字节填充法  

## <span style="color: purple;">零</span><span style="color: LightSkyBlue;">比特</span><span style="color: Gold;">填充</span>法  

>pro：HDLC协议中的比特填充法（2013）  

### 基本原理
- 使用特定比特串01111110标志帧的开始和结束
- 发送方处理:
  - 扫描整个数据字段
  - 遇到5个连续的"1"后插入一个"0"
- 接收方处理:
  - 收到5个连续的"1"后删除后面的"0"
  - 恢复原始数据

### 特点
- 允许数据帧包含任意个数的比特
- 很容易由硬件实现
- 性能优于字节填充法

## <span style="color: orange;">违规</span><span style="color: deepskyblue;">编码</span>法  

### 实现方式
- 在物理层进行比特编码
- 利用违规编码序列定界帧的起始和终止
  - 如曼彻斯特编码中的"高-高"和"低-低"电平对

### 特点
- 不需填充技术即可实现透明传输
- 仅适用于采用余编码的特殊编码环境

### 使用现状
- 局域网IEEE802标准采用此方法
- 与零比特填充法为当前较常用的组帧方法
- 原因:
  - 字符计数法计数字段脆弱
  - 字节填充法实现复杂且不兼容


# <span style="color:darkred;">差错</span> <span style="color: Gold;">控制</span>  

## 基本概念
- 实际通信链路都不是理想的
  - 比特在传输过程中可能产生差错
    - 1可能变成0
    - 0也可能变成1
  - 这就是比特差错
- 比特差错是传输差错中的一种，本节仅讨论比特差错

## 差错控制方式
- 通常利用编码技术进行差错控制，主要有两类：
  - 自动重传请求（AutomaticRepeatreQuest，ARQ）
    - 当接收方检测到差错时，就设法通知发送方重发
    - 直到收到正确的数据为止
  - 前向纠错（Forward Error Correction，FEC）
    - 接收方不但能发现差错
    - 而且能确定错误的位置并加以纠正
- 因此，差错控制又可分为：
  - 检错编码
  - 纠错编码

## <span style="color: green;">检错</span><span style="color: deepskyblue;">编码</span>  

### 基本原理
- 检错编码都采用冗余编码技术
  - 核心思想：
    - 在有效数据（信息位）被发送前
    - 按某种关系附加一定的余位
    - 构成一个符合某一规则的码字后发送
  - 工作机制：
    - 当要发送的有效数据变化时，相应的冗余位也随之变化
    - 使得码字遵从不变的规则
    - 接收方根据收到的码字是否仍符合原规则来判断是否出错
- 常见的检错编码有：
  - 奇偶检验码
  - 循环冗余码

### <span style="color: GreenYellow;">奇</span><span style="color: Gold;">偶</span><span style="color: green;">检验</span>码  

#### 定义
- 奇偶检验码是奇检验码和偶检验码的统称
- 是一种最基本的检错码
- 组成：
  - n-1位数据
  - 1位检验位
- 检验位的取值（0或1）将使整个检验码中"1"的个数为奇数或偶数

#### 类型
- 奇检验码：
  - 附加一个检验位后，码长为n的码字中"1"的个数为奇数
- 偶检验码：
  - 附加一个检验位后，码长为n的码字中"1"的个数为偶数

#### 示例与局限性
- 示例：
  - 7位数据1001101对应的：
    - 奇检验码为10011011
    - 偶检验码为10011010
- 局限性：
  - 只能检测奇数位的出错情况
  - 不知道哪些位错了
  - 不能发现偶数位的出错情况
### <span style="color: LightSkyBlue;">循环</span><span style="color: Gold;">冗余</span>码<span style="color: green;">CRC</span>

#### 定义与概述
- （Cyclic Redundancy Code，CRC）检错技术

#### 基本原理
- 收发双方约定生成多项式 $G(x)$
  - 最高位和最低位必须为1
  - $k$ 位位串可视为阶数为 $k\!-\!1$ 的多项式的系数序列
    - 例如，可用多项式 $x^{3}+x^{2}+1$ 表示位串1101
- 工作流程
  - 发送方基于待发送的数据和 $G(x)$ ，计算出余码，将余码附加到数据后面一起发送
  - 接收方收到数据和冗余码后，通过 $G(x)$ 来计算收到的数据和冗余码是否产生差错

#### 运算机制
##### 基本概念
- 数据组成
  - 待传送 $m$ 位的数据
  - CRC运算产生 $r$ 位的冗余码（FCS)
  - 最终帧长度为 $m+r$ 位
- 运算特点
  - 带检验码的帧能被预先确定的多项式 $G(x)$ 整除
  - 接收方用相同多项式除帧，无余数则无差错

>pro：循环余码的计算（2023）  

##### 计算步骤
- 加0
  - 假设 $G(x)$ 的阶为 $r$
  - 在数据后面加 $r$ 个 $0$
  - 相当于乘以 $2^{r}$
- 模2除
  - 用 $G(x)$ 对应的二进制串除以加0后的数据串
  - 得到的余数即为冗余码（共 $r$ 位，前面的0不可省略）
  - 模2运算规则：加法不进位，减法不借位，相当于异或运算

##### 计算示例
- 已知条件
  - 数据 $M\!=\!101001$ （即 $m\!=\!6$ )
  - 除数 $G(x)\!=\!1101$ （即 $r\!=\!3\,.$ ）
- 计算结果
  - 商 $Q\,{=}\,110101$ （无实际用途）
  - 余数 $R\!=\!001$
- 最终发送数据
  - 完整数据为 $101001\;001$ （即 $2^{r}M+\mathrm{FCS}$ )
  - 总长度为 $m+r$ 位

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/7fe3ce6cca99d7917138341845afea8f15d743f93b7222c8dc023eca16fb4d69.jpg)  
图3.8循环冗余码的运算过程  

#### 实现特点与效果
##### 硬件实现
- 发送方的FCS生成和接收方的CRC检验由硬件完成
- 处理速度快，不影响数据传输

##### 检错效果
- 无差错情况
  - CRC检验后余数 $R$ 为0
- 有差错情况
  - 余数 $R$ 为0的概率极低
  - 可近似认为接收的帧无差错
  - 有差错的帧会被丢弃

>attention:  

##### 特别说明
- CRC具有纠错功能但在数据链路层
  - 仅使用检错功能
  - 检测到帧出错则直接丢弃
  - 为简化协议实现
- 因此将CRC归类为检错编码

## <span style="color: green;">纠错</span><span style="color: deepskyblue;">编码</span>

### 海明码原理
- 最常见的纠错编码是海明码
- 实现原理：
  - 在有效信息位中加入几个检验位形成海明码
  - 把海明码的每个二进制位分配到几个奇偶检验组中
  - 某一位出错后会引起相关检验位值变化，可发现错位并指出位置
### 海明码的编码原理和过程 → eg. 数据码1010

#### 1. 确定海明码位数
- 设n为有效信息位数，k为检验位数，应满足：
  - n+k≤2^k-1
- 对于示例：
  - 海明码位数n+k=7≤2^3-1成立
  - 信息位D₄D₃D₂D₁(1010)共4位
  - 检验位P₃P₂P₁共3位
  - 对应海明码为H₇H₆H₅H₄H₃H₂H₁

#### 2. 确定检验位分布
- 规定检验位Pi在海明位号为2^(i-1)的位置
- 具体分布：
  - P₁的海明码位号为2^0=1，即H₁为P₁
  - P₂的海明码位号为2^1=2，即H₂为P₂
  - P₃的海明码位号为2^2=4，即H₄为P₃
- 海明码各位分布：
$\begin{array}{c c c c c c c c}{{H_{7}}}&{{H_{6}}}&{{H_{5}}}&{{H_{4}}}&{{H_{3}}}&{{H_{2}}}&{{H_{1}}}\\ {{D_{4}}}&{{D_{3}}}&{{D_{2}}}&{{P_{3}}}&{{D_{1}}}&{{P_{2}}}&{{P_{1}}}\end{array}$

#### 3. 分组形成检验关系
- 每个数据位用多个检验位进行检验
- 条件：被检验数据位的海明位号等于检验该数据位的各检验位海明位号之和
- 检验位不需要再被检验

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f963b4fdaa3d709ead387b3b915ec9d6919e696e045e6a79d41c56bbe2ccb151.jpg)

#### 4. 检验位取值
- 检验位Pi的值为第i组所有位求异或
- 根据分组计算：
  - P₁=D₁⊕D₂⊕D₄=0⊕1⊕1=0
  - P₂=D₁⊕D₃⊕D₄=0⊕0⊕1=1
  - P₃=D₂⊕D₃⊕D₄=1⊕0⊕1=0
- 最终1010对应的海明码为1010010

#### 5. 海明码检验原理
- 每个检验组进行奇偶检验，构成k个检验方程：
$\begin{array}{c}{S_{1}\!=\!P_{1}\oplus D_{1}\oplus D_{2}\oplus D_{4}}\\ {S_{2}\!=\!P_{2}\oplus D_{1}\oplus D_{3}\oplus D_{4}}\\ {S_{3}\!=\!P_{3}\oplus D_{2}\oplus D_{3}\oplus D_{4}}\end{array}$
- 检验结果：
  - S₃S₂S₁="000"说明无错
  - 否则出错，数值为错误位的位号
  - 如S₃S₂S₁=001说明H₁出错，将该位取反即可纠错
# <span style="color: green;">流量</span>  <span style="color: Gold;">控制</span> & <span style="color: GreenYellow;">可靠</span><span style="color: green;">传输</span>机制  

在数据链路层中，流量控制机制和可靠传输机制是交织在一起的。  

## <span style="color: green;">流量</span>  <span style="color: Gold;">控制</span> &  <span style="color: GreenYellow;">滑动</span><span style="color: LightSkyBlue;">窗口</span>机制  

### <span style="color: green;">流量</span>  <span style="color: Gold;">控制</span>
- 流量控制是指由接收方控制发送方的发送速率，使接收方有足够的缓冲空间来接收每个帧
- 常见的流量控制方法有两种：停止-等待协议和滑动窗口协议
- 数据链路层和传输层均有流量控制的功能，它们都用到了滑动窗口协议，但也有所区别，主要体现如下：  
  - 数据链路层控制的是相邻结点之间的流量，而传输层控制的是端到端的流量
  - 数据链路层的控制手段是接收方收不下就不返回确认。传输层的控制手段是接收方通过确认报文段中的窗口值来调整发送方的发送窗口

### <span style="color: orange;">停止</span>- <span style="color: GreenYellow;">等待</span><span style="color: green;">流量</span><span style="color: Gold;">控制</span>   
- 停止-等待流量控制是一种最简单的流量控制方法
- 基本过程：
  - 发送方每次只充许发送一个帧
  - 接收方每接收一个顿都要反馈一个应答信号，表示可以接收下一帧
  - 发送方收到应答信号后才能发送下一顿
  - 若发送方没有收到接收方反馈的应答信号，则需要一直等待
- 发送方每发送完一个帧，就进入等待接收方确认信息的过程中，因而传输效率很低

###  <span style="color: GreenYellow;">滑动</span><span style="color: LightSkyBlue;">窗口</span> 流量控制  
#### 基本概念
- 滑动窗口流量控制是一种更高效的流量控制方法
- 窗口维护：
  - 发送方维持发送窗口：一组连续的允许发送帧的序号
  - 接收方维持接收窗口：一组连续的允许接收帧的序号
- 窗口作用：
  - 发送窗口表示在还未收到对方确认信息的情况下，发送方最多还能发送多少个顺和哪些顺
  - 接收窗口是为了控制可以接收哪些倾和不可以接收哪些顺

#### 工作原理
- 发送窗口工作原理：

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/248725a206d61268b973ecf8d7a386b827f85a708e4466f48aca92b0595310cb.jpg)  

- 接收窗口工作原理：

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/9d828f694c1132f7e08e7c2789e1420a756d8816e676452e1fb324f88be8ccd3.jpg)  

#### 操作过程
- 发送方操作：
  - 每收到一个按序确认的确认帧，就将发送窗口向前滑动一个位置
  - 新的序号落入发送窗口，序号落入发送窗口内的数据帧可以继续发送
  - 当窗口内没有可以发送的帧时，发送方就停止发送
- 接收方操作：
  - 每收到一个序号落入接收窗口的数据顿，就充许将该帧收下
  - 将接收窗口向前滑动一个位置，并发回确认
  - 新的序号落入接收窗口，序号落入接收窗口内的数据倾即为准备接收的帧
  - 若收到的帧落在接收窗口之外，则一律丢弃

#### 重要特性
- 窗口滑动特性：
  - 只有接收窗口向前滑动（同时接收方发送了确认）时，发送窗口才有可能向前滑动

>pro：滑动窗口协议的窗口大小的关系（2019）  

- 窗口大小关系：
  - 停止-等待协议：发送窗口 $W_{\mathrm{T}}\!=\!1$ ，接收窗口 $W_{\mathbb{R}}\!=\!1$
  - 后退 $N$ 帧协议：发送窗口 $W_{\mathrm{T}}\!>\!1$ ，接收窗口 $W_{\mathbb{R}}\!=\!1$
  - 选择重传协议：发送窗口 $W_{\mathrm{T}}\!>\!1$ ，接收窗口 $W_{\mathbb{R}}\!>\!1$
  - 若采用 $n$ 比特对帧编号，则后两种滑动窗口协议还需满足 $W_{\mathrm{{T}}}+W_{\mathrm{{R}}}\leqslant2^{n}$
- 其他特性：
  - 当接收窗口的大小为1时，可保证帧的有序接收
  - 在数据链路层的滑动窗口协议中，窗口大小在传输过程中是固定的（与传输层不同）

##  <span style="color: GreenYellow;">可靠</span><span style="color: green;">传输</span>机制 

### 基本概念与机制
- 可靠传输含义：发送方发送的数据都能被接收方正确地接收
- 实现机制：
  - 确认机制：接收方每收到发送方发来的数据顺，都要向发送方发回一个确认顺
  - 超时重传机制：发送方在发送数据后启动计时器，规定时间内未收到确认则重发

### <span style="color: LightSkyBlue;">A</span><span style="color: green;">R</span><span style="color: Gold;">Q</span>协议 <span style="color: gray; font-size: 14px;">Automatic Repeat-reQuest</span>
- ARQ(自动重传请求)协议特点：
  - 重传自动进行，无需接收方请求
  - 数据帧和确认帧需编号
- 分类：
  - 停止-等待协议
  - 后退N帧协议 
  - 选择重传协议
- 应用范围：
  - 不仅限于数据链路层
  - 可应用到上层协议
- 使用场景：
  - 有线网络：链路误码率低，不要求数据链路层提供可靠传输
  - 无线网络：链路易受干扰，要求数据链路层提供可靠传输

###  <span style="color: GreenYellow;">单</span>帧<span style="color: GreenYellow;">滑动</span><span style="color: LightSkyBlue;">窗口</span> 与  <span style="color: Gold;">停止</span>-<span style="color: green;">等待</span>协议（ <span style="color: Gold;">S</span>-<span style="color: green;">W</span>）
#### 基本原理
- 发送方每次只能发送一个帧
- 需等待接收方确认后才可发送下一帧
- 发送窗口和接收窗口大小均为1

#### 差错处理
- 数据帧破坏情况：
  - 接收方检测到破坏后丢弃
  - 发送方超时重传直到正确接收
- 确认帧破坏情况：
  - 发送方重传数据帧
  - 接收方丢弃重复帧并重发确认

#### 实现细节
- 帧编号：
  - 使用1比特编号(0和1交替)
  - 确认帧使用ACK0和ACK1
- 缓冲区设置：
  - 发送方和接收方都需设置帧缓冲区
  - 发送方需保留副本用于重传

### <span style="color: purple;">多</span>帧<span style="color: GreenYellow;">滑动</span><span style="color: LightSkyBlue;">窗口</span> 与 <span style="color: green;">后退</span>N帧协议（<span style="color: green;">GB</span>N）
#### 基本工作原理
>pro：GBN协议的工作原理（2009）  

- 发送方可连续发送多个帧而无需等待确认
- 出错时需重传出错帧及其后续N个帧

#### 确认机制
>pro：GBN确认号的含义/捎带确认的应用（2017）  

- 累积确认：
  - 可对连续多个正确帧只确认最后一个
  - ACKn表示n号帧及之前所有帧均正确接收
- 接收方只按序接收数据帧

#### 差错处理
>pro：GBN超时重传的分析（2017）  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f3d8ffa553e14eac7cd68cf2198b841bed3882b8f8397d4235957d13e95a1280.jpg)  
图3.11GBN协议的工作原理：对出错数据帧的处理  

#### 窗口设置
>pro：GBN发送窗口的意义/最大尺寸（2017）  

- 发送窗口要求：
  - 使用n比特编号时，1<WT≤2^n-1
  - 超出范围会导致新旧帧无法分辨
- 接收窗口：
  - WR=1，保证按序接收
- 效率分析：
  - 优点：连续发送提高信道利用率
  - 缺点：重传包含正确帧，在高误码率时效率可能低于停止-等待协议

###  <span style="color: purple;">多</span>帧<span style="color: GreenYellow;">滑动</span><span style="color: LightSkyBlue;">窗口</span> 与 <span style="color: LightSkyBlue;">选择</span><span style="color: green;">重传</span>协议（<span style="color: LightSkyBlue;">S</span><span style="color: green;">R</span>）
Selective Repeat
#### 工作原理
>pro：选择重传协议的工作原理（2011）  

- 只重传出错和超时的帧
- 接收方可接收失序但正确的帧
- 需要较大接收窗口缓存失序帧

#### 实现<span style="color: green;">机制</span>
- 确认机制：
  - 逐<span style="color: LightSkyBlue;">帧</span>确认，不使用累积确认
  - 可使用NAK请求立即重传
-  <span style="color: Gold;">缓冲</span>要求：
     -  <span style="color: GreenYellow;">接收方</span> 设置 足够<span style="color: LightSkyBlue;">帧</span>缓冲区
     - every <span style="color: LightSkyBlue;">发送</span> <span style="color: Gold;">缓冲</span>区对应 → 一个计时器

#### <span style="color: LightSkyBlue;">窗口</span>设置
- 基本要求：
  - WR和WT都大于1
  - 使用n比特编号时需满足：
    - WR+WT≤2^n
    - WR≤WT
    - WR≤2^n-1
  - 通常WR和WT大小相同

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/de59299ec42c47f7749328137b7d85d10deaadf593f80970a3170cc75da885a2.jpg)  
图3.12SR协议的工作原理：对超时和出错数据帧的处理

###  <span style="color: Gold;">信</span><span style="color: LightSkyBlue;">道</span><span style="color: green;">利用</span><span style="color: purple;">率</span>  

信道利用率是指信道的效率。从时间角度看，信道效率是对发送方而言的，是指发送方在一个发送周期（从发送方开始发送分组到收到第一个确认分组所需的时间）内，有效发送数据的时间与整个发送周期之比。本节之所以使用分组的PDU名称而不使用帧，是为了更具通用性。  

#### <span style="color: Gold;">S</span>-<span style="color: green;">W</span>' <span style="color: Gold;">信</span><span style="color: LightSkyBlue;">道</span><span style="color: green;">利用</span><span style="color: purple;">率</span> 

>pro：停止-等待协议下信道利用率的计算（2018、2020）  

- 停止-等待协议的特点：
  - 优点是简单
  - 缺点是信道利用率太低

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/32c2e5a6d87213d9c91d0cbc5b5ea99f663b7a7cf0a460c11b9a131bd28a37f8.jpg)  
图3.13停止-等待协议中数据帧和确认帧的发送时间关系  

- 信道利用率计算：
  - 发送时延 $T_{\mathrm{{D}}}$ = 分组长度/数据传输速率
  - 发送周期 = ${T_{\mathrm{{D}}}}\ +{\mathrm{{RTT}}}+{T_{\mathrm{{A}}}}$
  - 信道利用率公式：$U\,{=}\,\frac{T_{\mathrm{D}}}{T_{\mathrm{D}}+\mathrm{RT}+T_{\mathrm{A}}}$
  - 计算示例：
    - 条件：RTT=20ms，分组长度=1200比特
    - 当数据传输速率=1Mb/s时，U=5.66%
    - 当数据传输速率=10Mb/s时，U=0.0596%
    - 结论：当RTT大于TD时，信道利用率非常低

#### 连续 <span style="color: LightSkyBlue;">A</span><span style="color: green;">R</span><span style="color: Gold;">Q</span> ' <span style="color: Gold;">信</span><span style="color: LightSkyBlue;">道</span><span style="color: green;">利用</span><span style="color: purple;">率</span>    

>pro: 三种滑动窗口协议的信道利用率比较（2023）  

- 基本原理：
  - 采用流水线传输
  - 发送方可连续发送多个分组
  - 发送窗口足够大时可使信道持续有数据流动
  - 可获得很高的信道利用率

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/8e812ae1175819652438ba38e40f983c2fad2ab762a531a9c6ad028e526082e0.jpg)  
图3.14连续ARQ协议的流水线传输可提高信道利用率  

>pro: GBN协议下信道利用率与发送窗口大小的关系（2012、2015、2017）  

- 信道利用率计算（发送窗口为n）：
  - 情况1：$n T_{\mathrm{D}}\,{<}\,T_{\mathrm{D}}\,{+}\,{\mathrm{RTT}}\,{+}\,T_{\mathrm{A}}$
    - 一个发送周期内可发送完n个分组
    - $U={\frac{n T_{\mathrm{{D}}}}{T_{\mathrm{{D}}}+\mathrm{{RTT}}+T_{\mathrm{{A}}}}}$
  - 情况2：$n T_{\mathrm{D}}\,{\geqslant}\,T_{\mathrm{D}}\,{+}\,\mathrm{RTT}+T_{\mathrm{A}}$
    - 一个发送周期内发不完（或刚好发完）n个分组
    - 无差错时可不间断发送，U=1

>pro: 滑动窗口协议的数据传输速率的计算（2009、2010、2014）  

- 信道数据传输速率计算：
  - 方法1：信道平均数据传输速率 = 信道利用率 × 信道带宽
  - 方法2：信道平均数据传输速率 = 发送周期内发送的数据量/发送周期

## <span style="color: purple;">介质</span>访问Media access控制

### 概述
- 主要任务：
  - 为使用介质的每个结点隔离来自同一信道上其他结点所传送的信号
  - 协调活动结点的传输
- 通信方式：
  - 广播信道的通信方式如图3.15所示
  - 结点A、B、C、D、E共享广播信道
  - 若不加控制，不同结点间的通信可能会因互相干扰而失败

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/9ca053d64d3e0454a486ca2d0596abec10117566cb04d939d349516482e06b37.jpg)  
图3.15广播信道的通信方式  

- MAC子层：
  - 用来决定广播信道中信道分配的协议
  - 属于数据链路层的一个子层
- 常见的介质访问控制方法：
  - 信道划分介质访问控制（静态划分）
  - 随机访问介质访问控制（动态分配）
  - 轮询访问介质访问控制（动态分配）

### <span style="color: Gold;">信</span><span style="color: LightSkyBlue;">道</span><span style="color: green;">划分</span> <span style="color: purple;">介质</span>访问 控制
#### 基本概念
- 复用技术实现：
  - 发送端：把多个发送方的信号组合在一条物理信道上传输
  - 接收端：把收到的复用信号分离并发送给对应接收方
  - 可提高传输系统利用率（当介质带宽超过单个信号所需带宽时）

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/db2b663112711b7fbd103f843c6340fe46b6a5abd6a2b395f3b85c66372e3d9a.jpg)  
图3.16复用原理示意图  

#### 原理
- 实质：
  - 通过分时、分频、分码等方法
  - 将广播信道逻辑分为几个互不干扰的子信道
  - 将广播信道转变为若干个点对点信道
- 分类：
  - 4种信道划分介质访问控制方法

### 分类
####  <span style="color: Gold;">频</span>分复用<span style="color: gray; font-size: 14px;">Division Multiplexing</span>（FDM）
- 每个子频带作为一个子信道，每对用户使用一个子信道进行通信，如图3.17所示
- 所有用户在同一时间占用不同的频带资源
- 每个子信道分配的频带可不相同，但它们的总和不能超过信道的总频带
- 在实际应用中，为了防止子信道之间互相干扰，相邻信道间还要加入"隔离频带"

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/97ee383c310e7a88c1fad36132c6e33425721806fd85d6e745c3a2f5bee9b126.jpg)  
图3.17频分复用的原理示意图  

- 分复用的优点：
  - 充分利用了传输介质的带宽
  - 系统效率较高
  - 实现也较容易

#### <span style="color: green;">时</span>分复用（TDM）
##### 基本原理
- 时间片，称为TDM顿
- 每个用户在每个TDM帧中占用固定序号的时隙
- 每个用户所占用的时隙周期性地出现（其周期就是TDM的长度）
- 所有用户在不同的时间占用同样的信道资源，如图3.18所示
- TDM帧实际上是一段固定长度的时间，它与数据链路层的顿不是同一个概念

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/eeb2deb249d0dcde4ed543762681f37459cd83d3337b43692dc71503e9e57355.jpg)  
图3.18时分复用的原理示意图  

##### 特点
- 从某个时刻来看，时分复用信道上传送的仅是某对用户之间的信号
- 从某段时间来看，传送的是按时间分割的复用信号
- 因为时分复用是按固定次序给用户分配时隙的，当用户在某段时间暂无数据传输时，其他用户也无法使用这个暂时空闲的线路资源，所以时分复用后的信道利用率不高

##### 统计时分复用（STDM）
- 又称异步时分复用，它是对TDM的一种改进
- STDM倾与TDM帧不同：
  - 它并不固定分配时隙
  - 而按需动态分配时隙
  - 当用户有数据要传送时，才会分配到STDM帧中的时隙
  - 因此可以提高线路的利用率
- 例如：
  - 假设线路的数据传输速率为6000b/s
  - 3个用户的平均速率都为2000b/s
  - 当采用TDM方式时，每个用户的最高速率为2000b/s
  - 而在STDM方式下，每个用户的最高速率可达6000b/s

#### <span style="color: LightSkyBlue;">波</span>分复用（WDM)
- 即光的频分复用
- 它在一根光纤中传输多种不同波长（频率）的光信号
- 因为波长不同，各路光信号互不干扰
- 最后用光分用器将各路波长分解出来
- 因为光波处于频谱的高频段，有很大的带宽，所以可以实现多路的波分复用

#### <span style="color: deepskyblue;">码</span>分复用（CDM)
##### 基本概念
- 复用方式与FDM和TDM不同：
  - 它既共享信道的频率
  - 又共享时间

##### CDMA原理
- 基本原理：
  - 将每个比特时间再划分成m个短的时间槽，称为码片（Chip）
  - 通常m的值是64或128，下例中为简单起见，设m为8
  - 每个站点被指派一个唯一的m位码片序列
  - 发送1时，站点发送它的码片序列
  - 发送0时，站点发送该码片序列的反码
  - 当两个或多个站点同时发送时，各路数据在信道中线性相加
  - 为了从信道中分离出各路信号，要求各个站点的码片序列相互正交

##### 简单理解
- A站向C站发出的信号用一个向量来表示
- B站向C站发出的信号用另一个向量来表示
- 两个向量要求相互正交
- 向量中的分量，就是所谓的码片

##### 具体示例
###### 基本设置
- 令向量s表示A站的码片向量，T表示B站的码片向量
- A站的码片序列被指派为00011011：
  - 发送00011011表示发送比特1
  - 发送11100100表示发送比特0
- 为了方便计算：
  - 将码片中的0写为-1
  - 将1写为+1
  - 因此A站的码片序列是(-1-1-1+1+1-1+1+1)

###### 数学原理
- 不同站的码片序列相互正交：
  $S\mathbf{\cdot}T\equiv\frac{1}{m}\sum_{i=1}^{m}S_{i}T_{i}=0$

- 任何站的码片向量和该码片向量自身的规格化内积都是1：
  $S\bullet S={\frac{1}{m}}\sum_{i=1}^{m}S_{i}S_{i}={\frac{1}{m}}\sum_{i=1}^{m}S_{i}^{2}={\frac{1}{m}}\sum_{i=1}^{m}(\pm1)^{2}=1$

- 任何站的码片向量和该码片反码的向量的规格化内积都是-1：
  $S\bullet\overline{{S}}=\frac{1}{m}\sum_{i=1}^{m}S_{i}\,\overline{{S_{i}}}=-\frac{1}{m}\sum_{i=1}^{m}S_{i}^{2}=-1$

###### 实际计算
- 令向量T为(-1-1+1-1+1+1+1-1)8
- 当A站向C站发送数据1时，发送向量(-1-1-1+1+1-1+1+1)
- 当B站向C站发送数据0时，发送向量(+1+1-1+1-1-1-1+1)
- 两个向量在公共信道上叠加，线性相加得到：
  $S+\overline{{{T}}}=\left(\begin{array}{c c c c c c c}{{0}}&{{0}}&{{-2}}&{{2}}&{{0}}&{{-2}}&{{0}}&{{2}}\end{array}\right)$

>pro：码分复用中数据分离的计算（2014）  

###### 数据分离
- 到达C站后进行数据分离：
  - 若要得到来自A站的数据：
    - C站必须知道A站的码片序列
    - 让s与s+T进行规格化内积
    - 根据叠加原理，其他站点的信号都在内积的结果中被过滤掉
    - 内积的相关项都是0，而只剩下A站发送的信号
    - 得到：$S\bullet(S+\overline{{{T}}})=1$
    - 所以A站发出的数据是1
  - 同理，若要得到来自B站的数据：
    - $T\bullet(S+{\overline{{T}}})=-1$
    - 因此从B站发送过来的信号向量是一个反码向量，代表0

##### 直观理解
- 假设场景：
  - A站要向C站运输黄豆
  - B站要向C站运输绿豆
  - A站和B站与C站之间有一条公共的道路，可类比为广播信道

- 不同复用方式的比较：
  - 频分复用：
    - 公共道路被划分为两个车道
    - 分别提供给A站到C站的车和B站到C站的车通行
    - 两类车可同时通行，但都只分到了公共车道的一半
    - 因此频分复用（波分复用也一样）共享时间而不共享空间
  - 时分复用：
    - 先让A站到C站的车走一趟
    - 再让B站到C站的车走一趟
    - 两类车交替地使用公共车道
    - 因此时分复用共享空间，但不共享时间
  - 码分复用：
    - 黄豆与绿豆放在同一辆车上运送
    - 到达C站后，由C站负责把车上的黄豆和绿豆分开
    - 因此码分复用既共享空间，又共享时间

##### 优点
- 频谱利用率高
- 抗干扰能力强
- 保密性强
- 语音质量好
- 可以减少投资及降低运行成本
- 主要应用：
  - 用于无线通信系统
  - 特别是移动通信系统

## <span style="color: LightSkyBlue;">随机</span>访问<span style="color: purple;">介质</span>访问控制  

>pro：信道划分与随机访问介质访问控制的特点（2014）  

- 在随机访问协议中
  - 不采用集中控制方式解决发送信息的次序问题
  - 所有用户都能根据自己的意愿随机地发送信息，占用信道的全部速率
  - 在总线形网络中
    - 当有两个或多个用户同时发送信息时，就会产生帧冲突（也称碰撞）
    - 导致所有冲突用户的发送均以失败告终
  - 为了解决随机访问发生的冲突
    - 每个用户需要按照一定的规则反复地重传它的帧，直到该帧无冲突地通过
    - 这些规则就是随机访问介质访问控制协议
      - 其核心思想是：胜利者通过争用获得信道，进而获得信息的发送权
  - 因此，随机访问介质访问控制协议又称**争用型协议**。

- 可见，若采用信道划分机制
  - 则结点之间的通信要么共享空间，要么共享时间，要么共享空间和时间
- 而若采用随机访问控制机制
  - 则结点之间的通信既不共享时间，又不共享空间
  - 因此，随机介质访问控制实质上是一种将广播信道转换为点到点信道的机制


### <span style="color: pink;">ALOHA</span>协议  
*add the definition personally*
- ALOHA本身就是一个单词，源自夏威夷语，意为"你好"或"爱"
- 早期的网络通信协议，主要用于无线局域网的数据传输
- 起源于20世纪70年代的夏威夷大学，设计用于解决多个用户通过共享媒介（如无线电波）发送数据时可能发生的冲突问题

#### 1. 纯ALOHA协议  

- 基本思想：
  - 当总线形网络中的任何站点需要发送数据时，可以不进行任何检测就发送数据
  - 若在一段时间内未收到确认，则该站点就认为传输过程中发生了冲突
  - 发送站点需要等待一段时间后再发送数据，直至发送成功

- 工作原理：
  - 每个站均可自由地发送数据帧
  - 所有帧都是定长的，帧长用发送这个帧所需的时间来表示（用T₀表示）

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/ae9a115a7e4fbb1e8ae3ec162449673ea9bdc2251aced1d68bb09e49b721c595.jpg)  
图3.19纯ALOHA协议的工作原理  

- 发送情况示例：
  - 站1发送帧1时成功（因其他站未发送数据）
  - 站2和站N-1发送的帧2和帧3发生冲突
    - 发生冲突后需等待随机时间再重传
    - 若再次冲突，需继续等待随机时间直到成功
  - 帧4发送成功
  - 帧5和帧6发生冲突

#### 2. 时隙ALOHA协议  

- 基本特点：
  - 同步各站点的时间
  - 将时间划分为一段段等长的时隙
  - 规定站点只能在每个时隙开始时才能发送帧
  - 发送一帧的时间必须小于或等于时隙的长度

- 优势：
  - 避免了用户发送数据的随意性
  - 降低了产生冲突的可能性
  - 提高了信道的利用率

- 工作原理：
  - 每个帧到达后需在缓存中等待小于时隙T₀的时间才能发送
  - 一个时隙内有两个以上帧到达时，下一时隙将产生冲突
  - 冲突后重传策略与纯ALOHA协议相似

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/eab8d419e4bb0d1523f4496ef9b820a30d21ab1ae79b7a85d33598e667eac4dc.jpg)  
图3.20时隙ALOHA协议的工作原理
### <span style="color: green;">C</span>S<span style="color: SlateBlue;">M</span><span style="color: LightSkyBlue;">A</span>协议  <span style="color: gray; font-size: 14px;">载波监听 多路访问 (Carrier Sense Multiple Access)</span>

- ALOHA网络发生冲突的概率很大
- 若每个站点在发送前都先监听公用信道，发现信道空闲后再发送，则会大大降低冲突的可能性，从而提高信道的利用率，载波监听 多路访问（Carrier Sense Multiple Access，CSMA）
- CSMA ALOHA一种改进协议，它与ALOHA协议的主要区别是多了一个载波监听装置

#### 1. 分类
根据监听方式和监听到信道忙后的处理方式的不同，CSMA协议分为三种。  

##### (1) 1-坚持CSMA  
- 基本思想：
  - 当站点要发送数据时，首先监听信道
  - 若信道空闲，则立即发送数据
  - 若信道忙，则继续监听直至信道空闲
- 名称含义：
  - "坚持"的含义是监听到信道忙时，继续坚持监听信道
  - "1"的含义是监听到信道空闲时，立即发送帧的概率为1

##### (2) 非坚持CSMA  
- 基本思想：
  - 当站点要发送数据时，首先监听信道
  - 若信道空闲，则立即发送数据
  - 若信道忙，则放弃监听，等待一个随机的时间后，再重新监听
- 特点：
  - 降低了多个站点等待信道空闲后同时发送数据导致冲突的概率
  - 增加了数据在网络中的平均时延

#####  (3) p-坚持CSMA  
- 适用范围：
  - 只适用于时分信道
- 基本思想：
  - 当站点要发送数据时，首先监听信道
  - 若信道忙，则持续监听（即等到下一个时隙再监听），直至信道空闲
  - 若信道空闲，则以概率p发送数据，以概率1-p推迟到下一个时隙再继续监听
  - 直到数据发送成功
- 特点：
  - 以概率p发送数据的目的是降低1-坚持CSMA中多个站点检测到信道空闲时同时发送帧的冲突概率
  - 采用坚持"监听"的目的是克服非坚持CSMA中因随机等待造成的延迟时间较长的缺点
  - 是非坚持CSMA协议和1-坚持CSMA协议的折中

三种不同类型的CSMA协议比较如表3.1所示。  

表3.1三种不同类型的CSMA协议比较
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/ab84e37ae6367358ae2338fa8eca6764402a28f7d79e8aa56a3fff0a09f8d685.jpg)
### CSMA/ <span style="color: Gold;">C</span><span style="color: green;">D</span> <span style="color: gray; font-size: 14px;">Conflict detection</span>协议  

>pro：CSMA/CD协议的特点（2015）  

#### 基本概念与适用范围
- 载波监听多路访问/冲突检测（CSMA/CD）协议是CSMA协议的改进方案
  - 适用于总线形网络或半双工网络环境
  - 对于全双工网络不需要CSMA/CD协议
    - 因为全双工采用两条信道，分别用来发送和接收
    - 在任何时候，发收双方都可以发送或接收数据，不可能产生冲突

#### 工作原理
- 载波监听
  - 每个站点在发送前和发送过程中都必须不停地检测信道
  - 发送前检测是为了获得发送权
  - 发送过程中检测是为了及时发现发送的数据是否发生冲突
- 冲突检测（CollisionDetection）
  - 边发送边监听
  - 若监听到冲突，则立即停止数据发送
  - 等待一段随机时间后，重新开始尝试发送数据
- 工作流程可简单概括为"先听后发，边听边发，冲突停发，随机重发"

>pro：信道发生冲突的最短、最长时间的分析（2010）  

#### 信道冲突分析
##### 传播时延影响
- 电磁波在总线上的传播速率有限
- 当某时刻发送站检测到信道空闲时，信道不一定空闲

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/ae240d111343b3cca19a39fb51a2804acf5f10feb02fe6219bbbe3043615b345.jpg)  
图3.21传播时延对载波监听的影响  

##### 争用期概念
- 端到端传播时延的2倍称为争用期（又称冲突窗口）
- 每个站在自己发送数据后的一小段时间内存在发生冲突的可能性
- 只有经过争用期这段时间还未检测到冲突时，才能确定这次发送不会发生冲突

>pro：CSMA/CD最短帧长的理解和相关计算（2009、2016、2019、2022）  

#### 最短帧长规定
##### 计算方法
- 最短帧长 = 总线传播时延 × 数据传输速率 × 2

##### 具体应用
- 以太网规定
  - 51.2μs为争用期的长度
  - 10Mb/s的以太网在争用期内可发送512bit（64B）
  - 最短帧长为64B
- 填充规则
  - 若只发送小于64B的帧，需要在MAC子层中于数据字段后面加填充字段
  - 保证以太网的MAC帧长度不小于64B

>pro：二进制指数退避算法的应用（2023）  

#### 冲突处理机制
##### 二进制指数退避算法
- 基本退避时间确定
  - 一般取2倍的总线端到端的传播时延2τ
- 重传时间计算
  - 从离散整数集合[0,1,⋯,(2k-1)]中随机取数r
  - 重传推迟时间为r倍的争用期
  - k = min[重传次数，10]
- 重传限制
  - 重传达16次仍不成功时认为该帧无法正确发出
  - 抛弃该帧并向高层报告出错

#### CSMA/CD算法流程
1. 准备发送
   - 适配器从网络层获得分组
   - 封装成帧，放入适配器缓存
2. 检测信道
   - 信道空闲则开始发送
   - 信道忙则持续检测直至空闲
3. 发送过程中持续检测
   - 发送成功：争用期内未检测到冲突
   - 发送失败：争用期内检测到冲突，执行指数退避算法

### CSMA/ <span style="color: Gold;">C</span><span style="color: DarkRed;">A</span> <span style="color: gray; font-size: 14px;">Collision Avoidance</span>协议  

#### 协议背景
##### 无法使用CSMA/CD的原因
1. 硬件成本问题
   - 接收信号强度远小于发送信号强度
   - 无线介质信号强度动态变化范围大
2. 隐蔽站问题
   - 并非所有站点都能够听见对方

>pro：需要使用确认方案的MAC协议（2011）  

#### 确认机制
- 使用链路层确认/重传（ARQ）方案
- 采用停止-等待协议进行可靠传输

#### 帧间间隔机制
>pro： CSMA/CA协议的IFS的特点（2020)  

##### IFS类型
1. SIFS（短IFS）
   - 最短的IFS
   - 用于分隔属于一次对话的各帧
2. PIFS（点协调IFS）
   - 中等长度的IFS
   - 在PCF操作中使用
3. DIFS（分布式协调IFS）
   - 最长的IFS
   - 用于异步帧竞争访问的时延

#### 虚拟载波监听
- 源站通知占用信道持续时间
- 其他站在此期间停止发送
- 减少冲突机会

#### CSMA/CA算法流程
1. 初始发送
   - 检测到信道空闲
   - 等待DIFS后发送整个数据帧
2. 退避机制
   - 执行CSMA/CA退避算法
   - 选取随机退避值
3. 发送与确认
   - 退避计时器为0时发送整个帧
   - 等待确认
4. 后续处理
   - 收到确认：准备发送下一帧
   - 未收到确认：重传该帧

####  处理隐蔽站问题： <span style="color: Gold;">R</span>T<span style="color: LightSkyBlue;">S</span>和<span style="color: green;">C</span>TS  <span style="color: gray; font-size: 14px;"> (Request To Send) & (Clear To Send)</span>

##### 隐蔽站问题产生原因
- 站A和站B都在AP的覆盖范围内，但相距较远
- 彼此都听不见对方
- 当检测到信道空闲时，都向AP发送数据，导致冲突发生

>pro：CSMA/CA协议进行信道预约的方法（2018）  

##### 解决方案：信道预约机制
###### 预约过程
- 源站发送前的准备：
  - 监听信道确认空闲
  - 等待DIFS时间
  - 广播RTS控制帧(包含源地址、目的地址和通信持续时间)

- AP的响应处理：
  - 正确接收RTS且信道空闲
  - 等待SIFS后发送CTS控制帧
  - CTS帧包含通信持续时间

- 数据传输流程：
  - 源站收到CTS后等待SIFS
  - 发送数据帧
  - AP正确接收后等待SIFS
  - 向源站发送ACK确认帧

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/c3ab7d2f814295e28c23f9b8d7d6e27883b83fde9116c67df227adcbfb64b071.jpg)  
图3.22A站和B站同时向AP发送信号，发生冲突  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/2674c2b5b366aab47d9a818ebdb238e29926b42fa0b01c12631f7f41d08ac0bc.jpg)  
图3.23使用RTS和CTS帧的冲突避免  

###### 时间计算
- RTS帧中的持续时间：
  - 从RTS帧发送完到ACK帧发送完
  - 计算公式：SIFS+CTS+SIFS+数据帧+SIFS+ACK

- CTS帧中的持续时间：
  - 从CTS帧发送完到ACK帧发送完
  - 计算公式：SIFS+数据帧+SIFS+ACK

##### 预约机制特点
- 效率影响：
  - RTS和CTS帧会略微降低通信效率
  - 但这两种帧都很短，开销相对较小
  - 比起冲突重发更节省时间

- 使用规则：
  - 非强制性规定
  - 各站可自行决定是否使用
  - 数据帧长超过特定值时较为划算

##### CSMA/<span style="color: Gold;">C</span><span style="color: green;">D</span>与CSMA/<span style="color: Gold;">C</span><span style="color: DarkRed;">A</span> <span style="color: gray; font-size: 14px;">的区别</span>
- 冲突处理方式：
  - CSMA/CD：可检测但无法避免冲突
  - CSMA/CA：无法检测但尽量避免冲突

- 应用环境：
  - CSMA/CD：用于总线形以太网
  - CSMA/CA：用于无线局域网802.11系列

- 检测机制：
  - CSMA/CD：通过电缆电压变化检测
  - CSMA/CA：采用能量检测、载波检测和混合检测

##### 总结
- CSMA/CA：
  - 发送前先广播告知
  - 要求其他站点在特定时间内不发送
  - 预防性避免冲突

- CSMA/CD：
  - 发送前监听
  - 边发送边监听
  - 发现冲突立即停止

## <span style="color: green;">轮询</span>访问：令牌传递协议 <span style="color: LightSkyBlue;">Token</span>  <span style="color: GreenYellow;">Passing</span> 

### 基本概念
- 轮询访问特点：
  - 用户不能随机发送信息
  - 通过集中控制的监控站以循环方式轮询每个结点
  - 再决定信道的分配
- 典型协议：令牌传递协议

### 工作原理
- 令牌(Token)沿环形总线在各站间依次传递
- 令牌特点：
  - 特殊的控制帧
  - 不包含信息
  - 仅控制信道使用
  - 确保同一时刻只有一个站独占信道
- 站点发送规则：
  - 必须等待并取得令牌才能发送
  - 发送完成后需释放令牌
  - 不会发生冲突(令牌唯一)
  - 访问权公平(按顺序传递)

### <span style="color: LightSkyBlue;">令牌</span>和<span style="color: blue;">数据</span> 传递过程
- 网络空闲时：
  - 环路中只有令牌帧循环传递
- 数据发送阶段：
  - 令牌到达有数据发送的站点时：
    - 修改令牌标志位
    - 附加传输数据
    - 将令牌变成数据帧
    - 发送数据帧
- 数据传输阶段：
  - 数据帧沿环路传输
  - 接收站点处理：
    - 转发数据
    - 查看目的地址
    - 地址匹配则复制数据帧
- 数据返回阶段：
  - 数据帧传回源站点
  - 源站点处理：
    - 不再转发
    - 检验传输是否出错
    - 出错则重传
- 传输完成阶段：
  - 重新产生令牌
  - 传递给下一站点
  - 交出信道控制权

###  <span style="color: Gold;">特点</span>
- 适用场景：
  - 负载很高的广播信道
  - 多个结点同时发送数据概率大的信道
- 优势：
  - 避免随机介质访问控制的冲突问题
  - 满足各站点通信需求
- 工作机制：
  - 不共享时间
  - 不共享空间
  - 限定只有一个结点有权发送数据

### 数据<span style="color: purple;">链路</span>层 通信<span style="color: Gold;">特点</span>
- 广播信道可通过介质访问控制机制变为逻辑上的
  - **点对点**信道
- 研究重点是"点到点"之间的通信


# <span style="color: green;">局</span>域网  LAN<span style="color: gray; font-size: 14px;">(Local Area Network)</span>

## 基本概念和体系结构  

### 定义与特点
- 局域网（LocalAreaNetwork，LAN）是指在一个较小的地理范围（如一所学校）内，将各种计算机、外部设备和数据库系统等通过双绞线、同轴电缆等连接介质互相连接起来，组成资源和信息共享的计算机互连网络
- 主要特点：
  - 为一个单位所拥有，且地理范围和站点数目均有限
  - 所有站点共享较高的总带宽（即较高的数据传输速率）
  - 较低的时延和较低的误码率
  - 各站为平等关系而非主从关系
  - 能进行广播和多播

### 三要素
- 局域网的特性主要由三个要素决定：
  - 拓扑结构
  - 传输介质
  - 介质访问控制方式
- 其中最重要的是介质访问控制方式，它决定着局域网的技术特性

#### 拓扑结构
- 常见的局域网拓扑结构主要有以下4大类：
  - $\textcircled{\scriptsize{1}}$ 星形结构
  - $\circledcirc$ 环形结构
  - $\textcircled{3}$ 总线形结构
  - $\textcircled{4}$ 星形和总线形结合的复合型结构

#### 传输介质
- 局域网可以使用铜缆、双绞线和光纤等多种传输介质
- 其中双绞线为主流传输介质

#### 介质访问控制方法
- 主要有三种协议：
  - CSMA/CD协议（用于总线形局域网）
  - 令牌总线协议（用于总线形局域网）
  - 令牌环协议（用于环形局域网）

### 特殊局域网拓扑实现
- 以太网（目前使用范围最广）
  - 逻辑拓扑是总线形结构
  - 物理拓扑是星形结构
- 令牌环（TokenRing，IEEE802.5）
  - 逻辑拓扑是环形结构
  - 物理拓扑是星形结构
- FDDI（光纤分布数字接口，IEEE802.8）
  - 逻辑拓扑是环形结构
  - 物理拓扑是双环结构

### IEEE802标准与OSI参考模型
- IEEE802标准定义的局域网参考模型特点：
  - 只对应于OSI参考模型的数据链路层和物理层
  - 将数据链路层拆分为两个子层：
    - 逻辑链路控制（LLC）子层
    - 介质访问控制（MAC）子层

#### MAC子层
- 与接入传输介质有关的内容都放在MAC子层
- 向上层屏蔽对物理层访问的各种差异
- 主要功能：
  - 组帧和拆卸帧
  - 比特传输差错检测
  - 透明传输

#### LLC子层
- 与传输介质无关
- 向网络层提供四种不同的连接服务类型：
  - 无确认无连接
  - 面向连接
  - 带确认无连接
  - 高速传送

### 现状
- 以太网在局域网市场中占据垄断地位，几乎成为局域网的代名词
- 802委员会制定的LLC子层作用已经不大
- 许多网卡仅装MAC协议而不装LLC协议

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/16c71a620ddded21f3ab9edcb32be26696a427239d32f2fc4cc82b8d8ddad874.jpg)  
图3.24IEEE802协议层与OSI参考模型的比较
## <span style="color: purple;">以太</span>网<span style="color: gray; font-size: 14px;">Ethernet</span>& IEEE802.3

### 概述
一种广泛使用的局域网（LAN）技术
- 定义了计算机和其他网络设备如何在物理层和数据链路层进行通信
#### 发展历程
- 以太网规约的发展:
  - 第一个版本是DIXV1
    - 由DEC、Intel和Xerox联合提出
  - 第二版规约DIXEthermnetV2
    - 是世界上第一个局域网产品的规约
  - IEEE802.3标准
    - 由IEEE802委员会的IEEE802.3工作组制定
    - 是第一个IEEE的以太网标准

#### 基本特点
- 网络地位
  - 是目前最流行的有线局域网技术
- 网络结构
  - 逻辑上采用总线形拓扑结构
  - 所有计算机共享同一条总线
- 通信方式
  - 信息以广播方式发送
  - 使用CSMA/CD方式对总线进行访问控制

#### 标准说明
- DIX Ether mnet V 2，DIX Ethernet V 2 IEEE802.3标准的差别很小
- 通常将802.3局域网简称为以太网

>pro：以太网MAC协议提供的服务类型（2012）  

#### 通信简化措施
- 采用无连接的工作方式
  - 不对发送的数据帧编号
  - 不要求接收方发送确认
  - 尽最大努力交付数据，提供不可靠服务
  - 差错纠正由高层完成
- 发送数据使用曼彻斯特编码信号
  - 每个码元中间出现一次电压转换
  - 接收方利用电压转换提取位同步信号

### <span style="color: purple;">以太</span>网的传输介质与网卡

#### 传输介质
##### 介质类型
- 常用4种传输介质：
  - 粗缆
  - 细缆
  - 双绞线
  - 光纤

表3.2各种传输介质的适用情况
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/3dea384933fe4b050f28d3dbd4a48eedd11df3f4fd270e10c83edbb8a2448575.jpg)  

>attention:  

##### 标准说明
- 命名规则：
  - 10指标准速率为10Mb/s
  - Base指基带以太网
  - Base之后的5或2指单段最大传输距离不超过500m或185m
  - Base之后的T指双绞线，F指光纤

#### 网络适配器
##### 基本特征
- 连接方式
  - 通过主板上嵌入的网络适配器实现计算机与外界局域网的连接
- 硬件组成
  - 适配器上装有处理器和存储器
- 工作层次
  - 工作在数据链路层

##### 通信方式
- 适配器和局域网
  - 通过电缆或双绞线以串行方式进行
- 适配器和计算机
  - 通过计算机的IO总线以并行方式进行

##### 主要功能
- 物理层功能
  - 实现与局域网传输介质之间的物理连接和电信号匹配
  - 数据的编码与解码
  - 数据的串并转换
- 数据链路层功能
  - 帧的发送与接收
  - 帧的封装与拆封
  - 介质访问控制
  - 数据缓存
### 以太网的MAC地址

#### 基本概念
- IEEE802标准规定：
  - **48**位全球地址
  - 固化在适配器的ROM中
  - 称为物理地址或MAC地址
  - 用于控制主机在网络上的数据通信

>pro：以太网MAC地址的长度（2013）  

#### MAC地址特点
- 格式：
  - 长6字节
  - 用12个十六进制数表示（由连字符或冒号分隔）
  - 如02-60-8c-e4-b1-21
  - 高24位为厂商代码
  - 低24位为厂商自行分配的适配器序列号

#### MAC地址应用
- 路由器接口：
  - 适配器上的MAC地址标志路由器的接口
  - 连接两个网络需要两个适配器和两个MAC地址

- 帧接收处理：
  - 适配器用硬件检查MAC帧中的目的地址
  - 发往本站的帧包括三种：
    1. 单播帧（一对一）：目的地址与本站MAC地址相同
    2. 广播帧（一对全体）：发送给本局域网上所有站点
    3. 多播帧（一对多）：发送给本局域网上一部分站点
### 以太网的<span style="color: pink;">MAC</span><span style="color: LightSkyBlue;">帧</span>  

#### 格式标准
- 两种标准：
  - DIX Ethernet V2标准（即以太网V2标准）
  - IEEE 802.3标准
- 这里介绍最常用的以太网V2的MAC帧格式

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/335c6fdb9bafd3bdfa0928452310b671659a80125d05ada1c9a171de77cb363b.jpg)  
图3.25以太网V2标准的MAC帧格式  

> pro: 以太网帧首部的内容、首部和尾部的长度（2010、2011）  

#### 结构组成
##### 前<span style="color: LightSkyBlue;">导码</span>
- 8字节，分为两个字段：
  -  <span style="color: GreenYellow;">7</span>字节前<span style="color: LightSkyBlue;">同步</span>码：
     -  实现MAC帧的比特同步
  - **1**字节帧开始<span style="color: green;">定界</span>符：
    - 表示后面的信息是MAC帧

>attention:  

##### 帧结束定界符说明
- 以太网帧特点：
  - 不需要帧结束定界符
  - 帧之间必须有间隙
  - 接收方只需找到帧开始定界符即可确定同一帧的比特流

- 帧结束判定方法：
  - 基于曼彻斯特编码特性：
    - 每个码元中间有电压跳变
    - 发送完帧后电压不再变化
  - 定位过程：
    - 接收方检测到电压不变位置
    - 向前数4字节为FCS字段
    - 由此确定数据字段结束位置

>pro：以太网帧中目的地址和源地址的含义（2018）  

##### 地址字段
- 目的地址：
  - 6字节
  - 帧在局域网上的目的适配器的MAC地址
- 源地址：
  - 6字节
  - 传输帧到局域网上的源适配器的MAC地址

##### 类型字段
- 2字节
- 指出数据字段中的数据应交给哪个上层协议处理
- 如网络层的IP协议

> pro: 分析IP首部并判断其以太帧是否需要填充（2012）  

##### 数据字段
- 46~1500字节
- 承载上层的协议数据单元（如IP数据报）
- 特点：
  - 最大传输单元1500字节
  - IP数据报超过1500字节需分片
  - 最小长度46字节，不足需填充

>attention:  

46是怎么来的？由CSMA/CD可知以太网帧的最短帧长为64B，而MAC帧的首部和尾部的长度为18字节，所以数据字段最短为 $64-18=46$ 字节。  

##### 检验码（FCS）
- 4字节
- 特点：
  - 采用32位CRC码
  - 检验范围：目的地址段到数据字段
  - 不检验前导码

#### IEEE 802.3帧格式特点
- 与以太网V2帧格式的区别：
  - 用长度域替代类型域
  - 指出数据域长度
- 两种机制并存原理：
  - IEEE 802.3数据段最大字节数1500
  - 长度段最大值1500
  - 1501到65535的值用于类型段标识符

### 高速以太网  

#### 基本概念
- 定义：速率达到或超过100Mb/s的以太网
- 分类见表3.3

表3.3几种高速以太网技术
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/c6d6e330faf79cc8e82e7e93152cc261305eb48d81b2a32610c15a7ec1713421.jpg)  

#### 100BASE-T以太网  

命题追踪100BaseT以太网使用的传输介质（2019）  

##### 基本特征
- 传输方式：
  - 双绞线上传送100Mb/s基带信号
  - 星形拓扑以太网
- 工作模式：
  - 支持全双工和半双工
  - 全双工模式下无冲突，不使用CSMA/CD

##### 技术规范
- MAC帧格式：遵循802.3标准
- 网络参数：
  - 最短帧长不变
  - 网段最大长度减至100m
  - 帧间最小间隔从9.6μs改为0.96μs

#### 吉比特以太网  

##### 基本特征
- 又称千兆以太网
- 速率：1Gb/s
- 工作模式：
  - 支持全双工和半双工
  - 半双工使用CSMA/CD
  - 全双工不使用CSMA/CD

##### 技术规范
- 使用802.3协议帧格式
- 传输介质：双绞线或光纤
- 兼容性：与10BASE-T和100BASE-T向后兼容

#### 10吉比特以太网  

##### 技术特点
- 帧格式：与其他速率以太网相同
- 保留802.3标准规定的帧长限制
- 仅工作在全双工方式
- 不使用CSMA/CD协议

##### 以太网演进特点
- 可扩展性：从10Mb/s到10Gb/s
- 灵活性：
  - 多种传输介质
  - 全/半双工
  - 共享/交换
- 易于安装
- 稳健性好
## IEEE**802.11**<span style="color: SlateBlue;">无</span><span style="color: Gold;">线</span><span style="color: green;">局</span>域网  

### 组成  

#### 分类
- 两大类：
  - 有固定基础设施的无线局域网
  - 无固定基础设施的移动自组织网络
- "固定基础设施"指预先建立的、能覆盖一定地理范围的固定基站

#### 有<span style="color: green;">固定</span><span style="color: LightSkyBlue;">基础设施</span>(**B**asic **S**ervice **S**et)~ <span style="color: gray; font-size: 14px;">Wi-Fi</span>
##### IEEE 802.11标准特点 
- 使用 <span style="color: Gold;">星形</span>拓扑
- 中心称为 接入点(<span style="color: green;">A</span><span style="color: LightSkyBlue;">P</span>)
- MAC层使用CSMA/CA协议
  - 又称wifi

##### 基本服务集(**B**SS)
- 组成：
  - 一个<span style="color: green;">A</span><span style="color: LightSkyBlue;">P</span> + 若干移动站
    - 通信必须通过BSS的AP
- <span style="color: green;">A</span><span style="color: LightSkyBlue;">P</span>配置要求：
  - 分配不超过32字节的SSID
  - 分配信道
- 基本服务区(BSA)：
  - 覆盖范围直径一般不超过100m

##### 扩展服务集(<span style="color: LightSkyBlue;">E</span>SS)
- 构成：
  - BSS通过<span style="color: green;">A</span><span style="color: LightSkyBlue;">P</span> <span style="color: GreenYellow;">连接</span>到 分配系统(DS)
    - → 连接到另一个BSS
- 功能：
  - 对上层表现 如同一个BSS
  - 可通过Portal设备连接有线以太网

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/9eb5ed824fc2a3b0a59ba485fd71622971ce829bb5fd78ba76982d77f4d615a1.jpg)  
图3.26基本服务集和扩展服务集  

#### <span style="color: SlateBlue;">无</span><span style="color: green;">固定</span><span style="color: LightSkyBlue;">基础设施</span>  <span style="color: GreenYellow;">移动</span>自组织网络 <span style="color: gray; font-size: 14px;">Independent BSS</span>
##### 特点
- 又称自组网络(ad-hoc network)
- 无AP，由平等状态的移动站组成
- 各节点地位平等
- 中间节点具有路由器功能

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/5e9beabbfb4f9fccf1dcc1a93424962aa72ecf19782692558da976e534935427.jpg)  
图3.27由一些处于平等状态的便携机构成的自组网络  

##### 构成方式
- 移动设备发现附近其他设备
- 要求与其他移动设备通信
- 每个移动站参与路由发现和维护
- 网络拓扑可能随时间快速变化

##### 与移动IP的区别
- 移动IP：
  - 基于固定网络的路由选择协议
  - 允许漫游主机连接因特网
- 自组网络：
  - 扩展到无线领域的自治系统
  - 具有特定路由选择协议
  - 可以不连接因特网

### **802.11**局域网的MAC帧  

#### MAC帧类型
- 三种类型：
  - 数据帧
  - 控制帧
  - 管理帧

#### 数据帧组成
- MAC首部：30字节
- 帧主体：不超过2312字节
- 帧检验序列FCS：4字节

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/3f40c912ceedd23f85edb5439bf521f26f450fa378bb77273726767fa923d3b9.jpg)  

>pro：802.11数据帧前三个地址的含义（2017、2022）  

#### 地址字段说明
##### 基本概念
- 四个地址字段(MAC地址)
- 前三个地址内容取决于帧控制字段
- 地址4用于自组网络

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f3eaebbc5f5d12579fab4e4c209783bca0171b7a4b8180336806e93b3506e840.jpg)  

##### 地址使用场景
###### BSS内通信
- A站向B站发送：
  - 帧控制："去往AP=1"，"来自AP=0"
  - 地址1：AP的MAC地址
  - 地址2：A站的MAC地址
  - 地址3：B站的MAC地址

- AP转发给B站：
  - 帧控制："去往AP=0"，"来自AP=1"
  - 地址1：B站的MAC地址
  - 地址2：AP的MAC地址
  - 地址3：A站的MAC地址

###### 复杂通信场景
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/e7f833269a3e7b7cb8b5ed61e42cde3731f90a609e1648ec60c7c6c56d6e5f14.jpg)  
图3.29链路上的802.11帧和802.3帧  

- 路由器向A站发送：
  - 路由器发送802.3帧：
    - 源地址：R1的MAC地址
    - 目的地址：A站的MAC地址
  - AP转换为802.11帧：
    - 帧控制："去往AP=0"，"来自AP=1"
    - 地址1：A站的MAC地址
    - 地址2：AP的MAC地址
    - 地址3：R1的MAC地址

- A站向路由器发送：
  - A站发送802.11帧：
    - 帧控制："去往AP=1"，"来自AP=0"
    - 地址1：AP的MAC地址
    - 地址2：A站的MAC地址
    - 地址3：R1的MAC地址
  - AP转换为802.3帧：
    - 源地址：A站的MAC地址
    - 目的地址：R1的MAC地址

## VLAN <span style="color:gray; font-size: 14px;">(virtual lan) 

### 概念
- 一个以太网是一个 <span style="color: GreenYellow;">广播</span>域，当一个以太网中包含的计算机太多时，往往会导致：
  - 以太网中出现大量的广播帧，特别是经常使用的ARP和DHCP协议（第4章）
  - 一个单位的不同部门共享一个局域网，对信息保密和安全不利
- 通过虚拟局域网（VirtualLAN，VLAN)，可将一个较大的局域网分割成一些较小的与地理位置无关的逻辑上的VLAN，而每个VLAN是一个较小的广播域

### 划分方式
- 基于接口
  - 将交换机的若干接口划为一个逻辑组
  - 这种方法最简单、最有效
  - 若主机离开了原来的接口，则可能进入一个新的子网
- 基于MAC地址
  - 按MAC地址将一些主机划分为一个逻辑子网
  - 当主机的物理位置从一个交换机移动到另一个交换机时，它仍属于原来的子网
- 基于IP地址
  - 根据网络层地址或协议划分VLAN
  - 这样的VLAN可以跨越路由器进行扩展，将多个局域网的主机连接在一起

### 帧格式
- 802.3ac标准定义了支持VLAN的以太网帧格式的扩展
  - 在以太网帧中插入一个4字节的标识符（插在源地址字段和类型字段之间）
  - 称为VLAN标签，用来指明发送该顿的计算机属于哪个虚拟局域网
  - 插入VLAN标签的帧称为802.1Q顿
  - 以太网的最大帧长从原来的1518字节变为1522字节

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/1fa3727e65c66ef56fbed43250bdacfe8219a92ec3a163fb8a0fb3a860dc6465.jpg)  
图3.30插入VLAN标签后变成了802.1Q帧  

#### 标签结构
- 前两个字节总是置为 $0x8100$，表示这是一个802.1Q帧
- 后两个字节
  - 前4位实际上并没什么作用
  - 后12位是该VLAN的标识符VID，唯一标识该802.1Q顺属于哪个VLAN
  - 12位的VID可识别4096个不同的VLAN
- 插入VLAN标签后，802.1Q帧最后的FCS必须重新计算

### 工作原理
- 交换机配置
  - 交换机1连接7台计算机，划分为VLAN-10和VLAN-20
  - VID值由交换机管理员设定
  - 各主机不知道自己的VID值，但交换机必须知道
  - 主机与交换机之间交互的都是标准以太网帧

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/dd404bb6f4326a5aaef9831d2ab0187e38a5a00c9a33d5c1bef9ca4561b86ddf.jpg)  
图3.31利用以太网交换机构成虚拟局域网  

#### 通信场景
- 同一交换机内VLAN通信
  - A站向B站发送帧：交换机1直接转发帧
- 跨交换机同VLAN通信
  - A站向E站发送帧：
    - 交换机1插入VLAN标签后转发
    - 交换机2移除VLAN标签后转发给E站
- 不同VLAN间通信
  - A站向C站发送帧：
    - 需要通过上层路由器
    - 或使用交换机中嵌入专用芯片进行转发

### 本质
- 虚拟局域网只是局域网为用户提供的一种<span style="color: green;">服务</span>，并不是一种新型局域网
  
#  <span style="color: Gold;">广</span>域网  

## 基本概念  

### 定义与特点
- 覆盖范围
  - 覆盖范围很广
  - 远超一个城市的范围的长距离网络

- 主要任务
  - 长距离运送主机所发送的数据

- 链路特征
  - 连接厂域网各结点交换机的链路都是高速链路
  - 通信容量必须足够大
    - 支持日益增长的通信量

### 与互联网的关系
- 区分概念
  - 广域网不等于互联网
  
- 互联网特点
  - 可以连接不同类型的网络
  - 通常使用路由器来连接

- 通信方式
  - 局域网可以通过广域网与另一个相隔很远的局域网通信

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/fa20b8aff01d6411522b5859a6d1ef29ac82c032e885c56b3830863eac73e4c8.jpg)  
图3.32由局域网和广域网形成的互联网  

### 组成与工作原理
- 基本组成
  - 结点交换机
  - 连接链路

- 工作特点
  - 结点交换机功能
    - 存储并转发分组
  - 连接方式
    - 结点之间都是点到点连接
    - 一个结点交换机往往与多个结点交换机相连以提高可靠性

### 广域网与局域网的区别
- 层次区别
  - 局域网：mainly use数据<span style="color: blue;">链路</span>层协议
  -  <span style="color: Gold;">广</span>域网：mainly use <span style="color: Gold;">网络</span>层协议

- 其他区别
  - 具体区别与联系见表3.5

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/5405276467369b2d85907054b6143b147698e5110094dc13809916dce8e72eac.jpg)  

## PPP协议 <span style="color: gray; font-size: 14px;">Point-to-Point Protocol</span>

### 概述
- 是现在最流行的点对点链路控制协议
- 主要应用
  - 用户计算机与ISP通信时所用的数据链路层协议
  - 广域网路由器之间的专用线路

### 组成
- 链路控制协议（LCP）
  - 用来建立、配置、测试数据链路连接
  - 协商一些选项
- 网络控制协议（NCP）
  - 为不同网络层协议配置
  - 建立和配置逻辑连接
- IP数据报封装方法
  - IP数据报在PPP帧中作为信息部分
  - 长度受MTU限制

### 帧格式
- 帧结构如图3.33所示

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/1e8d91d9da44885d266b032830b73b1f319582eddaad40c563b504eeddffc9ef.jpg)  
图3.33PPP帧的格式  

#### 首部字段
- 标志字段(F)：0x7E
- 地址字段(A)：0xFF
- 控制字段(C)：0x03
- 协议字段：2字节
  - 0x0021表示IP数据报
  - 0xC021表示LCP数据

#### 信息字段
- 长度可变(0~1500字节)

>attention:  
因为PPP是点对点的，并不是总线形，所以无须使用CSMA/CD协议，自然就不会有最短帧长的限制，所以信息段占 $0\sim1500$ 字节，而不是46\~1500学节。  

#### 尾部字段
- 帧检验序列(FCS)：2字节，使用CRC检验

### PPP协议状态图及工作过程
- 状态图如图3.34所示

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/d94ee3aeefa6ea19b8d920eb532cdff20689de0539f58617c2802450a1044797.jpg)  
图3.34PPP协议的状态图  

#### 工作状态流程
- 链路静止状态
- 链路建立状态
- 鉴别状态
- 网络层协议状态
- 链路打开状态
- 链路终止状态

###  <span style="color: Gold;">特点</span>
- 不使用序号和确认机制，只保证无差错接收
  - 只支持全双工的点对点链路
  - 两端可运行不同网络层协议
- 面向 <span style="color: GreenYellow;">字节</span>
  - 帧长为整数个字节
 

# <span style="color: LightSkyBlue;">设备</span>  

## *网<span style="color: green;">桥</span>

### 工作原理
- 使用集线器在物理层扩展以太网会形成更大的冲突域
- 为了避免这个问题，可以使用网桥在数据链路层扩展以太网，而原来的每个以太网称为一个网段
- 网桥具有识别帧和转发帧的能力
  - 根据帧首部中的目的MAC地址和网桥的帧转发表来转发或丢弃所收到的帧
  - 起到了过滤通信量的功能
- 各个网段是相对独立的，一个网段的故障不影响另一个网段的运行

### 连接方式
- 网络1和网络2通过网桥连接后
  - 网桥接收网络1发送的数据帧，检查数据帧中的地址
    - 若是网络2的地址，则转发给网络2
    - 若是网络1的地址，则将其丢弃

### 现状
- 网桥是早期的数据链路层设备，现已被以太网交换机取代，最新大纲中已将其删除

## <span style="color: purple;">以太</span>网<span style="color: green;">交换机</span>  

### 原理和特点  

#### 基本原理
- 以太网交换机也称二层交换机
  - 二层: 工作在数据链路层
- 实质是一个 多<span style="color: GreenYellow;">接口</span>的 网<span style="color: green;">桥</span>
  - 能将网络分成小的冲突域
  - 为每个用户提供更大的带宽

####  <span style="color: GreenYellow;">带</span><span style="color: LightSkyBlue;">宽</span> <span style="color: green;">分配</span>
- <span style="color: green;">集</span><span style="color: Gold;">线</span>器的共享式10Mb/s以太网
  - 若共有N个用户，则每个用户的平均带宽为总带宽(10Mb/s)的$1/N$
- 以太网交换机(全双工方式)
  - 每个接口到主机的<span style="color: GreenYellow;">带</span><span style="color: LightSkyBlue;">宽</span> 都是10Mb/s
    - 用户通信时是独占带宽的
  - 拥有N个接口的交换机的**总容量**: N×10Mb/s

>pro：以太网交换机的特点（2015）  

#### 主要特点
1. 可工作在全双工方式
   - 当交换机的接口直接与主机或其他交换机连接时
   - 能同时连通多对接口
   - 无冲突地传输数据
   - 不需要使用CSMA/CD协议

2. 半双工工作模式
   - 当交换机的接口连接集线器时
   - 只能使用CSMA/CD协议
   - 只能工作在半双工方式

3. 即插即用功能
   - 内部的帧转发表通过自学习算法建立
   - 基于网络中各主机间的通信自动逐渐建立

4. 高速交换性能
   - 使用专用交换结构芯片
   - 交换速率较高

5. 带宽特性
   - 交换机独占传输介质的带宽

>pro：直通交换方式的转发时延的分析（2013）  

#### 交换模式
1. 直通交换方式
   - 只检查帧的目的MAC地址
   - 决定该帧的转发接口
   - 交换时延非常小
   - 缺点：不检查差错就直接转发

2. 存储转发交换方式
   - 将接收到的帧缓存到高速缓存器中
   - 检查数据是否正确
   - 通过查找表转换为输出接口
   - 优点：可靠性高，支持不同速率接口间的转换
   - 缺点：时延较大

####  <span style="color: GreenYellow;">接口</span>速<span style="color: SlateBlue;">率</span>
- 具有多种速率的接口
  - 10Mb/s
  - 100Mb/s
  - 多速率自适应接口

### 自学习功能  

>pro：以太网交换机转发决策时使用的PDU地址（2009）  

#### 过滤和转发机制
- 过滤：
  - decide 帧是 <span style="color: green;">转发</span>or <span style="color: Gold;">丢弃</span>
- <span style="color: green;">转发</span>：
  - 帧应被移至哪个<span style="color: GreenYellow;">接口</span>
- 借助<span style="color: green;">交换</span><span style="color: LightSkyBlue;">表</span>完成
  - 交换表项包含：
    - MAC**地址**
    - 连通该MAC地址的 <span style="color: GreenYellow;">接口</span>

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/53ad90e0fe9307244331a3e9fee9dbea78bb5927bafa54f29fc77ee3e117e528.jpg)  
图3.35以太网交换机中的交换表  

>pro：交换机自学习的过程（2014、2016、2021）  

#### 自学习过程
- A向B发送帧的过程
  - 从接口1进入交换机
    - 查找交换表，找不到MAC地址B
    - 将源地址A和接口1写入交换表
  - 向除接口1外的所有接口广播

- B向A发送帧的过程
  - 通过接口3向A发送
  - 查找交换表，发现(A,1)
    - 从接口1转发给A
  - 将源地址B和接口3写入交换表

#### 交换表维护
- 设有 <span style="color: LightSkyBlue;">有效</span>时间
- 过期表项自动删除
- 保证交换表符合当前网络实际状况

### 共享式以太网和交换式以太网' <span style="color: orange;">对比  

>pro：集线器与交换机连接的网段的区别（2016）  

#### 通信方式对比
1. 普通帧发送
   - 共享式以太网
     - 集线器将帧转发到所有接口
     - 网卡根据目的MAC地址决定接收或丢弃
   - 交换式以太网
     - 根据目的MAC地址和交换表
     - 明确转发给目的主机

2. 广播帧发送
   - 共享式以太网
     - 集线器转发到所有接口
     - 网卡检测广播地址并接收
   - 交换式以太网
     - 交换机从所有接口转发
     - 各主机接收广播帧

3. 多对主机通信
   - 共享式以太网
     - 必然产生冲突
   - 交换式以太网
     - 实现多对接口高速并行交换
     - 不会产生冲突

>pro：集线器和交换机对冲突域/广播域的隔离（2020、2022）  

#### 域隔离特性
- 集线器
  - 不隔离广播域
  - 不隔离冲突域
- 交换机
  - 不隔离广播域
  - 隔离冲突域


# 本章小结及疑难点  

1.说明用 $n$ 比特进行编号时，若接收窗口的大小为1，则仅在发送窗口的大小 $W_{\mathrm{T}}\leqslant2^{n}\!-\!1$ 时，连续ARQ协议才能正确运行。  

假设用3比特进行编号，可表示8个不同的序号，发送窗口的最大值似乎可以为8。但是，实际上，发送窗口的大小设为8将使协议在某些情况下无法工作。下面来证明这一点。  

设发送窗口为8，发送方发送完 $_{0\sim7}$ 号共8个数据帧后，暂停发送。假定这8个数据顿均已正确到达接收方，且接收方对每个数据帧都发回了确认顿。下面考虑两种不同的情况。  

第一种情况：所有确认顿都正确地到达发送方，因此发送方接着又发送8个新的数据顿，其编号应是 $_{0\sim7}$ 。注意，序号是循环使用的。因此序号虽然相同，但8个顿都是新的顿。  

第二种情况：所有确认帧都丢失。经过一段超时计时器控制的时间后，发送方重传这8个旧数据帧，其编号仍为 $_{0\sim7}$  
于是，当接收方第二次收到编号为 $_{0\sim7}$ 的8个数据帧时，就无法判定这是8个新数据顿还是8个重传的旧数据顿。因此，将发送窗口设为8显然是不行的。  

2.为什么PPP协议不使用帧的编号和确认机制来实现可靠传输？PPP不使用序号和确认机制是出于以下考虑：  

若使用能够实现可靠传输的数据链路层协议（如HDLC），开销就会增大。当数据链路层出现差错的概率不大时，使用比较简单的PPP较为合理。  

在因特网环境下，PPP的信息字段放入的数据是IP数据报。假定我们采用了能实现可靠传输但十分复杂的数据链路层协议，当数据帧在路由器中从数据链路层上升到网络层时，仍有可能因网络拥塞而被去弃。因此，数据链路层的可靠传输并不能保证网络层的传输也是可靠的。  

PPP在帧格式中有顿检验序列FCS字段。对于每个收到的帧，PPP都要使用硬件进行CRC检验。若发现差错，则丢弃该帧（一定不能把有差错的顿交给上一层）。端到端的差错控制最后由高层协议负责。因此，PPP可以保证无差错接收。  

3.在标准以太网中，为什么说若有冲突，则冲突一定发生在冲突窗口内？或者说一个帧若在冲突窗口内没有发生冲突，则该帧不会再发生冲突？  

结点在发送数据之前，先监听信道是否有载波，若有，表示信道忙，则继续监听，直至检测到信道空闲为止。一个数据帧在从结点A向最远结点的传输过程中，若有其他结点也在发送数据，则会发生冲突，冲突后的信号经过冲突窗口时间后传回结点A，结点A会检测到冲突，所以说若有冲突，则一定发生在冲突窗口内，若在冲突窗口内没有发生冲突，之后若其他结点再要发送数据，则会监听到信道忙，而不会发送数据，从而不会再发生冲突。  

4.一个以太网的速率从10Mb/s升级到100Mb/s，满足CSMA/CD冲突条件。为使其正常工作，需做哪些调整？为什么？  

100BaseT以太网与 $10\,\mathrm{{Mb}/\mathrm{{s}}}$ 以太网的帧格式相同，唯一不同的参数是帧间最小间隔时间，10Mb/s以太网的顿间最小间隔时间是 $9.6\upmu\mathrm{s}$ ，100BaseT以太网的帧间最小间隔时间是 $0.96\upmu\mathrm{s}$ 。此外，为了保持最短帧长不变，将一个网段的最大长度减小到 $100\mathrm{m}$ 。所有这些调整的原因是速率提高到了原速度的10倍。  

5.关于物理层、数据链路层、网络层设备对于隔离冲突域和广播域的总结。
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/fc3ddde383674d06764c118a9de7de3dffbcff35e7317effddf57d889c61eb8c.jpg)