---
html:
  	toc: true
print_background: true
---

# 网络层

## above

### 【考纲内容】

（一）网络层的功能

异构网络互连：路由与转发：SDN基本概念：拥塞控制

（二）路由算法静态路由与动态路由；距离-向量路由算法；链路状态路由算法；层次路由

（三）IPv4

IPv4分组；IPv4地址与NAT；子网划分与子网掩码、CIDR、路由聚合、ARP、DHCP 与ICMP

（四）IPv6

IPv6的主要特点：IPv6地址

（五）路由协议

自治系统：域内路由与域间路由：RIP路由协议：OSPF路由协议：BGP路由协议

（六）IP多播

多播的概念：IP多播地址

（七）移动IP 移动IP的概念；移动IP通信过程

（八）网络层设备路由器的组成和功能；路由表与路由转发

### 【复习提示】

- 重点关注
  - 结合第3章、第5章、第6章出综合题的概率很大
    - 数据链路层、传输层、网络层

- **IPv4**和**路由**的相关知识点是核心
  - 历年真题都有涉及
  - 必须牢固掌握其原理
  - 还要多做题，以便灵活应用

- 其他知识点
  - 如IP多播、移动IP、IPv6也要有所了解


## Network-layer'功能

### INTRO
* 提供**主机**→**主机**的通信服务
* 主要任务
  * 将分组 从源主机 经过多个网络和多段链路传输 → 目的主机
* 该任务可划分为两种重要功能：
  * 分组转发（packet forwarding）
  * 路由选择（route selection）

#### 网络层服务模型
* OSI参考模型
  * 主张在网络层使用
    * **面向连接**的虚电路服务
  * 认为应由 _网络自身_ 来保证通信的可靠性
* TCP/IP体系
  * 网络层提供的是无连接的数据报服务
  * 由_用户主机_负责可靠性

~~虚电路和数据报服务见2.1~~

#### TCP/IP网络层特点
* 只提供 
  * 简单灵活的、无连接的、尽最大努力交付的数据报服务
* 分组传送特性：
  * 可能出错、丢失、重复、失序或超时
  * 使得路由器可以做得比较简单且价格低廉
* 通信可靠性：
  * 由上层传输层负责
* 优点：
  * 网络造价大大降低
  * 运行方式灵活
  * 能够适应多种应用

### 异构网络互连（Heterogeneous network interconnection）

#### INTRO
* The Internet由
  * 全球数百万异构网络互连而成
* 这些网络的差异：
  * 拓扑结构
  * 寻址方案
  * 差错处理方法
  * 路由选择机制
* 网络层任务之一：
  * 实现异构网络互连

#### 网络互连基本概念
* 定义：
  * 两个以上计算机网络，通过某种方法，用**中继系统**互连形成更大的网络系统
* 中继系统(Relay system)分类：
  * Not
    * 物理层：转发器transponder，集线器hub
    * 数据链路层：网桥bridge或交换机switch //
  * 网络层：路由器Router
  * 网络层以上：网关gateway

#### 网络互连特征
* 物理层或数据链路层中继系统：
  * 仅扩展网络
  * 从网络层看仍是同一个网络
  * 一般不称为网络互连
* **真正的**网络互连：
  * 使用**路由器**进行网络连接和路由选择
    * 路由器是专用计算机，用于互联网路由选择
  * 路由器 也称为网关（gateway）

#### TCP/IP网络互连实现
* 网络层采用
  * 标准化协议
* 允许相互连接的网络
  * 保持异构
* 所有互连网络
  * 使用相同IP协议
* 形成虚拟IP网络：

<figure><img src="https://cdn-mineru.openxlab.org.cn/model-mineru/prod/621a3f2136975b86286096e310e22fa48507532f731983586cccced6c926f71f.jpg" alt=""><figcaption><p>IP网络的概念</p></figcaption></figure>

##### 虚拟互连网络特点
* 本质：
  * 互连的各种物理网络
    * 异构性客观存在
  * 通过IP协议使性能各异的网络
    * 在网络层表现为&emsp;&emsp;统一网络

> use IP协议的虚拟互连网络can be abbreviated as IP网络
>
> namely 虚拟互连网络(逻辑\~)= IP网络

* 优势：
  * IP网上主机通信
    * 如同&emsp;&emsp;在单个网络上通信
  * 无需关注&emsp;&emsp;互连各网络的&emsp;&emsp;具体异构细节
    * ~~（编址方案Addressing scheme、路由选择协议Routing protocol etc）~~
### 路由&转发Routing and Forwarding

#### 路由器的功能
* 路由选择
  * （确定 路径）
* 分组转发
  * （当一个分组到达时&emsp;所采取的动作）

##### 路由选择 route selection
* 根据路由协议
  *  构造并维护&emsp;&emsp;路由表
* 与 相邻路由&emsp;&emsp;**交换信息**
  * get网络&emsp;&emsp;最新拓扑
  * 动态更新维护&emsp;&emsp;路由表
  * 决定分组&emsp;&emsp;到达目的地结点的&emsp;&emsp;最优路径(optimal path)

##### 分组转发 packet forwarding
* 路由器根据&emsp;&emsp;转发表&emsp;&emsp;转发分组 → 合适的端口
  * 路由选择：
    * 根据&emsp;&emsp;路由协议 构造并维护路由表
  * **分组转发**：
    * 处理&emsp;&emsp;经过路由器的数据流
    * key operation: 
      * 转发表查询&emsp;&emsp;转发及相关的队列管理&emsp;&emsp;任务调度etc

> routing _algorithm_→ routing _table_→ _forwarding_ table

##### 转发表
* structure: 
  * 确保&emsp;&emsp;查找过程最优化
* 最优化网络拓扑变化&emsp;&emsp;的计算

When discussing the principles of routing，往往不区分转发表和路由表，both use **路由表** routing _table_

### 两种服务provided by网络层

- 分组交换网 根据其 通信子网向端点系统提供的服务，分为:
  * **面**向连接的**虚**电路服务Connection-oriented virtual circuit service 
  * **无**连接的**数据**报服务 connectionless datagram service

####  <span style="color: Gold;">虚</span><span style="color: deepskyblue;">电路</span> virtual circuit

> **pro：虚电路网络的特性（2020）**

##### 基本概念
* establish 网络层的连接(一条逻辑上的虚电路（VirtualCircuit，VC)）← between 2 hosts
  * **ONCE** established，**FIX**虚电路corresponding物理路径

##### 虚电路建立过程
* building VC: An **UNUSED 虚电路号** (VCID) is assigned to the virtual circuit ← to **区别** it from **other VCs** in the system
* TRANSMIT PACKETS: 双方 ~ along the established VC
* NOTICED: **HEADER** of 分组 only连接建立时use完整'目的地址
* HEADER carrys **VCID**: later The header of each packet only needs to 携带 the **编号** of this VC

##### 虚电路表
* Every **NODE** in the VC network 维持a piece of虚电路表
* Every item in the table, 记录一个open虚电路'information
  * 虚电路号on the receiving and transmitting links
  * 前一结点&下一结点的标识 ← Determined during VC establishment

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/9233181e79b8ebc96077008ff22adf1f54d99334985fab79c6c81d56c6d3f9fd.jpg)

##### 通信过程
>like电路交换，communication process have三个阶段：虚电路建立、数据传输与&虚电路释放:

###### 数据传输前
* 主机A与主机B 建立连接
  * 主机A send"呼叫请求"分组，该分组through中间结点to主机B
  * if 主机B同意连接 → 发送"呼叫应答"分组予以确认

###### 虚电路建立
* 主机A和主机B 传送数据分组each other

###### 传送结束
* 主机A through 发送"释放请求"分组来拆除虚电路
* 逐段断开整个连接

##### 虚电路服务特点
* VC **通信链路**' 建立和拆除need**时间开销**
  * for交互式应用and少量的短分组情况 → 显得很浪费
  * for长时间、频繁的数据交换 → 效率较高
* VC' **路由选择** 体现在 the 阶段 of连接建立
  * 连接建立后 → confirmed 传输路径
* VC provide**_可靠_**'**通信功能**
  * can guarantee每个分组正确且有序到达
  * control 两个端点'流量
    * when接收方 **来不及** 接收数据时
    * can inform 发送方 暂缓发送
* VC have 致命的**弱点**
  * 当网络中的某个结点或某条链路出现故障而彻底失效时，所有经过该结点或该链路的虚电路将遭到破坏
* 分组首部不包含目的地址，包含的是VCID，相对于数据报方式，其开销小

##### 虚电路的"虚"
* circuit 非专用
* every结点to其他结点' 链路
  * maight同时
    * have many虚电路通过
    * or在多个结点之间 建立VC

>⚠️attention: 
As shown in the picture above, 数据传输过程 is 有确认的传输（由高层实现），B收到分组后要发回相应分组的确认。
- 传输in network 是否有确认 与 网络层提供的两种服务 没有任何关系
#### <span style="color: blue;">数据</span>报datagram

The network does NOT NEED to establish a CONNECTION before sending packets
datagram as "DG" personally

##### 数据处理流程
* Source host的高层协议：
  * 报文**message**--divided into --> many较小的**DG** + 地址etc**控制信息** = 分组**Packet**
* 处理过程：
  * 中间结点 存储分组 for a short time
  * find最佳的路由后
    * 尽快Forward each packet

##### 服务特性
* 网络层not provide服务质量' 承诺
  * 网络not provide端到端的可靠传输服务
  * that makes网络中的**Router** 简单and造价低廉（与电话网络相比）

##### 数据报服务'原理
>assumption: 主机A --packet--> 主机B

![数据报方式转发分组]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/12567fcdff5ade6c268261075cfc133a5380945b6f92cd8795694b59b3b807a6.jpg)

* 传输过程：
  * 1）**HOST A** --Packets--> SWITCH **NODE A**
    * NODE A **Cache** received packets 
  * 2）NODE A 查找own转发表
    * different time 网络状态 不同 → 转发表的内容might不完全相同
    * thus：P1 --> SWITCH NODEC，P2 --> SWITCH NODE D
  * 3）other NODEs recieve分组后，samely转发分组--till-- Packets-->HOST B

* 资源共享特性：
  * when分组正在某一链路上传送时，分组don't occupy网络其他部分的资源 ← 采用存储转发技术资源是共享的
    * HOST A在发送分组时
    * meanwhile
    * HOST B can发送分组to other hosts 

##### 特点详解
* 1）send分组前don't need建立连接:
  * 发送方 can 发送分组any time
  * 结点 can 接收分组 any time

* 2）Internet尽最大努力交付，传输不保证可靠性 ← 分组可能出错或丢失
  * 网络为每个分组独立地选择路由 → 转发的路径可能不同
  * 分组 Not always按序到达自的结点

* 3）sended分组should **involve** 发送方&接收方的**完整address**
  * for 独立传输

* 4）**时延**：
  * when分组在交换结点存储转发时，need 排队等候处理 → 一定的 时延
  * when 网络发生拥塞 → 时延↑↑↑ →SWITCH NODE ~may~ 丢弃部分分组 depend on the situation

* 5）网络have**冗余**路径(Redundant path)
  * when 某个交换结点 or 一条链路出现故障时
  * can correspondingly更新转发表，寻找另一条路径转发分组
  * Strong 适应力 to faults

* 6）收发双方不独占某条链路，资源利用率较高。

##### 优势
* 网络的造价大大降低、运行方式灵活、能够适应多种应用
* 互联网能够发展到今大的规模，充分证明了当初采用这种设计思想的正确性。

####  VC&DG --comparison
![数据报服务和虚电路服务的比较 ]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f324c7ccd6e10a702d7ac84398e33b642c254c1efe5182a43c73d0e91c714684.jpg)
|  \       | VC      | DG  |
|  :----:  | :----:  | :----:  |
|building of 连接   | √ | \ |
|目的ADDRESS   | - only Building of 连接 use <br>- other: **VCID** | WHOLE |
|.        |  |  |
|路由选择   |  belonging to the **same VC**' 分组 <br> 转发according to same **ROUTE**  | 每个分组独立<br>routing and forwarding |
|分组~(arrive)~顺序 <br>~(whether有序)~  | <br>√ | <br>× | 
|<br>可靠性   | <br>by the  **NETWORK**  | NOT guaranteed;<br> by the **USER HOST**|
|.        |  |  |
|<br>Adaptability to网络故障|<br> All 经过**FAULT NODE**' VCs → **×**work | - **FAULT NODE** 丢失分组<br>- **OTHER**分组 path selection changes→WORK  |
|.        |  |  |
|<br>差错处理&流量控制| by the **PACKET SWITCHING NETWORK** <br>or<br> by the **USER HOST** | 流量控制<br>by the **USER HOST** |

### SDN （SoftwareDefinedNetwork）：

> 网络层'main tasks：转发和路由选择

### 数据平面 & 控制平面

#### 基本概念
* 网络层可抽象分为两个平面：
  * 数据平面（转发层面）
  * 控制平面
* 功能划分：
  * 转发：由数据平面实现
  * 路由选择：由控制平面实现

#### 软件定义网络（SDN）
##### 核心特征
> Adopt 集中式的控制平面&分布式的数据平面
>
> 。Centralized control plane + Distributed data plane

* 两个平面
  * 相互分离
* 控制平面
  * 通过 控制数据接口&emsp;&emsp;对数据平面的路由器
  * 进行集中式控制
* 更便于&emsp;&emsp;软件控制网络

##### 网络架构对比
* 传统网络架构：
  * 路由器同时包含
    * 转发表和路由选择软件
  * 同时具备&emsp;&emsp;数据平面和控制平面&emsp;&emsp;功能

* SDN架构：
  * 路由器功能简化
  * 不再需要路由器之间交换路由信息
  * 控制平面特点：
    * 包含一个逻辑远程控制器（可能由多个服务器组成）
    * 控制器功能：
      * 掌握各主机和整个网络状态
      * 为每个分组计算最佳路由
      * 通过OpenFlow协议下发流表（转发表）给路由器
    * 路由器职责仅限于：
      * 收到分组
      * 查找转发表
      * 转发分组

<figure><img src="https://cdn-mineru.openxlab.org.cn/model-mineru/prod/8980411f3a345b80986b7d3b5cb90dfa7fc85d40d5af689d3f0e6480ae45beba.jpg" alt=""><figcaption><p>远程控制器  确定并分发 转发表中的值</p></figcaption></figure>

##### 应用场景
* 网络控制模式的转变：
  * 从原始的分布式转向集中控制
  * 但不会完全改造整个互联网
* 适用条件：
  * 特定环境下的应用
  * 尤其适合大型数据中心间的广域网
  * 可显著提高网络运行效率

#### 北向接口&南向\~|东西向~
> **pro：SDN的南向接口的定义（2022）**

##### SDN的可编程性
* 通过为开发者提供强大的**编程接口**，使得网络具有很好的编程性

##### 三种接口类型
* 北向接口
  * 面向对象：**_上层应用_**的开发者
  * 特点：
    * 提供一系列丰富的API
    * 开发者可以在此基础上设计自己的应用
    * <u>不必关心底层</u>的硬件细节

* 南向接口
  * 面向对象：SDN控制器and转发设备
  * 功能：建立**_双向会话_**
  * 实现方式：
    * through不同的南向接口协议（如Openflow）
    * SDN控制器就可兼容不同的硬件设备
    * 同时可在设备中实现上层应用的逻辑

* 东西向接口
  * 面向对象：SDN控制器集群**_内部控制器_**之间
  * 功能：通信接口
  * 目的：增强整个控制平面的可靠性和可拓展性

##### 优点
* 全局集中式控制和分布式高速转发
  * 利于控制平面的全局优化
  * 利于高性能的网络转发
* 灵活可编程与性能的平衡
  * 控制和转发功能分离后
  * 使得网络可以由专有的自动化工具以编程方式配置
* 降低成本
  * 控制和数据平面分离后
  * 尤其是在使用开放的接口协议后
  * 实现了网络设备的制造与功能软件的并发相分离
  * 从而有效降低了成本

##### 问题
* 安全风险
  * **集中管理**容易受攻击
  * 若崩溃，则整个网络会受到影响
* **瓶颈**问题
  * 原本分布式的控制平面**集中化后**
  * 随着网络规模扩大，控制器可能成为网络性能的瓶颈
### 拥塞控制 Congestion Control

#### 拥塞

* 定义：
  * 因出现过量的分组导致网络性能下降的现象

* 判断网络是否进入拥塞状态的方法：
  * 观察网络的**吞吐量**与网络**负载**的关系：
    * 如果随着网络**负载**的增加，网络的吞吐量明显小于**正常**的吞吐量 → 网络可能已处于轻度拥塞状态
    * 如果吞吐量而下降 → 网络处于拥塞状态

#### 拥塞控制

##### 基本概念
* 含义：
  * 主要解决的问题：
    * 如何获取网络中发生**拥塞**的**信息**
    * 如何利用这些信息进行控制，避免因拥塞而出现分组的丢失
  
  * 作用：
    * 确保网络能承载已达到的流量
    * 是一个**全局性**的过程，涉及网络中所有主机、路由器及导致网络传输能力下降的所有因素
    * 单一地增加资源并不能解决拥塞

  * 与流量控制的区别：
    * 流量控制：在发送方和接收方之间的**点对点**通信量的控制
    * 目的：抑制发送方发送数据的速率，使接收方能及时接收

##### 控制方法
* 开环控制：
  * 特点：
    * 在设计网络时事**先**将相关发生拥塞的因素**考虑**周到
    * 力求网络在工作时不产生拥塞
    * 是一种静态的预防方法
  * 运行机制：
    * 系统启动并运行后，中途不再需要修改
  * 控制手段：
    * 确定何时可接收新流量
    * 确定何时可丢弃分组及丢弃哪些分组
    * 确定调度策略等
  * 共性：
    * 在做决定时不考虑当前网络的状态

* 闭环控制：
  * 特点：
    * **事先不考虑**有关发生拥塞的各种因素
    * 采用监测网络系统去监视
    * 及时检测哪里发生了拥塞
    * 基于反馈环路的概念，是一种动态方法
  * 运行机制：
    * 将拥塞信息传到合适的地方
    * 调整网络系统的运行
    * 解决出现的问题- - -

## IPv<b><span style="color:blue;">4</b>

### IPv4分组

>IPv4（版本4）即现在普遍使用的 网际协议（InternetProtocol，IP）


IP定义**数据传送**的 **_基本单元_** 一一IP分组 & 其确切的数据格式

IP also includes一套规则，指明分组如何处理、错误怎样控制。Especially, IP还包含 非可靠投递的思想，and与此关联的路由选择的思想

#### 格式

> **pro：IP首部的分析/各字段的含义（2011、2012）**

一个**IP分组**（或称**IP数据报**）由 **_首部_** 和 **_数据_** 部分组成。
首部
- 前一部分的**长度固定**，共20B
  - 是所有IP分组必须具有的。
- 在首部固定部分的后面是一些可选字段，
  - 其**长度可变**，用来提供错误检测及安全等机制。

<span style="font-size: 14px;">IP数据报的格式如图:

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/83f7bc75378b06ceb46c21f71b64717714580f6ea9f486f61f4aca59abefe7d7.jpg)
图4.5IP数据报的格式

IPv4首部的部分重要字段含义如下：
>标号除"31"表示截至位，其余均应视为start位

1）版本。~4bit~
指IP的版本，IPv4数据报中该字段值是4。

2）首部长度。~4bit~
以4B为单位，最大可表示的首部长度为60B（ $15\times4\mathrm{B}$ ）。最常用的首部长度是20B（ $5{\times}4\mathrm{B}$ ），该字段值是5，此时不使用任何可选字段。

> **attention:** IP首部前两个字节往往以**0x45**开头，解题时可用于定位IP数据报的**开始位置**

3）总长度。~16bit~
指首部和数据之和的长度，单位为字节，thus数据报的最大长度为 $2^{16}-1=65535\mathrm{B}$ 
以太网帧的最大传送单元（MTU）为1500B，thus当一个IP数据报封装成
硕时，数据报的总长度（首部加数据）一定不能超过下面的数据链路层的MTU值

4）标识。~16bit~
是一个计数器，每产生一个数据报就加1，并赋值给标识字段。但它并不是“序号”（因为IP是无连接服务）。当一个数据报的长度超过网络的MTU时，必须分片，此时每个数据报片都复制一次标识号，以便能正确地重装成原来的数据报。

5）标志（Flag）。~3bit~
标志字段的最低位为MF:
 - <span style="font-size: 14px;">$MF=1$ : still have分片
 - <span style="font-size: 14px;">$MF=0$ : LAST 分片
 
 标志字段中间的一位是DF，只有当 $DF=0$ 时才允许分片。

6）片偏移Fragment Offset。~13bit~
><span style="font-size: 14px;"> Point out: 较长的DG在Fragment后，某片在原数据报中的相对位置
- 片偏移以8B为偏移单位
- 除最后一个分片外，每个分片的长度一定是8B的整数倍。


7）生存时间Time to live (TTL)。~8bit~
>DG在网络中可通过的路由器数的最大值

标识DG在网络中的寿命，以确保DG不会永远在网络中循环。
路由器在转发数据报前，先将TTL减1。若TTL被减为0，则该数据报必须去弃。
> **pro：TTL的计算（2014）**

8）协议。~8bit~
指出此数据报携带的数据使用何种协议，即数据报的数据部分应上交给哪个协议进行处理，如TCP、UDP等。其中值为6表示TCP，值为17表示UDP。

9）首部检验和。~16bit~
它只检验数据报的首部，但不包括数据部分。这是因为数据报每经过一个路由器，都要重新计算首部检验和（有些字段，如生存时间、总长度、标志、片偏移、源/目的地址都可能发生变化）。不检验数据部分可减少计算的工作量。

10）源地址字段。~4Byte~
标识发送方的IP地址。

11）目的地址字段。~4Byte~
标识接收方的IP地址。

> ◀️**attention:**

① REMEMBER: 首部长度H、总长度T、片偏移F， basic units are **4**B、**1**B、**8**B
- ~这几个长度之间的加减运算~
  
In addition，熟悉IP数据报首部中的各个字段的意义和功能
<span style="font-size: 12px;"> don't need记忆IP数据报的首部, generally若需要参考首部，则题目会直接给出 
第5章学习的TCP、UDP的首部也是一样的</span> 
② IP地址usaully用十六进制表示的，要注意其与十进制之间的转换。

#### IP数据报分片

##### 最大传送单元（MTU)Maximum transfer unit
一个链路层 数据帧能承载的max数据量

因为IP数据报被封装在链路层的顿中，thus链路层的MTU严格地限制了IP数据报的长度，而且在IP数据报的源与目的地路径上的各段链路可能使用不同的链路层协议，有不同的MTU。
例如，以太网的MTU为1500B，而许多广域网的MTU不超过576B。

##### length of DG >MTU → DG分片
数据报分片
当IP数据报的总长度大于链路MTU时 → 将IP数据报中的数据分装 在多个较小的IP数据报中

those较小的数据报 → 片Fragment

> **pro：分片时会影响首部中的哪些字段（2011）**

片在目的地的网络层被重新组装。
**目的主机**使用IP HEADER中的 标识、标志和片偏移字段 来完成对片的**重组**。
创建一个IP数据报时，源主机为该数据报加上一个标识号。

当一个路由器需要将一个数据报分片时，形成的每个数据报（即片）都具有原始数据报的标识号。
当目的主机收到来自同一发送主机的一批数据报时，它可通过检查数据报的标识号来确定哪些数据报属于同一个原始数据报的片。
HEADER中的标志位占3位，only后2位有意义，分别是DF（Don'tFragment)位和MF（More Fragment）位。
- only当 $\bf{DF=0}$ 时，该IP数据报才**可**被**分片**
- MF则用来告知目的主机该IP数据报Whether为原始数据报的Last
  - 当 $MF=1$ 时，表示相应的原始数据报还有后续的片；
  - 当 $MF=0$ 时，表示该数据报是相应原始数据报的最后一个片。

目的主机在对片进行重组时，use**片偏移字段F**to make sure片应放在原始IP数据报的哪个位置。

> **pro：IP分片的原理及相关字段的分析（2021）**

###### Fragmentation 计算
eg，一个长4000B的IP数据报（首部20B，数据部分3980B）到达一个路由器，需要转发到一条**MTU 1500B**的链路上。(assumption原始数据报的标识号为777)
This means：
原始数据报中的3980B数据必须分配到3个独立的片中（每片也是一个IP数据报）：
- 每片的数据部分依次为1480B、1480B和1020B。
- 则分成的3片如图。
- 可见，因为偏移值的单位是8B，thus 除最后一个片外，其他所有片中的数据部分都为8B的倍数。

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/626e7ffc8ed5ca7c1f4c45679e7d234b783838316cdd440725a7b9512cb99c27.jpg)
图4.6IP分片的例子

### IPv4地址与NAT

#### IPv4地址

##### IPv4地址
###### 基本定义
- IP地址是给互联网上的每台主机（或路由器）的每个接口分配的一个在全球范围内唯一的32位标识符
  - 由互联网名字和数字分配机构ICANN进行分配
  - 早期采用的是分类的IP地址，如图4.7所示

###### IP地址的组成结构
![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f2e278ae9a152d96978ffc45243b7b127a36a1cce3578e4c25be1b688bd910d2.jpg)
图4.7分类的IP地址

- IP地址： $=$ {<网络号>，<主机号>}
  - 网络号：标志主机（或路由器）所连接到的网络
    - 在整个互联网范围内必须是唯一的
  - 主机号：标志该主机（或路由器）
    - 在它前面的网络号所指明的网络范围内必须是唯一的

###### 特殊IP地址
> **pro：特殊IP地址0.0.0.0的用途（2017）**

- 特殊用途的IP地址：
  - 主机号全为0：表示本网络本身（如202.98.174.0）
  - 主机号全为1：表示本网络的广播地址/直接广播地址（如202.98.174.255）
  - 127.x.x.x：环回自检地址
  - 0.0.0.0：本网络上的本主机
  - 255.255.255.255：整个TCP/IP网络的广播地址/受限广播地址

###### IP地址分类使用范围
![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/8e5f99e160787c8b792c1180313a4d2d4e023d0e54160b7414f055ff18773b94.jpg)

- A类地址可用网络数：$2^{7}-2$
  - 减2原因：
    - 网络号字段全0为保留地址
    - 网络号127为环回自检地址

###### IP地址特点
- 分等级的地址结构
  - 好处：
    - 地址管理方便：只分配网络号，主机号由单位自行分配
    - 减小路由表存储空间：路由器仅根据网络号转发
- 标志接口特性
  - 一台主机连接两个网络需要两个不同网络号的IP地址
  - 路由器至少需要两个IP地址
- 网络连接特性
  - 用转发器/桥接器连接的LAN共用同一网络号
  - 所有分配网络号的网络平等
  - 同一局域网上的主机/路由器接口网络号必须相同

##### 网络地址转换（NAT）
###### 基本概念
- 将专用地址转换为公用地址
  - 对外隐藏内部IP地址
  - 只需一个全球IP地址即可连通互联网
  - 节省IP地址消耗
  - 提高网络安全性

###### 私有IP地址
> **pro：私有IP地址访问Internet的处理（2011）**

- 私有IP地址范围：
  - A类：10.0.0.0~10.255.255.255
  - B类：172.16.0.0~172.31.255.255
  - C类：192.168.0.0~192.168.255.255
- 特点：
  - 仅用于LAN
  - 不能直接用于Internet
  - 允许LAN重复使用
  - 需通过NAT转换才能访问Internet

###### NAT工作原理
> **pro：NAT的原理和应用（2016、2019、2020、2023）**

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/e02ffb33271e0f0ef1690c1d80df4b45778e6944f11d8a56baafaeed794a29f0.jpg)
图4.8NAT路由器的工作原理

- 工作流程：
  1. 用户发送请求（私有地址→公网服务器）
  2. NAT路由器转换：
     - 生成新端口号
     - 修改源地址为全球IP
     - 更新NAT转换表
  3. 服务器响应到NAT路由器
  4. NAT路由器根据转换表还原私有地址信息

> **attention:**

- NAT路由器vs普通路由器：
  - 普通路由器：
    - 仅工作在网络层
    - 转发时不改变IP地址
  - NAT路由器：
    - 需要转换IP地址
    - 需要查看和转换传输层端口号
### 划分子网subnetting & 路由聚合Route aggregation

#### 划分子网subnetting
- 两级IP地址的缺点：
  - IP地址空间的利用率有时很低
  - 给每个物理网络分配一个网络号会使路由表变得太大，进而使网络性能变坏
  - 两级IP地址不够灵活

- 从1985年起，在IP地址中又增加了一个"子网号字段"，使两级IP地址变成了三级IP地址
  - 这种做法称为划分子网
  - 划分子网已成为互联网的正式标准协议

##### subnetting的基本思路
- subnetting is 一个单位内部的事情
  - **对外**still**表现为** **没有划分**子网的一个网络
  - 方法:
    - **从**网络的**主机号** **借用**若干位作为子网号~（主机号也相应减少了相同的位数）~
- 三级IP地址的结构：
  - IP地址： $=$ {<网络号>，<子网号>，<主机号>}
- 路由器转发分组根据： IPDG的**目的网络号**
  - 本单位的路由器收到TP数据报后，再按目的网络号和子网号找到目的子网
  - 最后把IP数据报交付给目的主机

#####  eg 
- 将一个C类网络208.115.21.0划分为4个子网
  - 子网号占用2位，thus主机号就只有6位
  - 各子网的网络地址分别为208.115.21.0、208.115.21.64、208.115.21.128、208.115.21.192
  - 每个子网可分配的IP地址数为 $2^{6}{-}2{=}62$

> **attention:**

- subnetting只是把IP地址的**主机号部分**进行**再划分**
  - **不改变**IP地址**原**来**的网络号**
  - **从**一个**IP地址本身** **无法判断**该主机所连接的网络**whether**进行了subnetting
- subnet中的**主机号** **全0**或**全1**的地址不能被指派
  - 全0: 网络地址
  - 全1: 广播地址
- 划分子网**增加**了**灵活性**
  - but**减少了**能够连接在**network上**的**主机总数**

#### 子网掩码Subnet mask &默认网关Default Gateway

##### 子网掩码
- 子网掩码可用来 **==指明==** 分类IP地址的主机号部分 **==被借用==了** **多少位**作为子网号
*short as **SM** personally
> **pro：根据IP地址和子网掩码求网络地址（2022）**

- 组成：
  - 一个与IP地址相对应的、长32位的**二进制串**
    - 由一串1和跟随的一串0组成
    - 1对应于IP地址中的网络号及子网号
    - 0对应于主机号
- 主机或路由器只需将IP地址和其对应的子网掩码逐位"与"（AND运算），就可得出相应子网的网络地址



##### 默认网关Default Gateway
> **pro：默认网关配置错误对访问局域网和跨网访问的影响（2015）**

> **pro：默认网关和子网掩码的配置分析（2016、2019、2022）**
- 默认网关是**子网**与**外部网络**==连接==的设备
  - 也就是连接本机或子网的 **路由器接口**的'**IP地址**
- 主机发送数据时的process：
  - On the basis of所发送数据的目的IP地址，through子网掩码来判定目的**主机whether在子网中**
    - 若目的主机在子网中，则直接发送
    - 若目的主机不在子网中，则将该数据 → 默认网关，由网关（路由器）将其转发到其他网络

##### 子网掩码使用规定
- 现在的互联网标准规定：所有网络都must使用子网掩码
  - 若一个网络**未划分子网**，则该网络的**SM**use **Default**SM
  - A、B、C类地址的DSM
    - 255.0.0.0、255.255.0.0、255.255.255.0
- eg：
  - 某主机的1P地址为192.168.5.56，子网掩码为255.255.255.0
    - 进行逐位"与"运算后，得出该主机所在子网的网络号为192.168.5.0

##### SM的重要性
- is一个网络的重要属性
  - 路由器相互之间**交换路由信息**时，必须将自己**所在网络**的**子网掩码**告诉对方
  - 分组转发时：
    - 路由器将分组的目标地址和某网络的子网掩码**按位相与**
      - 若**结果**与该网络地址**一致**，则路由匹配成功
      - 路由器将**分组转发**至该网络

##### SM使用要求
- 一台主机在设置IP地址信息的同时，must设置**SM**
- 同属于一个子网的所有主机及路由器的相应端口，必须设置**相同**的SM
- 路由器的**路由表**中所包含的信息**主要内容**
  - 目的网络地址、**SM**、下一跳地址

#### 无分类编址CIDR <span style="font-size: 14px;"> (无分类 域间 路由选择Classless Inter-Domain Routing</span> ——New


##### CIDR基本概念
- 提出的一种**消除**传统**A、B、C类地址**及**划分子网**的概念
- 特点：
  - **更有效**地分配IPv4的地址空间
  - 使用网络**前缀****N**etwork **P**refix的概念代替网络的概念
    - 位数不是固定的，可以任意选取
- CIDR的==记法==：IP地址 = {<网络前缀>，<主机号>}



##### ?CIDR斜线记法
- 记为："IP地址/网络前缀**所占的位数**"
  - NP 所占的位数corresponds to网络号的部分
  - ⇔ SM中连续1的部分
- eg：(128.14.32.5/20)
  - 掩码是20个连续的1和后续12个连续的0
  - IP=10000000.00001110.00100000.00000101
  - 掩码=11111111.11111111.11110000.00000000
  - 网络前缀=10000000.00001110.00100000.00000000(128.14.32.0)
![image]`(https://bluejedis.github.io/picx-images-hosting/image.8l042v31fg.webp)


##### CIDR地址块address block特性
> **pro：CIDR地址块的分析（2011、2015、2016、2019、2023）**
> **pro：地址块的最小地址和最大地址分析（2023）**
- 将网络前缀都相同的连续IP地址--compose-->一个CIDR地址块
- 地址范围：
  - 最小地址：10000000.00001110.00100000.00000000（128.14.32.0）
  - 最大地址：10000000.00001110.00101111.11111111（128.14.47.255）
![image]`(https://bluejedis.github.io/picx-images-hosting/image.3k81bawtmn.webp)
- 主机号全0或全1的地址一般不使用

##### CIDR与子网的关系
- CIDR although不use子网，still use"掩码"
- CIDR不使用子网的含义：
  - 不在32位地址中**指明**若干位作为子网字段
- **单位内部**仍可划分子网：
  - 分配到地址块/20的单位可划分为8个子网
  - 从主机号中借用3位来划分子网
  - 每个子网的网络前缀变成23位

> **pro：子网广播地址/网络地址的分析（2011、2012、2018、2019）**

##### CIDR地址块特点
- 地址数量：
  - 地址块中的地址数一定是2的整数次幂
  - 实际可指派的地址数通常为2^N-2（N表示主机号的位数）
  - 主机号全0代表网络号，主机号全1为广播地址
- 网络前缀特性：
  - 网络前缀越短，其地址块包含的地址数就越多
  - 在三级结构的IP地址中，划分子网使网络前缀变长
#### 路由聚合Route aggregation
- 一个CIDR地址块中有很多地址 → **路由表中**就可利用CIDR地址块来查找目的网络
- 这种**地址**的**聚合**称为路由聚合，也称**构成超网**
  - 它使得路由表中的一个项自可以表示多个原来传统分类地址的路由
  - 有利于减少路由器之间的信息交换，进而提高网络性能

> **pro：路由聚合的分析（2009、2011、2013、2014、2018）**

##### 示例
- 在如图4.9所示的网络中，若不使用路由聚合
  - 则R1的路由表中need分别have到网络1和网络2的路由表项
- 不难发现
  - 网络1和网络2的网络前缀在二进制表示的情况下
    - 前16位都是相同的
    - 第17位分别是0和1
  - 从R1到网络1和网络2的路由的下一跳皆为R2
- 若使用路由聚合
  - 则在R1看来，网络1和网络2可以构成一个更大的地址块206.1.0.0/16
  - 到网络1和网络2的两条路由就可聚合成一条到206.1.0.0/16的路由

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/3c327d3febd0959034937d5135371eb34698ee1d81aeb0c0a097b58a53585744.jpg)图4.9路由聚合的例子

> **pro：路由器分组转发的最长前缀匹配（2013、2015）**

##### 最长前缀匹配Longest prefix matching
- 又称最佳匹配Optimal matching
- 使用CIDR时
  - 路由表中的个项由"网络前缀"和"下一跳地址"组成
  - 在查找路由表时可能会得到不止一个匹配结果
  - 此时，应当从匹配结果中选择具有最长网络前缀的路由
    - 网络前缀越长，其地址块就越小
    - thus路由就越具体

##### CIDR查找路由表的方法
- 为了更有效地查找最长前缀匹配
  - 通常将无分类编址的路由表存放在一种层次式数据结构（通常采用二叉线索）中
  - 然后自上而下地按层次进行查找

##### CIDR的优点
- 网络前缀长度的**灵活性**
  - 因为上层网络的前缀长度较短，thus 相应的路由表的项目较少
  - 而内部又可采用延长网络前缀的方法来灵活地划分子网
#### 子网划分subnetting的application

##### 子网划分方法Types of subnet division methods

  - 采用定长的SM
  - 采用变长的SM

###### 定长SM划分 Fixed-length subnet mask division
- 当采用定长的子网掩码划分子网时：
  - 所划分的每个子网使用相同的子网掩码
  - 每个子网所分配的IP地址数量也相同
  - thus容易造成地址资源的浪费

> **pro：采用定长SM划分子网的应用（2009、2010、2017、2018）**

###### 定长SM划分示例Example of fixed-length subnet mask division
- 假设某单位拥有一个CIDR地址块为208.115.21.0/24：
  - 该单位有三个部门，各部门的主机台数分别为50、20、5
  - 采用定长的子网掩码给各部门分配IP地址
- 需求分析：
  - 部门1需要51个IP地址（含一个路由器接口地址）
  - 部门2需要21个IP地址
  - 部门3需要6个IP地址
- 划分方案：
  - 从给定地址块208.115.21.0/24的主机号部分借用2位作为子网号
  - 可以划分为 $2^{2}{=}4$ 个子网
  - 每个子网可分配的IP地址数为 $2^{8-2}{-}2!=!62$
- 具体划分：
  - 208.115.21.00000000～208.115.21.00111111，地址块"208.115.21.0/26"，分配给部门1
  - 208.115.21.01000000\~208.115.21.01111111，地址块"208.115.21.64/26"，分配给部门2
  - 208.115.21.10000000\~208.115.21.10111111，地址块"208.115.21.128/26"，分配给部门3
  - 208.115.21.11000000\~208.115.21.11111111，地址块"208.115.21.192/26"，留作以后用
  - 子网掩码：255.255.255.1100000，即255.255.255.192

###### 变长SM划分Variable-length subnet mask division

> **pro：采用变长SM划分子网的应用（2019、2021）**

- 特点：
  - 所划分的每个子网可以使用不同的子网掩码
  - 每个子网所分配的IP地址数量可以不同
  - 这样就尽可能地减少了对地址资源的浪费

###### 变长SM划分示例Example of variable-length subnet mask division
- 需求分析：
  - 部门1的主机号需6位，剩余26（ $(32-6=26$ ）位作为网络前缀
  - 部门2的主机号需5位，剩余27（ $(32-5=27)$ ）位作为网络前缀
  - 部门3的主机号需3位，剩余29 $(32-3=29$ ）位作为网络前缀
- 划分方案：
  - 从地址块 $208.115.21.0/24$ 中划分出3个子网
    - 1个"/26"地址块
    - 1个"727"地址块
    - 1个"/29"地址块
  - 按需分配给三个部门
  - 每个子网的最小地址只能选取主机号全0的地址
  - 建议从大的子网开始划分

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/ac44667c05deef529ea237a5beaa962fc08414413a27f237c11d6473ec294d88.jpg)

- 注意事项：
  - 子网主机号全0或全1的地址不能分配
  - 对于一段连接两个路由器的链路：
    - 可以分配一个"730"地址块
    - 这样可分配地址为2个
    - 恰好可分配给链路两端的路由器接口
### 网络层转发分组的过程Packet forwarding process at the network layer

#### 转发表基本信息Basic forwarding table information
- 分组转发all基于目的主机所在网络的
  - because互联网上的**网络数**<<**主机数**
  - 极大地压缩转发表的大小
- 当分组到达路由器后，路由器根据目的IP地址的网络前缀来查找转发表，确定下一跳应当到哪个路由器
- thus，在转发表中，每条路由必须有下面两条信息：
  - （目的网络地址，下一跳地址）
- 这样，IP数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次间接交付），当到达最后一个路由器时，才试图向目的主机进行直接交付

#### CIDR编址下的转发表查找Forwarding table lookup under CIDR addressing
- 采用CIDR编址时，若一个分组在转发表中可以找到多个匹配的前缀，则应当使用最长前缀匹配
- 为了更快地查找转发表，可以按照前缀的长短，将前缀最长的排在第1行，按前缀长度的降序排列
- 这样，从第1行最长的开始查找，只要检索到匹配的，就不必再继续查找

#### 特殊路由Special routes
##### 特定主机路由Specific host routes
> **pro：特定主机路由的应用（2009）**
- 对特定目的主机的IP地址**专门指明**一个路由，以方便网络管理员控制和测试网络
- if特定主机的IP地址是a.b.c.d，则转发表中对应项的目的网络是a.b.c.d/32
  - /32表示的子网掩码没有意义
  - but this特殊的前缀可以用在转发表中

##### 默认路由Default route
> **pro：默认路由的应用（2009、2014）**
- 用特殊前缀0.0.0.0/0表示默认路由
  - 全0掩码和任何目的地址进行按位与运算，结果必然为全0，即必然和前缀0.0.0.0/0相匹配
- 只要**目的网络**is**其他网络**（不在转发表中），就**一律选择默认路由**
- 默认路由通常用于 路由器 → 互联网的路由
  - 互联网包括无数的网络集合，不可能在路由表项中一一列出
  - thus只能采用默认路由的方式

#### 分组转发算法Packet forwarding algorithm
- 1）从收到的IP分组的首部**提取**目的主机的IP地址D（即目的地址）
- 2）**查找**特定主机路由（目的地址为D）
  - Y
    - 按照这条路由的下一跳转发分组；  
  - N
    - 从转发表中的**下一条**（即按前缀长度的顺序）开始**检查**，执行步骤3）
- 3）将这一行的 **子网掩码 **与**目的地址D**逐位"与"（**AND**操作）
  - 若运算结果与本行的前缀匹配
    - 则查找结束
    - 按照"下一跳"指出的进行处理
    - （或者直接交付本网络上的目的主机，或通过指定接口发送到下一跳路由器）
  - 否则，若转发表还有下一行，则对下一行进行检查，重新执行步骤3）
  - 否则，执行步骤4）
    - 4）若转发表中**有一个默认路由**，则把分组传送给默认路由；否则，报告转发分组出错

#### 转发表特点Forwarding table characteristics
>step by step
- 转发表（或路由表）**并没有**给分组**指明**到某个网络的**完整路径**（即先经过哪个路由器，然后经过哪个路由器等）
- 转发表指出，到某个网络应当**先到**某个路由器（即**下一跳路由器** Next hop router）
  - 到达下一跳路由器后，再继续查找其转发表，知道再下一步应当到哪个路由器
- 这样一步一步地查找下去，直到最后到达目的网络

> **attention:** 
- 得到下一跳路由器的IP地址后
  - not直接将该地址填入待发送的数据报
  - but将该IP地址转 → **MAC地址**（通过ARP）
    - 将此MAC地址填入MAC帧首部
    - 然后根据这个MAC地址找到下一跳路由器
- 不同网络中传送时
  - MAC帧的源地址和目的地址要发生变化

### 地址解析**A**ddress **R**esolution 协议 （ARP)

#### IP地址&硬件地址

IP地址:  **网络层**及**网络层之上**使用的地址
- 分层式

硬件地址（MAC地址）: **数据链路层**使用的地址
- 平面式

IP地址放在IP数据报的首部，而MAC地址放在MAC帧的首部。把IP数据报封装为MAC帧后，数据链路层看不见IP数据报中的IP地址。

因为**路由器**的**隔离**，IP网络中无法通过广播MAC地址来完成跨网络的寻址，thus 在**网络层**只使用**IP地址**来完成寻址。
寻址时，每个路由器依据其路由表（依靠路由协议生成）选择到目标网络（即主机号全为0的网络地址）需要转发到的下一跳（路由器的物理端口号或下一网络地址），而IP数据报通过多次路由转发到达自标网络后，改为在自标局域网中通过数据链路层的MAC地址以广播方式寻址。这样可以提高路由选择的效率。

下列几个性质是计算机网络的精髓，有必要特别强调：

1）在**IP层抽象**的互联网上只能看到**IP数据报**。← [only**IP DG**]`
2）虽然在IP数据报首部中有源IP地址，但**路由器**只根据**目的IP**地址进行转发。← [only according to **目的IP**]`
3）在**局域网**的**链路层**，只能看见MAC帧。IP数据报被封装在MAC帧中。← [only **MAC帧**]`
通过路由器转发时，IP数据报在**每个网络**中都被路由器**解封装**和**重新封装**，其MAC帧首部中的源地址和自的地址会不断改变。这也决定了无法使用MAC地址跨网络通信。 ← [only **IP DG** 跨网络通信]`

4）尽管互连在一起的网络的硬件地址体系各不相同，但**IP层抽象**的互联网却**屏蔽**了下层这些**复杂**的**细节**。只要我们在网络层上讨论问题，就能够使用统一的、抽象的IP地址研究主机与主机或路由器之间的通信。

> **attention:**

路由器因为互连多个网络，thus 它不仅有**多个** **IP地址**，而且有多个**硬件地址**。

#### 地址解析 Address Resolution协议

> **pro：ARP的功能和应用（2011、2012、2021）**

无论网络层使用什么协议，在实际网络的**链路**上传送**数据帧**时，eventually必须使用MAC地址。
thus 需要一种方法来完成**IP地址**→**MAC地址**的**映射**，这就是地址解析协议（AddressResolutionProtocol，ARP）。
每台主机都设有一个**ARP高速缓存**，用来存放本局域网上各主机和路由器的IP地址到MAC地址的**映射表**，称ARP表。
使用**ARP**来**动态维护**ARP表。

> **pro：ARP请求帧的目的MAC地址（2011、2015）**
##### ARP工作原理
>工作在网络层


- 主机A--IP DG-->本局域网上的某台主机B时：
  - 在 **ARP高速缓存**中查看有无主机**B**的**IP地址**
    - Y：
      - 查出其对应的**硬件地址**
      - 将此硬件地址写入**MAC帧**
      - 通过局域网将该MAC帧 → 此硬件地址
    - N：
      - 使用目的MAC地址为FF-FF-FF-FF-FF-FF的帧来封装&广播ARP请求分组（广播发送）
      - 使**同**一个**局域网**里的**所有**主机都收到此ARP请求
      - 主机**B**收到该ARP请求后，向主机A发出ARP**响应**分组（单播发送）
        - 分组中包含主机B的IP地址与MAC地址的映射关系  
      - 主机A收到ARP响应分组后：
        - 将此映射写入ARP缓存
        - 按查询到的硬件地址发送MAC帧

<figure>ARP "看到了"IP地址 → work in网络层</br>
NAT路由器"看到了"端口 → work in传输层</figure>

对于某个协议工作在哪个层次，读者应该能通过协议的工作原理进行推测

> **attention:**

ARP用于解决同一局域网上的主机或路由器的IP地址和硬件地址的**映射问题**。
若目的主机和源主机 _不在_ **同一个局域网**Local area network **LAN**上，则要通过ARP找到本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络，**剩下的**工作就由**下一个网络**来做。
尽管ARP请求分组是广播发送的，但ARP响应分组是普通的单播。

##### 使用ARP的4种典型情况


![使用ARP的4种典型情况]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/9a0240a6e9ad5e98a9ca150689311067f19352ad0f9a539c54df2672c931882b.jpg)

###### 1. 发送方是**主机**$\mathrm{H}_{1}$ 

1）要把IP分组发送到**本网络**上的另一台主机（如 $\mathrm{H}_{2}$ )。
-  $\mathrm{H}_{1}$ 在网1用ARP找到目的主机 $\mathrm{H}_{2}$ 的硬件地址。

2）要把IP分组发送到**其他网络**上的一台主机（如 $\mathrm{H}_{4}.$ ）。
-  $\mathrm{H}_{1}$ 用ARP找到与网1连接的**路由器** $\bf{\mathsf{R}_{1}}$ 的硬件地址（默认网关），剩下的工作由 $\mathsf{R}_{1}$ 来完成。

>**pro: 跨局域网的帧的目的MAC地址（2015）**

**attention:**

- 开始在$\mathrm{H}_{1}$ 和$\mathrm{R}_{1}$ 之间传送时：
  - MAC帧首部中的源地址是$\mathrm{H}_{1}$ 的MAC地址
  - 目的地址是$\mathrm{L}_{1}$ 的硬件地址
  - 路由器$\mathrm{R}_{1}$收到此MAC帧后：
    - 在数据链路层，要丢弃原MAC的首部和尾部
    - 这时首部中的：
      - 源地址为$\mathrm{L}_{2}$的MAC地址
      - 目的地址为$\mathrm{L}_{3}$ 的MAC地址
- 路由器 $\mathsf{R}_{2}$ 收到此帧后：
  - 再次更换MAC帧的首部和尾部
  - 首部中的：
    - 源地址变为 L_4 的MAC地址
    - 目的地址变为$\mathrm{H}_{4}.$ 的MAC地址
- MAC帧首部的这种变化，在上面的IP层中是看不见的

###### 2. 发送方是路由器（如 $\mathsf{R}_{1}$ )
   
1）要把IP分组转发到与 $\mathsf{R}_{1}$ 连接的网络（**网2**）上的一台主机（如 $\mathrm{H}_{3}$
这时 $\mathsf{R}_{1}$ 在网2用ARP找到目的主机 $\mathrm{H}_{3}$ 的**硬件地址** 

2）要把IP分组转发到**网3**上的一台主机（如 $\mathrm{H}_{4}$ 
这时 $\mathsf{R}_{1}$ 在网2用ARP找到与网2连接的路由器 $\mathsf{R}_{2}$ 的硬件地址，剩下的工作由 $\bf{\mathsf{R}_{2}}$ 来完成。

从IP地址 → 硬件地址的解析是自动进行的，主机的用户并不知道这种地址解析过程。
只要主机或路由器和本网络上的另一个已知IP地址的主机或路由器进行通信，**ARP**就**自动**地将这个IP地址解析为数据链路层所需要的硬件地址。

### 动态主机配置Dynamic Host Configuration协议 (DHCP)
#### definition
provide:**即插即用**的连网机制
allow一台计算机加入新的网络和自动获取IP地址Without manual involvement。
- 应用层协议，基于UDP
  - through客户/服务器模式工作
    - DHCP客户向DHCP服务器请求服务
    - other层次的Protocol 没有这两种工作方式的。
> **pro：DHCP发现报文的作用（2022）**

#### DHCP的工作原理
* Use 客户/服务器 model
* process：
  * 需要IP地址的**主机**在启动时--广播send 发现报文 → DHCP服务器
    * 该主机成为DHCP客户
    * 本地网络上的All hosts 收到这个广播报文
    * only DHCP服务器can回答此广播报文
  * DHCP服务器处理：
    * 数据库中查找该计算机的配置信息
      * 若找到 → 返回找到的信息
      * 若找不到 → 从服务器的IP地址池中 取一个地址分配给该计算机
    * DHCP服务器的**回答报文**称为：**提供报文**
> **pro：DHCP发现报文的源地址和目的地址（2015、2022）**
#### ~ Server/Client交换过程

DHCP发现 → DHCP提供 → DHCP请求 → DHCP确认
* DHCP客户**C**lient广播"**DHCP发现**"消息
  * try to找到 网络中的DHCP**服务器**，以便从DHCP服务器获得一个IP地址
  * 源地址为0.0.0.0
  * 目的地址为255.255.255.255
* DHCP服务器**S**ever收到"DHCP发现"消息后，广播"**DHCP提供**"消息
  * 包括提供给DHCP客户机的IP地址
  * 源地址: DHCP服务器地址
  * 目的地址: 255.255.255.255
* DHCP客户收到"DHCP提供"消息
  * 若接受该IP地址，则广播"**DHCP请求**"消息向DHCP服务器请求提供IP地址
  * 源地址为0.0.0.0
  * 目的地址为255.255.255.255
* DHCP服务器广播"**DHCP确认**"消息
  * 将IP地址分配给DHCP客户
  * 源地址为DHCP服务器地址
  * 目的地址为255.255.255.255
DHCP允许网络上配置多台DHCP服务器，当DHCP客户发出“DHCP发现”消息时，有可能收到多个应答消息。这时，DHCP客户只会挑选其中的一个，通常挑选最先到达的。

DHCP服务器分配给DHCP客户的IP地址是**临时**的，thus DHCP客户只能在一段有限的时间内使用这个分配到的IP地址。DHCP称这段时间为**租用期** 
- 数值 由 DHCP**服务器**自己**决定**
- DHCP客户 也可在自己发送的**报文中** **提**出对租用期的**要求**

DHCP客户和服务器端需要通过**广播方式**来进行交互，原因是在DHCP执行初期，客户机不知道服务器端的IP地址，而在执行中间，客户机并未被分配IP地址，从而导致两者之间的通信必须采用广播的方式。
#### 采用UDP而不采用TCP的原因
- TCP need建立连接 ← 若连对方的IP地址都不知道，更不可能通过双方的套接字建立连接。



### 网际控制报文**I**nternet **C**ontrol **M**essage协议（ICMP）

> **pro：直接为ICMP提供服务的协议（2012）**
<details>
<summary>IP</summary>
直接为ICMP（Internet Control Message Protocol，互联网控制报文协议）提供服务的协议是IP（Internet Protocol，互联网协议）。ICMP是<b>TCP/IP协议族</b>中的一个<b>子协议</b>，位于网络层，主要用于在网络设备之间传递控制信息和错误报告。

ICMP报文作为数据字段封装在IP分组中，因此IP协议直接为ICMP提供服务。当网络中的设备需要发送ICMP报文时，它们会将ICMP报文封装在IP数据报中，并通过IP协议进行传输。这样，ICMP就可以利用IP协议提供的服务来实现其功能，如网络诊断、错误报告等。

<b>UDP</b>（User Datagram Protocol，用户数据报协议）和<b>TCP</b>（Transmission Control Protocol，传输控制协议）是<b>传输层协议</b>，为应用层提供服务，而不是直接为ICMP提供服务。
PPP（Point-to-Point Protocol，点对点协议）是<b>链路层协议</b>，为网络层提供服务，但也不是直接为ICMP提供服务。</details>

#### 概述
  * 为了有效地转发IP DG & 提高交付成功的机会，在网络层使用了ICMP
  * ICMP报文被封装in IPDG中发送
    * ICMIP**不是高层**协议，is 网络层的协议
    * ICMP报文有两种：ICMP**差错报告**报文和ICMP**询问**报文

####  ICMP差错报告报文Error report message
  > **pro：ICMP差错报文的类型及含义（2022）**
  * 用途：
    * 目标主机或到目标主机路径上的路由器，向**源主机** 报告**差错**和**异常**情况
  * 5种常用类型：
    - >遇到相应情况，执行操作&send 相应report message
    * 终点不可达Destination Unreachable：
      * 路由器或主机**不能交付**数据报时 → 向源点发送**终点不可达**message
    * 源点抑制Source Quench：
      * 路由器或主机因为拥塞而**丢弃****DG**时 → 向源点发送 **源点抑制**message，使源点放慢发送速率
    * 时间超过Time Exceeded：
      * 路由器收到TTL为零的数据报时
      * 终点在预定时间内不能收到全部数据报片时
    * 参数问题Parameter Problem：
      * 收到的数据报首部字段值不正确时
    * 改变路由（重定向）Redirect：
      * 通知主机下次应将数据报发送给**另外的**路由器

  * 不应发送ICMP差错报告报文的情况：
    * 对ICMP差错报告报文
      * <span style="font-size: 14px;"> 不再针对这些报文本身发送额外的CMP差错报告报文 → 防止报文循环和可能的网络拥塞
    * 对第一个分片的数据报片的所有后续数据报片
      *  <span style="font-size: 14px;"> 避免重复报告
    * 对具有多播地址的DG
      *  <span style="font-size: 14px;"> 多播地址用于向多个接收者发送数据报，接收者数量不确定 →以减少网络流量
    * 对具有特殊地址如127.0.0.0或0.0.0.0)的DG
      *  <span style="font-size: 14px;"> 特殊地址用于特定的网络功能，如回环测试(127.0.0.0)和未指定地址(0.0.0.0) → 避免干扰这些功能的正常运行

####  ICMP询问报文Query message
  * 4种类型：
    * 回送 请求和回答报文
    * 时间戳timestamp~ //前2type常用
    * 地址掩码~
    * 路由器 询问和通告报文

####  ICMP常见应用
  * PING（Packet InterNet Groper）~分组网间探测~
    * 用途：test两台主机之间的连通性
    * 使用ICMP回送请求和回答报文
    * 工作在应用层，直接使用网络层的ICMP
  * Traceroute/Tracert
    * 用途：跟踪分组经过的路由
    * 使用ICMP时间超过报文
    * 工作在网络层
## IPv<b><span style="color:green;">6</b>

### 特点

#### 解决IPv4地址耗尽'methods
目前广泛使用的IPv4是在20世纪70年代设计的，互联网经过几十年的飞速发展，到2011年2月，**IPv4地址**已经**耗尽**.

1）采用无类别编址CIDR，使IP地址的分配更加合理。
2）采用网络地址转换（NAT）方法以节省全球IP地址。
3）采用具有更大地址空间的新版本的IPv6。前两种方法只是延长了IPv4使用寿命，only IPv6 从根本上解决IP地址耗尽问题

#### IPv6特点
> **pro：IPv6的特点（2023）**


- 更大的地址空间
    - IPv6 将地址从 IPv4的32位增大到128位
    - IPv6的地址空间是IPv4的 $2^{128-32}=2^{96}$ 倍
      - 地址绝对够用

- 扩展的地址层次结构
    - 因为地址空间很大，thus 可以划分为更多的层次

- 灵活的首部格式
    - IPv6定义了许多可选的扩展首部，不仅可提供比IPv4更多的功能，而且能提高路由器的处理效率
    - 路由器对扩展首部不进行处理

- 改进的选项
    - IPv6 首部长度是固定的，其选项放在有效载荷中，选项是灵活可变的
    - IPv4所规定的选项是固定不变的，其选项放在首部的可变部分

- 允许协议继续扩充
    - IPv6允许不断扩充功能，而IPv4的功能是固定不变的

- 支持**即插即用**（即自动配置）
    - IPv6不需要使用DHCP

- 支持**资源**的**预分配**
    - IPv6支持实时音/视频等要求保证一定带宽和时延的应用

- IPv6 only源主机才能分片
    - 是端到端的，不允许类似IPv4传输路径中的路由分片

- IPv6**HEADER**长度是固定的
    - IPv6首部长度是固定的40B
    - IPv4首部长度是可变的（必须是4B的整数倍）

- 增大安全性
    - 身份鉴别&保密功能是IPv6的扩展首部
  
#### IPv6兼容性
与IPv4不兼容
与所有其他的互联网协议兼容
- 包括TCP、UDP、ICMP、IGMP和DNS等
- 只是在少数地方做了必要的修改（大部分是为了处理长地址）

### IPv6数据报的基本首部


#### 数据报组成
- IPv6数据报由两部分组成：基本首部和有效载荷（也称净负荷）。
- 有效载荷由零个或多个扩展首部及其后面的数据部分构成。

#### IPv6数据报的一般形式
![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f698b67646d9930c64da34e52dc45dad7d35022f8c9f2fdb596f320bf237c685.jpg)
图4.11具有多个可选扩展首部的IPv6数据报的一般形式

#### 基本首部长度
- IPv6基本首部的字段数减少到只有8个。
- 由于IPv6地址长度为128位，IPv6基本首部的长度增大到40B。

#### 基本首部的格式
![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/03769dd7cc9b50a35c96a4fc7fbf8a9c5757c87a33f21ed45608a52f302efe1f.jpg)
图4.12IPv6数据报的基本首部的格式

> **pro：IPv6基本首部字段的意义（2023）**

#### 基本首部字段含义
1. **版本**
   - 占4位，指明协议的版本，对于IPv6该字段的值是6。
2. **通信量类**
   - 占8位，用来区分不同的IPv6数据报的类别或优先级。
3. **流标号**
   - 占20位，IPv6提出流的抽象概念。
   - 流是指互联网上从特定源点到特定终点的一系列数据报。
   - 所有属于同一个流的数据报都具有相同的流标号。
4. **有效载荷长度**
   - 占16位，指明IPv6数据报除基本首部以外的字节数。
   - 这个字段的最大值是65535（单位为字节）。
5. **下一个首部**
   - 占8位，相当于IPv4首部中的协议字段或可选字段。
   - 当IPv6没有扩展首部时，指明IPv6数据报所运载的数据是何种协议数据单元。
   - 当IPv6带有扩展首部时，标识后面第一个扩展首部的类型。
6. **跳数限制**
   - 占8位，类似于IPv4首部的TTL字段。
   - 源点在每个数据报发出时设定某个限制值（最大为255）。
   - 路由器每次转发时将其值减1，减为零时将该数据报丢弃。
7. **源地址和目的地址**
   - 占128位，是数据报的发送端/接收端的IP地址。


### IPv6地址

#### 基本类型
- IPv6数据报的**目的地址**有以下三种基本类型：
  - 单播unicast：
    - 传统的**点对点**通信。
  - 多播multicast：
    - **一点对多点**的通信，DG → 一组计算机中的每一台。
  - 任播anycast：
    - IPv6**增加的**一种类型
    - **终点**is一组计算机
    - but DG只交付其中的一台计算机（usaually距离最近的一台

#### 地址表示法Address notation
##### 冒号十六进制记法Colon hexadecimal notation
<span style="font-size: 14px;"> IPv4地址通常使用 **点分十进制** 表示法。若IPv6也使用这种表示法，则地址书写起来将相当长。
- Colon hexadecimal notation：
  - 每4位 → 一个十六进制数表示
  - 冒号分隔每16位(In binary)
    - 如4BF5:AA12:0216:FEBC:BA5F:039A:BE9A：2170

##### 缩写规则
- 16位域的开头有一些**0**时：
  - 可以采用一种缩写表示法
  - but域中必须至少有一个数字
  - eg: 地址4BF5:0000:0000:**0000**:BA5F**:039A**:**000A**:2176 → 4BF5:0:0:**0**:BA5F:**39A**:**A**:2176

- 当有**相继的0**值域时：
  - 可以用**双冒号**缩写（：）
  - 双冒号表示法在一个地址中**仅能出现一次**
  - 前述地址可被更紧凑地书写成4BF5 **::** BA5F:39A:A：2176

#### 地址分类
- IPv6地址的分类如表4.3所示。

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/471fef216dc17fd584cc9b372fa479feea53d81138258a20d51f969078e66308.jpg)

##### 五类地址解释
- 未指明地址Unspecified address：
  - 该地址**不能用作** **目的地址**
  - **only** used in还未配置IPv6地址的主机作为**源地址**

- 环回地址Loopback address：
  - 该地址的作用与IPv4的环回地址相同
  - IPv6的环回地址仅此一个

- **多播**地址Multicast address：
  - 该地址的作用和IPv4的一样
  - 这类地址占IPv6地址空间的1/256

- 本地链路**单播**地址Local link unicast address：
  - 该地址的作用类似于IPv4的私有IP地址

- 全球**单播**地址：
  -**用得最多**的地址
  - IPv6全球单播地址采用**三级结构**：
    - 第一级为 全球路由选择前缀**G**lobal **r**outing **p**refix，占48位
      - 用于互联网中的**路由选择**（IPv4分类地址中的**网络号**
    - 第二级为 **子网标识**符，占16位
      - 用于各机构**构建**自己的**子网**
    - 第三级为**接口标识符**
      - 用于指明主机或路由器的单个网络接口（IPv4分类地址中的**主机号**

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/2b339deff31fff0c110cdba987c1a5abd5ca2b0abcb54b14675383edc6b3882a.jpg)

#### 接口标识符特点
- 与IPv4不同，IPv6地址的接口标识符有64位之多
- 足以对各种接口的硬件地址直接进行编码
- IPv6就可直接从128位地址的最后64位中直接提取出相应的硬件地址
- 不需要使用地址解析协议（ARP）进行地址解析

### IPv 4 IPv 6

#### IPv4向IPv6过渡
- 从IPv4向IPv6**过渡**只能采用**逐步演进**的办法
  - must also使新安装的 **IPv6**系统能够**向后兼容**
- IPv6系统必须能够：
  - 接收和转发IPv4分组
  - 能够为IPv4分组选择路由

> **pro：IPv4向IPv6过渡的策略（2023）**

##### 过渡策略Transition strategy
###### 双协议栈Dual stack
- 指在一台设备上同时装有**IPv4**和**IPv6**两个协议栈
  - 分别配置了一个IPv4地址和一个IPv6地址
- 这台设备既能和IPv4网络通信，又能和IPv6网络通信
- 双协议栈主机通信**特点**：
  - 谁"通"采"谁“
    - 在与IPv6主机通信时采用IPv6地址
    - 在与IPv4主机通信时采用IPv4地址
  - 使用应用层的域名系统（DNS）获知**目的主机**采用的是哪种地址
    - 若DNS返回的是IPv4地址，则双协议的源主机就使用IPv4地址
    - 若DNS返回的是IPv6地址，则双协议栈的源主机就使用IPv6地址

###### 隧道技术Tunnel technology
- 指在IPv6 DG要进入IPv4网络时：
  - 封装: 把整个IPv6数据报**封装**成IPv4数据报的数据部分
    - **传输**: 使原来的IPv6数据报就好像在IPv4网络的隧道中传输
- 当IPv4数据报离开IPv4网络时：
  - **解**封装: 移除PV4的首部，将原来的IPv6DG提取出来
  - **传递**: 
    - 提取出的IPV6数据报然后被传递给主机的1PV6协议栈
    - 按照IPv6的路由规则进行传输，till destination

## Routing算法&协议

### 路由算法

- 路由选择协议的核心是路由算法，即需要何种算法来获得路由表中的各个项目。
- 路由算法的**目的**：
  - 给定一组路由器及连接路由器的链路
  - 路由算法要找到一条从源路由器到目的路由器的"**最佳**"**路径**
    - 通常，"最佳"路径是指have最低费用的路径


#### 静态路由&动态~
  路由器转发分组是通过路由表转发的，而**路由表**是通过**各种算法**得到的
- 从whether随网络的通信量or拓扑**自适应**地进行**调整变化**来划分，路由算法可以分为如下两大类
  ##### 静态路由算法
  - 指由网络管理员**手工配置**每一条路由
  ##### 动态路由算法
  - 根据网络流量负载和拓扑结构的变化来**动态调整**自身的路由表

###### 特点对比
- 静态路由算法
  - **简单**和**开销较小**
  - **不能及**时**适应**网络状态的变化
  - 适用于简单的**小型网络**
- 动态路由算法
  - 能较好地适应网络状态的变化
  - 实现复杂，开销也大
  - 适用于较复杂的**大网络**
  - 常用的动态路由算法可分为两类：
    - 距离-向量 路由算法 & 链路状态路由算法

#### 距离-向量distance-vector 路由算法(D)
- 距离-向量算法的基础是Belliman-Ford算法，用于计算单源**最短路径**
- 每个结点**以自身为源点**执行Bellman-Ford算法，thus 全局上可以解决任意结点对之间的最短路径问题
*short as DV personally

>all最短路径算法都依赖于一个性质：“两点之间的最短路径also包含了路径上其他顶点间的最短路径。”

↑ 路上include其他顶点
##### Bellman-Ford算法 基本思想
- 假设
  -  $d_{v_i}(y)$ 表示从结点 $x$ 到结点 $y$ 的带权最短路径的cost:
  - 式中， $c(x,v_k)$ 是从 $x$ 到其邻居 $\nu$ 的费用
- if已知 $x$ 的所有邻居到 $y$ 的最短路径费用后，从 $x$ 到y的最短路径费用是对所有邻居 $v$ 的 $c(x,{\nu}_k)+d_{{\nu}_i}(y)$ 的最小值

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/12611813d1879774849211636fc146bfc2d29d0e6ae99f100dc9742f52c0fa79.jpg)
图4.13Bellman-Ford算法的基本思想

##### 路由信息维护
每个结点 $x$ 维护下列路由信息：
- 从 $x$ 到每个直接相连邻居 $\nu$ 的**链路费用**$c(x,v_k)$
  - 结点 $x$ 的**DV**，即 $x$ →网络中其他结点的费用。这是一组距离，thus称为距离向量
- 它收到的每个邻居的距离向量，即 $x$ 的每个**邻居** **到**网络中**其他结点**的**费用**

##### 算法实现过程
- 每个结点**定期**地**向**它的每个**邻居** **发送**它的距离向量副本
- 当**结点** $x$ 从它的任何一个邻居 $v$ **接收**到一个**新**DV时：
  - 首先保存 $v$ 的距离向量
  - Bellman-Ford公式 $d_{x}(y)=min\{{c(x,v)+d_{v}(y)}\}$ 更新自己的距离向量
- 若结点 $x$ 的距离向量因这个更新步骤而改变，则结点 $x$ 接下来继续向它的每个邻居发送其更新后的距离向量

> **pro：距离向量路由算法的具体实现（2021）**

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/768629927fac929d4ab41b84621905d8960be70fc17d30ff64b196f1098835be.jpg)
图4.14距离向量算法实现的举例
↑ ？更新的过程 是不是 没体现
##### 算法示例说明
- 初始化阶段
  - 各结点之间**尚未交换过任何**路由信息
  - 各结点的初始化距离向量 = 它到每个直接相连邻居v的费用
- 更新过程
  - 初始化后，
  - 每个结点**第一次**向它的所有邻居**发送**其距离向量
    - 接收到更新报文后，每个结点**重新计算**自已的距离向量
  - 结点的距离**向量变化后**，**再次**向它们的邻居**发送**更新的距离向量
    - **没有变化**的结点**不**用**发送**更新报文
    - 当**无 结点更新**时，算法进入静止状态

#### 链路状态Link state 路由算法(D)
- 链路状态是指本路由器都和哪些路由器相邻，以及相应链路的代价

##### 基本任务
- 要求: 每个**结点**都具有**全网 拓扑结构图**（this拓扑结构图在全网范围内是一致的）
- 执行**两项任务**：
  - 主动测试所有**相邻结点**的**状态**
  - **定期**地将**链路状态**传播 → **所有其他结点**

##### 算法工作过程
- 每个结点all
  - 知道全网共有多少个结点、哪些结点是相连的、其代价是多少etc ← other NODEs' info
  - can use Dijkstra**最短路径算法**
    - 计算出到达其他结点的最短路径
- 结点每收到一个链路状态报文
  - use it to更新自己的网络状态"视野图"
  - once链路状态发生变化
    - use Dijkstra算法重新计算到达所有其他结点的最短路径

##### 算法优点
>独立
- 每个结点都使用同样的链路状态数据**独立**地**计算**路径，而**不依赖中间**结点的计算
- 链路状态报文**不加改变地传播**，thus采用该算法**易于查找敌障**
- 当一个结点**从所有其他结点**接收到报文时，它就在本地立即计算出正确的路径，**保证一步汇聚**
- 因为链路状态报文仅运载**来自单个结点**关于直接链路的信息，其**大小与**网络中的**结点数目无关**
- comparison： 链路状态算法比距离-向量算法有**更好的**规模**可伸展性**

##### 两种路由算法的比较
- 距离-向量算法
  - 每个结点**仅**与它的**直接邻居**交谈
  - 向它的邻居发送自己的路由表
  - 其大小**取决于**网络中的**结点数目**，代价较大
- 链路状态算法
  - 每个结点通过广播的方式与**所有其他**结点交谈
  - 只告诉它们与它**直接相连**的链路的费用
  - 典型的链路状态路由算法是OSPF算法

### 分层次的路由选择协议
- 互联网采用的是自适应的、分布式路由选择协议
- 因为互联网的规模非常大，许多联网单位不愿让外界了解自己单位网络的布局细节，thus 互联网采用分层次的路由选择协议
- 为此，可以把整个互联网划分为许多较小的自治系统（AutonomousSystem，AS）
  - 自治系统是在单一技术管理下的一组路由器，这些路由器使用一种AS内部的路由选择协议和共同的度量
  - 一个AS对其他AS表现出的是一个单一的和一致的路由选择策略

#### 路由选择协议的两大类
##### 内部网关协议（Interior Gateway Protocol，IGP）
- 内部网关协议即在一个自治系统内部使用的路由选择协议
  - 它与在互联网中的其他自治系统选用什么路由选择协议无关
  - 自前这类路由选择协议使用得最多，如RIP和OSPF

##### 外部网关协议（External Gateway Protocol，EGP）
- 用于不同自治系统间的路由选择
  - 若源主机和目的主机处在不同的自治系统中（两个自治系统可能使用不同的IGP）
  - 当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中
- 目前使用最多的外部网关协议是BGP-4

##### 域间与域内路由选择
- 基本概念
  - 自治系统之间的路由选择也称域间路由选择
  - 自治系统内部的路由选择也称域内路由选择
- 实现方式
  - 每个自治系统自己决定在本自治系统内部运行哪个内部网关协议
  - 每个自治系统都有一个或多个路由器除运行本系统的内部网关协议外，还要运行外部网关协议

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/6112522be698219f313ddd9b098f0e24bb2125b01240cce7be446986a2d591b1.jpg)
图4.15自治系统和内部网关协议、外部网关协议

### 路由信息协议（RIP）
> 一种分布式的基于距离向量的路由选择协议

#### RIP的基本规定
- 应用范围
  - is内部网关协议IGP中最先得到广泛apply的protocol
- 基本要求
  - 网络中的每个路由器都要维护从它自身到其他每个目的网络的距离记录
  - RIP使用跳数（HopCount）来衡量到达目的网络的距离
    - 从一路由器到直接连接的网络的距离定义为1
    - 每经过一个路由器，距离就加1
  - RIP认为好的路由就是通过的路由器数目少

> **pro：RIP中跳数为16的含义（2010）**

- 跳数限制
  - RIP允许一条路径最多只能包含15个路由器
    - 距离等于16时表示网络不可达
    - RIP只适用于小型互联网
    - 限制跳数目的是防止分组在环路上循环
- 路由表结构
  - 每个路由表项都有三个关键字段：<目的网络 $N$ ，距离 $d$ ，下一跳路由器地址 $\chi>$

#### RIP的特点
##### 信息交换机制
- 交换对象
  - 仅和直接相邻的路由器交换信息
- 交换内容
  - 交换的信息是本路由器所知道的全部信息，即自己的路由表
- 交换时机
  - 按固定的时间间隔（如30秒）交换
  - 网络拓扑变化时及时通告

##### 路由器工作过程
- 初始阶段
  - 只知道自己到直接相连的几个网络的距离为1
- 更新阶段
  - 每个路由器仅和相邻路由器周期性地交换并更新路由信息
- 收敛阶段
  - 所有路由器最终知道到达本自治系统内任何网络的最短距离和下一跳路由器地址

> **pro：封装RIP报文所采用的协议（2017）**

##### 协议特性
- 传输层协议
  - RIP是应用层协议，使用UDP传送数据（端口520）
- 路径选择
  - RIP选择的路径不一定是时间最短的
  - 一定是具有最少的路由跳数
#### RIP的距离向量算法
- 对每个相邻路由器发送来的RIP报文，执行如下步骤：
  ##### 步骤1：报文修改
  - 对地址为 $X$ 的相邻路由器发来的RIP报文，先修改此报文中的所有项目：
    - 把"下一跳"字段中的地址都改为 $X,$ 
    - 并把所有"距离"字段的值加1

  ##### 步骤2：项目处理
  - 对修改后的RIP报文中的每个项目，执行如下步骤：
    - IF（若原来的路由表中没有目的网络 $N$) 则把该项目添加到路由表中（表明这是新的目的网络）
    - ELSEIF（若原来的路由表中有目的网络 $N$ ，且下一跳路由器的地址是 $X)$ 用收到的项目替换原路由表中的项目（因为要以更新的消息为准）
    - ELSEIF（若原来的路由表中有目的网络 $N$ ，且下一跳路由器的地址不是 $X)$ 若收到的项目中的距离 $d$ 小于路由表中的距离，则进行更新
    - ELSE什么也不做

  ##### 步骤3：超时处理
  - 若180秒（RIP默认超时时间）还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达的路由器，即把距离设置为16（距离为16表示不可达）

  ##### 步骤4：返回

- 举例说明RIP路由条目的更新过程：
  - 已知路由器R6和R4互为相邻路由器，表4.4(a)所示为R6的路由表，现在收到相邻路由器R4发来的路由更新信息，如表4.4(b)所示

表4.4(a）R6的路由表 ![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/889f89c59d634d95c1bd9984787004bbb1abfc4ccc76b076c5aebc5983ca6261.jpg)

表4.4(b）R4发来的路由表 ![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/91cd1866cfc529d657f0a9580a36d851d3fc8364d3a2201b39819805333824a4.jpg)

- 更新R6的路由表过程：
  - 先把 $\mathrm{R_{4}}$ 发来的路由表［表4.4(b)]`中各项的距离都加1，并把下一跳路由器都改为R4，得到表4.5(a)
  - 将这个表的每行与R6的路由表[表4.4(a)］进行比较：
    - 第一行的Netl在表4.4(a)中没有，thus要把这一行添加到表4.4(a)中
    - 第二行的Net2在表4.4(a)中有，且下一跳路由器也是R4，thus要更新（距离增大了）
    - 第三行的Net3在表4.4(a)中有，但下一跳路由器不同。于是需要比较距离。新的路由信息的距离是2，小于原表中的4，thus要更新
  - 这样，得出更新后的R6的路由表如表4.5(b)所示

表4.5(a)修改R4发来的路由表 ![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/a97c4d76eb3895ef462128c5897814b8e3366a96be378450b6fc83b80323f2fd.jpg)

表4.5(b)R6更新后的路由表 ![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/91b094f046fb1e1478116d0079f503cecbaa272a878d4bac0f8118446d285adb.jpg)

#### RIP的优缺点
##### RIP的优点：
- 实现简单、开销小、收敛过程较快
- 若一个路由器发现了更短的路由，则这种更新信息就传播得很快，在较短时间内便可被传至所有路由器，俗称"好消息传播得快"

##### RIP的缺点：
- RIP限制了网络的规模，它能使用的最大距离为15（16表示不可达）
- 路由器之间交换的是路由器中的完整路由表，thus网络规模越大，开销也越大
- 当网络出现故障时，路由器之间需反复多次交换信息才能完成收敛，要经过较长时间才能将故障消息传送到所有路由器（即慢收敛现象），俗称"坏消息传播得慢"

##### RIP"好消息传播得快，坏消息传播得慢"的特点举例
- 假设图4.16中的路由器都采用RIP交换路由信息，初始时R1到网络 $N$ 的距离为4，且R1和R2均已收敛

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/fcb2f30da895050fcf0b8687df1e357c43fd6cb3ad48015e8494ffb22c268878.jpg)
图4.16RIP举例：链路开销改变

###### 好消息传播快的情况：
- 在图4.16(a)中：
  - 某时刻R1的某个端口检测到"到 $N$ 更短的链路"（距离由4变为1）
  - R1计算其到 $N$ 的最新距离 = $\min\{1, 1+R2到N的距离\} = \min\{1, 1+5\} = 1$，并通知邻居
  - R2收到后，更新其到 $N$ 的距离为2，并通知邻居
  - R1收到后，R1到 $N$ 的最短距离未变，不再发送通知，算法进入静止状态
- 可见，R2到 $N$ 的距离减少的好消息通过RIP得到了迅速传播

> **pro：RIP"坏消息传播得慢"的分析（2016）**

###### 坏消息传播慢的情况：
- 在图4.16（b)中：
  - 某时刻R1的某个端口检测到" $^{\circ}N$ 不可达"（即距离变为16）
  - R1计算其到 $N$ 的最新距离 = $\min\{16, 1+R2到N的距离\} = \min\{16, 1+5\} = 6$ 
  - 从网络全局的视角可以看出，经过R2的这个新距离显然是错误的
  - R1算出到 $N$ 的最新距离后，通知邻居
  - R2收到后，更新其到 $N$ 的距离为7,通知邻居
  - R1收到后，计算其到 $N$ 的距离= $\min\{16, 1+R2到N的距离\} = \min\{16, 1+7\} = 8$，继续通知邻居
  - 如此循环，直到R2最终算出它经由R1到达 $N$ 的距离为16为止
- 可见，RIP关于链路故障或距离增加的坏消息传播得很慢

### 开放最短路径优先Open shortest path first（OSPF）协议

#### OSPF协议的基本特点

- OSPF与RIP相比有以下4点主要区别：
  - OSPF向本自治系统中所有路由器发送信息。这里使用的方法是洪泛法。而RIP仅仅向自己相邻的几个路由器发送信息。
  - 发送的信息是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。而在RIP中，发送的信息是本路由器所知道的全部信息，即整个路由表。
  - 只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息，并且更新过程收敛得快，不会出现RIP"坏消息传得慢"的问题。而在RIP中，不管网络拓扑是否发生变化，路由器之间都要定期交换路由表的信息。

> **pro：封装OSPF报文所采用的协议（2017）**

- OSPF是网络层协议，它不用UDP或TCP，而直接用IP数据报传送（其IP数据报首部的协议字段为89）。而RIP是应用层协议，它在传输层使用UDP。

> **attention:**

- 用UDP传送是指将该信息作为UDP报文的数据部分，而直接使用IP数据报传送是指将该信息直接作为IP数据报的数据部分。RIP报文是作为UDP数据报的数据部分。

##### OSPF的其他特点
- OSPF充许对每条路由设置成不同的代价，对于不同类型的业务可计算出不同的路由。
- 若到同一个目的网络有多条相同代价的路径，则可将通信量分配给这几条路径。
- OSPF分组具有鉴别功能，从而保证仅在可信赖的路由器之间交换链路状态信息。
- OSPF支持可变长度的子网划分和无分类编址CIDR。
- 每个链路状态都带上一个32位的序号，序号越大，状态就越新。

#### OSPF的基本工作原理

- 基本流程：
  - 各路由器之间频繁地交换链路状态信息
  - 所有路由器最终都能建立一个链路状态数据库，即全网的拓扑结构图
  - 每个路由器利用链路状态数据库中的数据，使用Dijkstra算法计算自己到达各自的网络的最优路径，构造出自己的路由表
  - 当链路状态发生变化时，每个路由器重新计算到达各目的网络的最优路径，构造出新的路由表

> **attention:**

- 虽然使用Dijkstra算法能计算出完整的最优路径，但路由表中不会存储完整路径，而只存储"下一跳"（只有到了下一跳路由器，才能知道再下一跳应当怎样走）。

##### OSPF的区域划分
- 为了使OSPF能够用于规模很大的网络，OSPF将一个自治系统再划分为若干更小的范围，称为区域
- 划分区域的好处是，将利用洪泛法交换链路状态信息的范围局限在每个区域而非整个自治系统，从而减少了整个网络上的通信量

#### OSPF的五种分组类型

- 问候分组：用来发现和维持邻站的可达性
- 数据库描述分组：向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息
- 链路状态请求分组：尚对方请求发送某些链路状态项目的详细信息
- 链路状态更新分组：用洪泛法对全网更新链路状态，它是OSPF最核心的部分
- 链路状态确认分组：对链路更新分组的确认

##### OSPF分组的传送机制
- 问候分组的传送：
  - 在网络中通常传送的OSPF分组大多是问候分组
  - 两个相邻路由器通常每隔10秒要交换一次问候分组，以便知道哪些站可达
  - 若有40秒没有收到某个相邻路由器发来的问候分组，则认为该相邻路由器不可达，应立即修改链路状态数据库，并重新计算路由表

##### OSPF的初始化过程
- 路由器刚开始工作时：
  - OSPF让每个路由器使用数据库描述分组和相邻路由器交换本数据库中已有的链路状态摘要信息
  - 然后，路由器使用链路状态请求分组，向对方请求发送自己所缺少的某些链路状态项目的详细信息
  - 经过一系列的这种分组交换，就建立了全网同步的链路数据库

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/f0865e7a3e56305b7752f9c75c0c571d220f187b9e36b71961fb01a56f2fc570.jpg)
图4.17OSPF的基本操作

##### OSPF的运行维护
- 链路状态更新：
  - 只要一个路由器的链路状态发生变化，该路由器就要使用链路状态更新分组，用洪泛法向全网更新链路状态
  - 其他路由器在收到更新分组后要发送确认
- 数据库刷新：
  - 为了确保链路状态数据库与全网的状态保持一致，OSPF还规定每隔一段时间（如30分钟）要刷新一次数据库中的链路状态
  - 因为一个路由器的链路状态只涉及与相邻路由器的连通状态，与整个网络的规模并无直接关系，thus 当互联网规模很大时，OSPF要比RIP好得多
### 边界网关Boundary gateway协议（BGP）

> **pro：BGP的作用（2013）**

#### BGP的基本概念
- 边界网关协议（Border Gateway Protocol，BGP）AS信息的协议，是一种外部网关协议
- 边界网关协议BGP常用于互联网的网关之间

#### BGP的环境特点
- 内部网关协议主要是设法使数据报在一个AS中尽可能有效地从源站传送到目的站
- 在一个AS内部也不需要考虑其他方面的策略
- 然而BGP使用的环境却不同，主要原因如下：
  - 互联网的规模太大，使得AS之间路由选择非常困难，每个主干网路由器表中的项目数都非常庞大
  - AS之间的路由选择必须考虑政治、安全或经济等有关因素

#### BGP的工作原理
##### BGP的基本特征
- BGP只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由
- BGP采用的是路径向量路由选择协议，它与距离向量协议（如RIP）和链路状态协议（如OSPF）都有很大的区别
- BGP是应用层协议，它是基于TCP的

##### BGP的运行过程
1. 配置BGP时，每个AS的管理员要选择至少一个路由器，作为该AS的"BGP发言人"BGP发言人往往就是BGP边界路由器

> **pro：封装BGP报文所采用的协议（2013、2017）**

2. 一个BGP发言人与其他AS中的BGP发言人要交换路由信息：
   - 先建立TCP连接
   - 然后在此连接上交换BGP报文以建立BGP会话
   - 再利用BGP会话交换路由信息
   - 使用TCP连接交换路由信息的两个BGP发言人，彼此成为对方的邻站或对等站
   - 每个BGP发言人除了必须运行BGP外，还必须运行该AS所用的内部网关协议，如OSPF或RIP

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/4ab8772ba2216b0083326b701c09c66e732cf291ac3af19cc38f7fdaebe5ed2b.jpg)
图4.18BGP发言人和自治系统AS的关系示意图

3. BGP所交换的网络可达性信息：
   - 就是要到达某个网络所要经过的一系列自治系统
   - 当BGPP发言人互相交换网络可达性的信息后，各BGP发言人就根据所用的策略，从收到的路由信息中找出到达各自治系统的较好路由

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/8f8fe0ecd96d6202cbd624e068791f7ff2d406d6b61dd7bf65606f87db5e3929.jpg)
图4.19主干网与自治系统间路径向量的交换

#### BGP的特点
- BGP交换路由信息的结点数量级是AS个数的数量级，这要比这些AS中的网络数少很多
- 寻找一条较好的路径，取决于找准正确的BGP发言人，而每个AS中BGP发言人（或边界路由器）的数目是很少的。这样就使得AS之间的路由选择不致过分复杂
- BGP支持CIDR，thusBGP的路由表也就应当包括目的网络前缀、下一跳路由器，以及
- 当BGP刚运行时，BGP的邻站交换整个BGP路由表。但以后只需要在发生变化时更新有变化的部分。这样做对节省网络带宽和减少路由器的处理开销方面都有好处

#### BGP的报文类型
- BGP-4共使用4种报文：
  - 打开（Open）报文：用来与相邻的另一个BGP发言人建立关系，使通信初始化
  - 更新（Update）报文：用来通知某一路由的信息，以及列出要撤销的多条路由
  - 保活（Keepalive）报文：用来周期性地证实邻站的连通性
  - 通知（Notification）报文：用来发送检测到的差错

#### BGP的通信过程
- 建立邻站关系：
  - BGP发言人向对方发送Open报文
  - 对方接受则用Keepalive报文响应
- 维持邻站关系：
  - 两个BGP发言人彼此要周期性地交换Keepalive报文（一般每隔30秒）
  - Keepalive报文只有19B，thus不会造成网络上太大的开销
- 路由更新：
  - Update报文是BGP的核心内容
  - BGP发言人可以用Update报文撤销它曾经通知过的路由，也可以宣布增加新的路由

表4.6三种路由协议的比较 ![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/15cd3d3b0e07729275343dbe5d0888070cbc40ba2780a33c5736517ae359032a.jpg)

## IP<span style="color: orange;">多<span style="color:green;">播

### 概念

#### 定义
- 多播:
  - 让源主机一次发送的单个分组可以抵达用一个组地址标识的若干目的主机
    - 即**一对多**的通信
- 在互联网上进行的多播 ← IP多播

#### <span style="color: orange;">多</span><span style="color:green;">播</span>与<span style="color:darkviolet;">单</span>播的比较
##### 资源效率
- 与单播相比，在一对多的通信中，多播可大大节约网络资源
- 示例：视频服务器向90台主机传送同样的视频节目时的对比
  - 多播时仅发送一份数据，并且只需发送一次
  - 只有在传送路径出现分岔时才将分组复制后继续转发
  - 因此大大减轻了发送者的负担和网络的负载

##### 实现要求
- 多播需要路由器的支持才能实现
- 能够运行多播协议的路由器称为多播路由器

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/19528b897648d1681e5067d8ed74aca814c66c4a765522f6600af4b81a300c9f.jpg)
图4.20单播与多播的比较
### IP多播<span style="color:lightblue;">地址

#### D类地址范围与多播组
- 多播数据报的源地址是源主机的IP地址，目的地址是IP多播地址
- IP多播地址就是IPv4中的D类地址
  - D类地址的前四位是1110
  - D类地址范围是 $224.0.0.0{\sim}239.255.255.255.255.$
- 每个D类IP地址标志一个多播组，一台主机可以随时加入或离开一个多播组

#### 多播数据报特点
- 多播数据报和一般的IP数据报的区别：
  - 前者使用D类IP地址作为目的地址
  - 首部中的协议字段值是2，表明使用IGMP协议
- 需要注意的是：
  1）多播数据报也是"尽最大努力交付"，不提供可靠交付。
  2）多播地址只能用于目的地址，而不能用于源地址。
  3）对多播数据报不产生ICMP差错报文。

#### IP多播分类与应用
- IP多播可以分为两种：
  - ① 只在本局域网上进行硬件多播
  - $\circledcirc$ 在互联网的范围内进行多播
- 目前大部分主机都是通过局域网接入互联网的
  - 在互联网上进行多播的最后阶段，还是要把多播数据报在局域网上用硬件多播交付给多播组的所有成员［见图4.20(b)]`
- 多播机制仅应用于UDP，它能将报文同时发送给多个接收者
- TCP是一个面向连接的协议，它意味着分别运行在两台主机的进程之间存在一条连接，thus会一对一地发送

### 在局域网上进行硬件多播

#### 多播地址映射过程
- 因为局域网支持硬件多播，thus只要把IP多播地址映射成多播MAC地址
- 即可将IP多播数据报封装在局域网的MAC帧中
- MAC顿首部的目的MAC地址字段就设置为由IP多播地址映射成的多播MAC地址

#### 以太网多播地址范围
- IANA拥有的以太网多播地址的范围是从01-00-5E-00-00-00到01-00-5E-7F-FF-FF
- 在这些地址中：
  - 只有23位可用作多播
  - 这只能和D类IP地址中的23位有一一对应关系
  - D类IP地址可供分配的有28位，可见在这28位中前5位无法映射到多播MAC地址，如图4.21所示

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/990325a354dd6d4421e60646b9cd97567ed23139bd25859486d30625de05571f.jpg)
图4.21D类IP地址与以太网多播地址的映射关系

#### 地址映射示例与过滤
- IP多播地址224.128.64.32（即E0-80-40-20）和另一个IP多播地址224.0.64.32（即E0-00-40-20）转换成以太网的硬件多播地址都是01-00-5E-00-40-20
- 因为多播IP地址与以太网MAC地址的映射关系不是唯一的，thus收到多播数据报的主机，还要在IP层利用软件进行过滤，把不是本主机要接收的数据报丢弃

### IGMP与多播路由协议

#### IGMP概述
- 路由器要获得多播组的成员信息，需要利用网际组管理协议（InternetGroupManagementProtocol，IGMP)
- 连接到局域网上的多播路由器还必须和互联网上的其他多播路由器协同工作
  - 以便把多播数据报用最小代价传送给所有组成员
  - 这就需要使用多播路由选择协议

#### IGMP特点
- IGMP是让连接到本地局域网上的多播路由器，知道本局域网上是否有主机参加或退出了某个多播组
- IGMP并不是在互联网范围内对所有多播组成员进行管理的协议
- IGMP不知道：
  - IP多播组包含的成员数
  - 这些成员分布在哪些网络上

#### IGMP工作机制
- IGMP报文被封装在IP数据报中传送，但它也向IP提供服务
- thus不把IGMP视为一个单独的协议，而视为整个网际协议IP的一个组成部分
- IGMP的工作可分为两个阶段：
  ##### 第一阶段
  - 当某台主机加入新的多播组时：
    - 该主机应向多播组的多播地址发送一个IGMIP报文，声明自己要成为该组的成员
    - 本地的多播路由器收到IGIMP报文后，还要利用多播路由选择协议，把这种组成员关系转发给互联网上的其他多播路由器
  ##### 第二阶段
  - 组成员关系是动态的
  - 本地多播路由器要周期性地探询本地局域网上的主机，以便知道这些主机是否仍继续是组的成员
  - 只要对某个组有一台主机响应，多播路由器就认为这个组是活跃的
  - 但一个组在经过几次探询后仍然没有一台主机响应：
    - 多播路由器就认为本网络上的主机都已离开了这个组
    - thus就不再把这个组的成员关系转发给其他的多播路由器

#### 多播路由选择
- 多播路由选择实际上就是要找出以源主机为根结点的多播转发树
  - 其中每个分组在每条链路上只传送一次
  - 即在多播转发树上的路由器不会收到重复的多播数据报
- 不同的多播组对应于不同的多播转发树
- 同一个多播组，对不同的源点也会有不同的多播转发树

## <span style="color: DeepSkyBlue;">移动</span>IP

### 概念

- 指 
  - 移动站**以固定的IP地址**实现 <span style="color:green;">跨越</span> 不同网络的漫游功能，并保证基于IP的网络权限在漫游过程中**不发生任何改变**。
    - 目标：把分组自动地投递给移动站。
      - 一个移动站是把其连接点从一个网络或子网改变到另一个网络或子网的主机。

- 定义了**三种功能实体**：移动结点、本地代理（也称归属代理）和外地代理。
  - 1）移动结点
    - 具有永久IP地址的移动主机
  - 2）本地代理
    - 通常就是连接在归属网络（原始连接到的网络）上的路由器
  - 3）外地代理
    - 通常就是连接在被访网络（移动到另一地点所接入的网络）上的路由器

- 值得注意的是，某用户将笔记本关机后从家里带到办公室重新上网，在办公室能很方便地通过DHCP自动获取新的IP地址。
  - 虽然笔记本移动了，更换了地点及所接入的网络，但这并不是移动IP。
  - 但是，若我们需要在移动中进行TCP传输，则在移动站漫游时，应一直保持这个TCP连接，否则移动站的TCP连接就会断断续续。
  - 可见，若要使移动站在移动中的TCP连接不中断，就必须使笔记本的IP地址在移动中保持不变。
    - 这就是移动IP要研究的问题。


### 通信过程

#### 通俗例子
- 本科毕业时都将走向各自的工作岗位
  - 事先并不知道自己未来的准确通讯地址
  - 解决方案：彼此留下各自的家庭地址（即永久地址）
  - 毕业后若要和某同学联系
    - 只要写信寄到该同学的永久地址
    - 再请其家长把信件转交即可

#### 基本概念
- 每个移动站都有一个原始地址
  - 即永久地址（或归属地址）
  - 移动站原始连接的网络称为归属网络
  - 永久地址和归属网络的关联是不变的
- 在图4.22中
  - 移动站A的永久地址是131.8.6.7/16
  - 其归属网络是131.8.0.0/16
- 归属代理
  - 通常是连接到归属网络上的路由器
  - 代理功能是在应用层完成的
- 被访网络
  - 移动站移动到另一地点所接入的外地网络
  - 在图4.22中，移动站A被移动到被访网络15.0.0.0/8
- 外地代理
  - 通常是连接在被访网络上的路由器
  - 两个重要功能
    - 为移动站创建一个临时地址，称为转交地址
    - 及时把移动站的转交地址告诉其归属代理

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/4174d26dc508d9296f99faad8d6f94645b3e04daa497b46f1ac2b81540095c98.jpg)
图4.22移动IP的基本通信过程

> **attention:**

转交地址是供移动站、归属代理及外地代理使用的，各种应用程序都不会使用。外地代理要向连接在被访网络上的移动站发送IP分组时，直接使用移动站的MAC地址。

#### 基本通信流程
- 通信者B要和移动站A进行通信
  - B并不知道A在什么地方
  - B使用A的永久地址作为发送的IP分组中的目的地址
- 具体流程
  1. 移动站A在归属网络时，按传统的TCP/IP方式进行通信
  2. 移动站A漫游到被访网络时
     - 向外地代理进行登记，以获得一个临时的转交地址
     - 外地代理要向A的归属代理登记A的转交地址
  3. 归属代理知道移动站A的转交地址后
     - 会构建一条通向转交地址的隧道
     - 将截获的发送给A的IP分组进行再封装
     - 通过隧道发送给被访网络的外地代理
  4. 外地代理处理
     - 把收到的封装的IP分组进行拆封
     - 恢复成原始的IP分组
     - 发送给移动站A
  5. 移动站A在被访网络对外发送IP分组时
     - 仍然使用自己的永久地址作为IP分组的源地址
     - 无须通过A的归属代理来转发
     - 直接通过被访网络的外部代理
  6. 移动站A移动到另一被访网络时
     - 在新外地代理登记
     - 新外地代理将A的新转交地址告诉其归属代理
     - 无论如何移动，A收到的IP分组都是由归属代理转发的
  7. 移动站A回到归属网络时，A向归属代理注销转交地址

#### 新增网络层功能
- 移动站到外地代理的登记协议
- 外地代理到归属代理的登记协议
- 归属代理数据报封装协议
- 外地代理拆封协议
## 网络层设备

### 冲突域和广播域

>pro：各种中继设备对冲突域/广播域的划分（2010、2020）

"域"express 冲突or广播in which发生并传播的区域

#### 冲突域
- 连接到同一物理介质上的所有结点的集合，这些结点之间存在介质争用的现象。
- OSI参考模型中，冲突域被视为第1层的概念
  - 像集线器、中继器等简单无脑复制转发信号的第1层设备所连接的结点都属于同一个冲突域
  - 也就是说它们不能划分冲突域
  - 而第2层（网桥、交换机）、第3层（路由器）设备都可以划分冲突域

#### 广播域
- 广播域是指接收同样广播消息的结点集合
  - 也就是说，在该集合中的任何一个结点发送一个广播帧，其他能收到这个顿的结点都被认为是该广播域的一部分
- 在OSI参考模型中，广播域被视为第2层的概念
  - 像第1层（集线器等）、第2层（交换机等）设备所连接的结点都属于同一个广播域
  - 而路由器，作为第3层设备，则可以划分广播域，即可以连接不同的广播域
- 通常所说的局域网（LAN）特指使用路由器分割的网络，也就是广播域

### 路由器的组成和功能

>  pro：路由器的功能（2010）

#### 路由器基本概念
- 路由器是一种具有多个输入/输出端口的专用计算机
  - 其任务是连接不同的网络（连接异构网络）并完成分组转发
  - 在多个逻辑网络（即多个广播域）互连时必须使用路由器

#### 数据传输过程
- 当源主机向自标主机发送数据报时
  - 路由器先检查源主机与目标主机是否连接在同一个网络上
  - 若源主机和自标主机在同一个网络上，则直接交付而无须通过路由器
  - 若源主机和目标主机不在同一个网络上
    - 则路由器按照转发表（由路由表得出）指出的路由将分组转发给下一个路由器，这称为间接交付
- 在同一个网络中传递数据无须路由器的参与，而跨网络通信必须通过路由器进行转发
  - 例如，路由器可以连接不同的LAN，连接不同的VLAN，连接不同的WAN，或者把LAN和WAN互连起来
  - 路由器隔离了广播域

#### 路由器结构
- 从结构上看，路由器由路由选择和分组转发两部分构成，如图4.23所示
- 从模型的角度看，路由器是网络层设备，它实现了网络模型的下三层，即物理层、数据链路层和网络层

> **attention:**

若一个存储转发设备实现了某个层次的功能，则它可以互连两个在该层次上使用不同协议的网段（网络）。若网桥实现了物理层和数据链路层，则网桥可以互连两个物理层和数据链路层不同的网段；但中继器实现了物理层后，却不能互连两个物理层不同的网段，这是因为中继器不是存储转发设备，它属于直通式设备。

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/a6f3e8013ec6d6e4ad6b99d005103a7ca8fdd09388de0733bec78e66420e84ed.jpg)
图4.23路由器体系结构

##### 路由选择部分
- 也称控制部分，核心构件是路由选择处理机
- 其任务是
  - 根据所选定的路由选择协议构造出路由表
  - 同时经常或定期地和相邻路由器交换路由信息而不断更新和维护路由表

##### 分组转发部分
- 由三部分组成：
  - 交换结构
    - 也称交换组织
    - 其作用是根据转发表对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去
    - 交换结构本身就是一个"在路由器中的网络"
  - 一组输入端口
  - 一组输出端口
- 路由器的端口特点
  - 都有物理层、数据链路层和网络层的处理模块
  - 输入端口处理流程
    - 在物理层接收比特流
    - 在数据链路层提取出帧
    - 剥去帧的首部和尾部后，分组就被送入网络层的处理模块
  - 输出端口执行相反的操作
  - 端口在网络层的处理模块中都设有一个缓冲队列
    - 用来暂存等待处理或已处理完毕待发送的分组
    - 还可用来进行必要的差错检测
    - 若分组处理的速率赶不上分组进入队列的速率，就会使后面进入队列的分组因缓冲区满而只能被去弃
  - 路由器的端口一般都具有输入和输出的功能，图4.23中分别给出输入和输出端口是为了使读者更容易理解

### 路由表与分组转发

> **pro：根据网络拓扑并利用路由聚合构造出路由表（2009、2013）**

#### 路由表概述
- 路由表是根据路由选择算法得出的，主要用途是路由选择
- 标准的路由表有4个项目：
  - 目的网络IP地址
  - 子网掩码
  - 下一跳IP地址
  - 接口
- 在图4.24所示的网络拓扑中，R1的路由表见表4.7，该路由表包含到互联网的默认路由

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/7fb84369cd25807505af80fe6999595f7d65c3f98e6f1977a51f4f5dd572de68.jpg)图4.24一个简单的网络拓扑

> **pro：路由表转发分组的分析（2014）**

表4.7R1的路由表 ![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/83d0ea3113ec3f53e1fd3612ba918f4a07fa3bee9ffe976731a024849b2d0c8e.jpg)

#### 转发表特点
- 转发表是从路由表得出的
  - 其表项和路由表项有直接的对应关系
  - 但转发表的格式和路由表的格式不同，其结构应使查找过程最优化
- 转发表内容
  - 含有一个分组将要发往的目的地址
  - 以及分组的下一跳（即下一步接收者的目的地址，实际为MAC地址）
- 为了减少转发表的重复项目
  - 可以使用一个默认路由代替所有具有相同"下一跳"的项目
  - 并将默认路由设置得比其他项目的优先级低，如图4.25所示
- 实现方式
  - 路由表总是用软件来实现的
  - 转发表可以用软件来实现，甚至也可以用特殊的硬件来实现

![]`(https://cdn-mineru.openxlab.org.cn/model-mineru/prod/1454f74c2f1cf79b08cb4f8429965c256b8deb385876c24dc7e65a06f97f8c6a.jpg)
图4.25未使用默认路由的转发表和使用了默认路由的转发表的对比

#### 转发与路由选择的区别
- "转发"特点
  - 是路由器根据转发表把收到的IP数据报从合适的端口转发出去
  - 它仅涉及一个路由器
- "路由选择"特点
  - 涉及很多路由器
  - 路由表是许多路由器协同工作的结果
  - 这些路由器按照复杂的路由算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由，并由此构造出整个路由表
- 路由表不等于转发表，分组的实际转发是靠直接查找转发表，而不是查找路由表

## 本章小结及疑难点

1.“尽最大努力交付”有哪些含义？

1）不保证源主机发送的IP数据报一定无差错地交付到目的主机。

2）不保证源主机发送的IP数据报都在某一规定的时间内交付到目的主机。

3）不保证源主机发送的IP数据报一定按发送时的顺序交付到目的主机。

4）不保证源主机发送的IP数据报不会重复交付给目的主机。

5）不敌意丢弃IP数据报。丢弃IP数据报的情况是：路由器检测出首部检验和有错误；或者因为网络中通信量过大，路由器或目的主机中的缓存已无空闲空间。

但要注意，IP数据报的首部中有一个“首部检验和”字段。当它检验出IP数据报的首部出现了差错时，就丢弃该数据报。thus，凡交付给目的主机的IP数据报都是IP首部没有差错的或没有检测出差错的。也就是说，在传输过程中，出现差错的IP数据报都被丢弃了。

现在互联网上绝大多数的通信量都属于“尽最大努力交付”。若数据必须可靠地交付给目的地，则使用IP的高层软件必须负责解决这一问题。

2.假定在一个局域网中，计算机A广播一个ARP请求分组，希望找出计算机B的硬件地址。试问这时由哪个计算机发送ARP响应分组？将谁的硬件地址告诉计算机A？

这要区分两种情况。第一，若计算机B和计算机A都连接在同一个局域网上，则计算机B发送ARP响应分组，给出计算机B的硬件地址。第二，若计算机B和计算机A不连接在同一个局域网上，则必须由一个连接计算机A所在局域网的路由器来响应，这时该路由器向计算机A发送ARP响应分组，给出该路由器的硬件地址。
3. 在数据报的HEADER中只有源IP地址和目的IP地址
      - 没有中间经过的路由器的IP地址，未指明下一跳路由器的IP地址
      - 待转发的数据报怎样才能找到下一跳路由器呢？

- 路由器收到 待转发DG后的**处理流程**：
  - through路由表得出下一跳路由器的**IP地址**
  - 不把这个地址填入数据报
    - 而是 **送交**数据链路层的**网络接口软件**
    - 网络接口软件的处理：
      - 把下一跳路由器的IP地址转换成硬件地址(使用ARP)
      - 将此硬件地址写入MAC帧的首部
      - 根据此硬件地址找到下一跳路由器
  - 发送连续数据报时会重复以上过程，造成一定开销

- why不在路由表中**直接使用** **硬件地址**：
  - 使用抽象的IP地址 → 隐蔽各种底层网络的复杂性
    - 便于分析和研究问题  
    - cost：  
      - 选择路由时 开销↑
  - 直接使用MAC地址的问题：
    - 硬件地址是平面的
      - 导致路由表极为庞大
      - troublesome

4."路由器实现了物理层、数据链路层、网络层" 的含义？

- **两个通信结点**利用协议栈进行**通信的过程**
  - 发送方一层一层地把数据“包装”
  - 接收方一层一层地把“包装”拆开，最后上交给用户。

- **路由器**有能力对这三层协议的控制信息进行识别、分析以及转换。
  - 直观的理解是路由器**有能力**对数据“包装”这三层协议or“拆开”这三层协议。
    - thus 路由器就有能力互连这三层协议不同的两个网络


[^1]`: remote controller
